<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion de Projet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.dhtmlx.com/gantt/8.0/dhtmlxgantt.js"></script>
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/8.0/dhtmlxgantt.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
    }
    .sidebar {
      width: 380px;
      min-width: 380px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      transition: min-width 0.35s ease, width 0.35s ease, padding 0.35s ease, opacity 0.35s ease;
    }
    .sidebar.collapsed {
        width: 0;
        min-width: 0;
        padding-left: 0;
        padding-right: 0;
        opacity: 0;
    }
    .main {
      flex-grow: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      transition: padding 0.35s ease;
    }
    .gantt-container {
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 10px;
      height: 100%;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      display: flex;
      flex-direction: column;
    }
    .notification-stack {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1055;
    }
    .notification {
      position: relative;
      padding: 15px 40px 15px 25px;
      border-radius: 50px;
      color: white;
      background: linear-gradient(45deg, #56ab2f, #a8e6cf);
      animation: slideIn 0.5s ease forwards;
    }
    .notification.error {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
    }
    .notification.warning {
        background: linear-gradient(45deg, #ff9966, #ff8c42);
    }
    .notification .close-btn {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        font-size: 20px;
        font-weight: bold;
        color: white;
        cursor: pointer;
        line-height: 1;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .btn, .form-control, .form-select, .card, .accordion-button, .modal-content {
      border-radius: 15px;
    }
    #gantt_here {
      width: 100%;
      height: 100%;
      border-radius: 15px;
      flex-grow: 1;
    }
    .task-item {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 4px solid transparent;
      transition: all 0.3s ease;
    }
     .member-item {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 5px;
    }
    .member-info {
        flex-grow: 1;
    }
    .overload-dropdown {
        flex-basis: 100%;
        margin-top: 5px;
    }
    .member-indicator {
      width: 16px;
      height: 16px;
      display: inline-block;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .gantt_task_line {
      border-radius: 4px;
      border: 1px solid;
    }
    .gantt_task_line.task-locked {
        opacity: 0.6;
        border-style: dashed;
    }
    /* Styles pour le surlignage de surcharge */
    .gantt_row.overload-highlight-warning, .gantt_task_line.overload-highlight-warning {
        background-color: #FFA500 !important; /* Orange Vif */
    }
    .gantt_row.overload-highlight-error, .gantt_task_line.overload-highlight-error {
        background-color: #FF0000 !important; /* Rouge Vif */
    }
    .gantt_row.overload-highlight-warning .gantt_cell,
    .gantt_row.overload-highlight-error .gantt_cell {
        color: white !important;
        font-weight: bold;
    }
    .gantt_task_progress {
      border-radius: 4px;
      opacity: 1;
    }
    .gantt_task_content {
      color: #333;
    }
    .gantt_task_cell.weekend {
      background-color: #f0f0f0 !important;
    }
    .gantt_grid_cell_lock {
        text-align: center;
        cursor: pointer;
    }
    .gantt-controls {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 10px;
      flex-shrink: 0;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      gap: 8px;
    }
    .gantt-controls .btn {
      white-space: nowrap;
      margin-right: 0px !important;
    }
    .gantt_grid_data .gantt_cell[role=gridcell][data-column-name=members] {
      cursor: pointer;
    }
    .gantt_grid_data .gantt_cell[role=gridcell][data-column-name=members]:hover {
      background-color: #e9ecef;
    }
    .gantt_grid_resizer {
        position: absolute;
        top: 0;
        right: -1px;
        width: 5px;
        height: 100%;
        cursor: col-resize !important;
        z-index: 10;
        background-color: transparent;
        transition: background-color 0.2s;
    }
    .gantt_grid_resizer:hover {
        background-color: rgba(0, 123, 255, 0.5);
    }
    .priority-low { background-color: #d4edda !important; }
    .priority-medium { background-color: #fff3cd !important; }
    .priority-high { background-color: #f8d7da !important; }
    .language-selector { margin-bottom: 10px; text-align: center; }
    .language-selector button { margin: 0 3px; padding: 5px 8px; font-size: 0.9em; }
    .sidebar-content { flex-grow: 1; overflow-y: auto; }
    .custom-lightbox-members-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        padding: 10px;
        border-radius: 0.375rem;
        background-color: #fff;
    }
    .mb-3 { margin-bottom: 0.75rem !important; }
    .mb-2 { margin-bottom: 0.4rem !important; }
    #summaryTaskNote {
        font-size: 0.85em;
        color: #6c757d;
        margin-top: 5px;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="language-selector">
      <button class="btn btn-sm btn-light" onclick="setLanguage('fr')">FR</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('en')">EN</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('es')">ES</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('de')">DE</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('it')">IT</button>
    </div>
    <div class="mb-3">
      <button class="btn btn-primary w-100 mb-2" onclick="exportToJSON()" data-translate-key="export">üíæ Exporter</button>
      <input type="file" id="importJSON" name="importJSON" accept=".json" style="display: none;" onchange="importFromJSON(event)">
      <button class="btn btn-secondary w-100 mb-2" onclick="document.getElementById('importJSON').click()" data-translate-key="import">üìÇ Importer</button>
      <button class="btn btn-danger w-100 mb-2" onclick="confirmClearAllData()" data-translate-key="clear_all_data_btn">üóëÔ∏è Vider tout</button>
    </div>
    <div class="sidebar-content">
      <div class="accordion" id="sidebarAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#membersCollapse" data-translate-key="members_section_title">
              üë• Membres
            </button>
          </h2>
          <div id="membersCollapse" class="accordion-collapse collapse show" data-bs-parent="#sidebarAccordion">
            <div class="accordion-body">
              <input id="editMemberId" name="editMemberId" type="hidden" value="">
              <label for="memberName"></label><input id="memberName" name="memberName" class="form-control mb-2" data-translate-placeholder-key="member_name_placeholder">
              <label for="memberColor"></label><input type="color" id="memberColor" name="memberColor" class="form-control mb-2" value="#667eea">
              <button id="memberActionBtn" class="btn btn-primary w-100" onclick="addOrUpdateMember()" data-translate-key="add_member_btn">Ajouter Membre</button>
              <div id="membersList" class="mt-3"></div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#projectCollapse" data-translate-key="projects_section_title">
              üìÅ Projets
            </button>
          </h2>
          <div id="projectCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
            <div class="accordion-body">
              <label for="projectName"></label><input id="projectName" name="projectName" class="form-control mb-2" data-translate-placeholder-key="project_name_placeholder">
              <label for="projectDescription"></label><textarea id="projectDescription" name="projectDescription" class="form-control mb-2" data-translate-placeholder-key="project_description_placeholder" rows="2"></textarea>
              <label for="projectDeadline"></label><input type="text" id="projectDeadline" name="projectDeadline" class="form-control mb-2">
              <label for="projectPriority"></label><select id="projectPriority" name="projectPriority" class="form-select mb-2">
                <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
              </select>
              <label for="projectColor"></label><input type="color" id="projectColor" name="projectColor" class="form-control mb-2" value="#28a745">
              <button class="btn btn-success w-100" onclick="addProject()" data-translate-key="create_project_btn">Cr√©er Projet</button>
              <div id="projectList"></div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#taskCollapse" data-translate-key="new_task_section_title">
              ‚úÖ Nouvelle T√¢che
            </button>
          </h2>
          <div id="taskCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
            <div class="accordion-body">
              <div class="mb-3">
                  <label for="taskType" class="form-label" data-translate-key="task_type_label">Type de t√¢che</label>
                  <select id="taskType" name="taskType" class="form-select mb-2" onchange="toggleNewTaskFieldsVisibility()">
                      <option value="task" data-translate-key="task_type_normal">T√¢che normale</option>
                      <option value="project" data-translate-key="task_type_mother">T√¢che m√®re (Nouveau Groupe)</option>
                  </select>
                  <p id="summaryTaskNote" style="display: none;" data-translate-key="mother_task_creation_note"></p>
              </div>

              <label for="taskName"></label><input id="taskName" name="taskName" class="form-control mb-2" data-translate-placeholder-key="task_name_placeholder">
              
              <div class="mb-3">
                <label for="taskProject" class="form-label" data-translate-key="task_parent">Parent de la t√¢che</label>
                <select id="taskProject" name="taskProject" class="form-select">
                  <option value="" data-translate-key="select_project_option">S√©lectionner un projet</option>
                </select>
              </div>

              <div id="normalTaskFields">
                  <label for="taskStart"></label><input type="text" id="taskStart" name="taskStart" class="form-control mb-2" data-translate-placeholder-key="task_start_placeholder">
                  <label for="taskEnd"></label><input type="text" id="taskEnd" name="taskEnd" class="form-control mb-2" data-translate-placeholder-key="task_end_placeholder">
                  <label for="taskDuration"></label><input type="number" id="taskDuration" name="taskDuration" class="form-control mb-2" data-translate-placeholder-key="task_duration_placeholder">
                  <label for="taskProgress"></label><select id="taskProgress" name="taskProgress" class="form-select mb-2">
                    <option value="0">0%</option> <option value="0.1">10%</option> <option value="0.25">25%</option>
                    <option value="0.5">50%</option> <option value="0.75">75%</option> <option value="0.9">90%</option>
                    <option value="1">100%</option>
                  </select>
                  <label for="taskPriority"></label><select id="taskPriority" name="taskPriority" class="form-select mb-2">
                    <option value="project" data-translate-key="task_priority_project">Par d√©faut (Projet)</option>
                    <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                    <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                    <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
                  </select>
                  <label class="form-label" data-translate-key="assigned_members_label">Membres assign√©s :</label>
                  <div id="taskMembers" class="mb-2" style="max-height: 120px; overflow-y: auto; border: 1px solid #e9ecef; padding: 10px; border-radius: 10px;"></div>
              </div>
              <div id="summaryTaskFields" style="display: none;">
              </div>

              <button class="btn btn-warning w-100" onclick="addTask()" data-translate-key="add_task_btn">Ajouter T√¢che</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="gantt-container">
      <div class="gantt-controls">
        <button id="toggleSidebarBtn" class="btn btn-outline-secondary" onclick="toggleSidebar()"></button>
        <button id="toggleGridBtn" class="btn btn-outline-info" onclick="toggleGanttGrid()"></button>
        <button class="btn btn-outline-primary" onclick="ganttZoomIn()">üîç+</button>
        <button class="btn btn-outline-primary" onclick="ganttZoomOut()">üîç-</button>
        <button class="btn btn-outline-info" onclick="manualRecalculate()" data-translate-key="recalculate_btn">üîÑ Recalculer</button>
        <button class="btn btn-outline-success" onclick="exportGanttToPNG()" data-translate-key="export_png_btn">üñºÔ∏è PNG</button>
        <button class="btn btn-outline-warning" onclick="undoLastAction()" data-translate-key="undo_btn" id="undoButton" disabled>‚Ü© Annuler</button>
      </div>
      <div id="gantt_here"></div>
    </div>
  </div>

  <div class="modal fade" id="editTaskMembersModal" tabindex="-1" aria-labelledby="editTaskMembersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTaskMembersModalLabel" data-translate-key="manage_task_members_modal_title_prefix">G√©rer les membres de la t√¢che</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editTaskId" name="editTaskId">
          <label class="form-label" data-translate-key="assigned_members_label">Membres assign√©s :</label>
          <div id="editTaskMembersList" class="mb-2" style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; padding: 10px; border-radius: 10px;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close"></button>
          <button type="button" class="btn btn-primary" onclick="saveTaskMembers()" data-translate-key="save_btn">Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customTaskModal" tabindex="-1" aria-labelledby="customTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customTaskModalLabel" data-translate-key="custom_lightbox_title">Modifier la T√¢che</h5>
          <button type="button" class="btn-close" onclick="closeCustomLightbox()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="customLightboxTaskId" name="customLightboxTaskId">
          <div class="mb-3">
            <label for="customLightboxTaskName" class="form-label" data-translate-key="custom_lightbox_task_name_label">Nom</label>
            <input type="text" class="form-control" id="customLightboxTaskName" name="customLightboxTaskName" data-translate-placeholder-key="task_name_placeholder">
          </div>

          <div class="mb-3">
              <label for="customLightboxTaskType" class="form-label" data-translate-key="task_type_label">Type</label>
              <select id="customLightboxTaskType" name="customLightboxTaskType" class="form-select mb-2" onchange="toggleCustomLightboxFieldsVisibility()">
                  <option value="task" data-translate-key="task_type_normal">T√¢che normale</option>
                  <option value="project" data-translate-key="task_type_mother">T√¢che m√®re (Groupe)</option>
              </select>
          </div>

          <div class="mb-3">
              <label for="customLightboxTaskParent" class="form-label" data-translate-key="task_parent">Parent</label>
              <select class="form-select" id="customLightboxTaskParent">
                <option value="" data-translate-key="no_parent">Pas de parent</option>
              </select>
          </div>
          
          <div id="customLightboxProjectFields" style="display: none;">
              <div class="mb-3">
                  <label for="customLightboxProjectDescription" class="form-label" data-translate-key="project_description_placeholder">Description</label>
                  <textarea class="form-control" id="customLightboxProjectDescription" rows="2"></textarea>
              </div>
              <div class="row">
                  <div class="col-md-6 mb-3">
                      <label for="customLightboxProjectDeadline" class="form-label" data-translate-key="project_deadline_label">√âch√©ance</label>
                      <input type="text" class="form-control" id="customLightboxProjectDeadline">
                  </div>
                  <div class="col-md-6 mb-3">
                      <label for="customLightboxProjectColor" class="form-label" data-translate-key="custom_lightbox_task_color_label">Couleur</label>
                      <input type="color" class="form-control form-control-color w-100" id="customLightboxProjectColor" value="#667eea">
                  </div>
              </div>
              <div class="mb-3">
                  <label for="customLightboxProjectPriority" class="form-label" data-translate-key="custom_lightbox_task_priority_label">Priorit√©</label>
                  <select id="customLightboxProjectPriority" class="form-select">
                      <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                      <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                      <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
                  </select>
              </div>
          </div>

          <div id="customLightboxNormalTaskFields">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="customLightboxTaskPriority" class="form-label" data-translate-key="custom_lightbox_task_priority_label">Priorit√©</label>
                  <select id="customLightboxTaskPriority" name="customLightboxTaskPriority" class="form-select">
                    <option value="project" data-translate-key="task_priority_project">Par d√©faut (Projet)</option>
                    <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                    <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                    <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="customLightboxTaskProgress" class="form-label" data-translate-key="custom_lightbox_task_progress_label">Avancement</label>
                  <select id="customLightboxTaskProgress" name="customLightboxTaskProgress" class="form-select">
                    <option value="0">0%</option>
                    <option value="0.1">10%</option>
                    <option value="0.2">20%</option>
                    <option value="0.25">25%</option>
                    <option value="0.3">30%</option>
                    <option value="0.4">40%</option>
                    <option value="0.5">50%</option>
                    <option value="0.6">60%</option>
                    <option value="0.7">70%</option>
                    <option value="0.75">75%</option>
                    <option value="0.8">80%</option>
                    <option value="0.9">90%</option>
                    <option value="1">100%</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="customLightboxTaskStart" class="form-label" data-translate-key="custom_lightbox_task_start_label">Date de d√©but</label>
                  <input type="text" class="form-control" id="customLightboxTaskStart" name="customLightboxTaskStart">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="customLightboxTaskEnd" class="form-label" data-translate-key="custom_lightbox_task_end_label">Date de fin</label>
                  <input type="text" class="form-control" id="customLightboxTaskEnd" name="customLightboxTaskEnd">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="customLightboxTaskDuration" class="form-label" data-translate-key="custom_lightbox_task_duration_label">Dur√©e (jours)</label>
                  <input type="number" class="form-control" id="customLightboxTaskDuration" name="customLightboxTaskDuration" min="0" data-translate-placeholder-key="task_duration_placeholder">
                </div>
              </div>

              <div class="mb-3">
                <label for="customLightboxTaskColor" class="form-label" data-translate-key="custom_lightbox_task_color_label">Couleur de la t√¢che</label>
                <input type="color" class="form-control form-control-color" id="customLightboxTaskColor" name="customLightboxTaskColor" value="#5cb85c">
              </div>

              <div class="mb-3">
                <label class="form-label" data-translate-key="assigned_members_label">Membres assign√©s :</label>
                <div id="customLightboxTaskMembers" class="custom-lightbox-members-list"></div>
              </div>

              <div class="mb-3">
                <label for="customLightboxTaskComments" class="form-label" data-translate-key="custom_lightbox_task_comments_label">Commentaires</label>
                <textarea class="form-control" id="customLightboxTaskComments" name="customLightboxTaskComments" rows="3" data-translate-placeholder-key="task_comments_placeholder"></textarea>
              </div>
          </div>
          <div id="customLightboxSummaryTaskFields" style="display: none;">
              <p class="text-muted" data-translate-key="mother_task_note"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger me-auto" onclick="deleteTaskFromCustomLightbox()" data-translate-key="delete_btn">Supprimer</button>
          <button type="button" class="btn btn-secondary" onclick="closeCustomLightbox()" data-translate-key="cancel_btn">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveCustomLightboxChanges()" data-translate-key="save_btn">Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/de.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/it.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.xml_date = "%Y-%m-%d";
        initGantt();
        document.getElementById('customLightboxTaskDuration').addEventListener('input', function() {
            updateLightboxSchedule('duration');
        });
        initDummyData();
        saveStateToHistory();
        setLanguage(currentLang);
        updateGantt();
    });

    let members = [];
    let projects = {};
    let allLinks = [];
    let currentLang = 'fr';
    let customTaskModalInstance = null;
    let currentEditingTaskId = null;
    let elementToFocusOnModalClose = null;
    let datePickers = [];
    let isSidebarCollapsed = false;
    let isGridVisible = true;
    let isUpdatingGanttProgrammatically = false;
    let memberWorkload = {}; // Pour stocker la charge de travail par membre et par jour
    let highlightedInfo = { taskIds: [], level: '' };
    let projectNameToEdit = null;

    const historyStack = [];
    const MAX_HISTORY_SIZE = 10;

    const zoomLevels = [
        { name: "day", scale_unit: "day", date_scale: "%d %M", subscales: [{ unit: "hour", step: 6, date: "%Hh" }], min_column_width: 30 },
        { name: "week", scale_unit: "week", date_scale: "Semaine #%W", subscales: [{ unit: "day", step: 1, date: "%D %d", css: weekendCss }], min_column_width: 70 },
        { name: "month", scale_unit: "month", date_scale: "%F %Y", subscales: [{ unit: "week", step: 1, date: "Sem #%W" }], min_column_width: 90 },
        { 
            name: "quarter", 
            scale_unit: "quarter", 
            template: function(date) {
                return `${date.getFullYear()}, T${Math.ceil((date.getMonth() + 1) / 3)}`;
            },
            subscales: [{ unit: "month", step: 1, date: "%M" }],
            min_column_width: 90 
        },
        { 
            name: "year", 
            scale_unit: "year", 
            date_scale: "%Y", 
            subscales: [{ 
                unit: "quarter", 
                step: 1, 
                template: function(date) {
                    return "T" + Math.ceil((date.getMonth() + 1) / 3);
                }
            }],
            min_column_width: 50 
        }
    ];
    let currentZoomLevelIndex = 2;

    function applyZoom(levelIndex) {
        if (levelIndex >= 0 && levelIndex < zoomLevels.length) {
            currentZoomLevelIndex = levelIndex;
            const newZoom = zoomLevels[currentZoomLevelIndex];
            gantt.config.scale_unit = newZoom.scale_unit;
            if (newZoom.template) {
                gantt.config.date_scale = null;
                gantt.templates.date_scale = newZoom.template;
            } else {
                gantt.config.date_scale = newZoom.date_scale;
                gantt.templates.date_scale = null; // Reset to default
            }
            gantt.config.subscales = newZoom.subscales;
            gantt.config.min_column_width = newZoom.min_column_width;
            gantt.render();
        }
    }

    function ganttZoomIn() {
        if (currentZoomLevelIndex > 0) {
            applyZoom(currentZoomLevelIndex - 1);
        }
    }

    function ganttZoomOut() {
        if (currentZoomLevelIndex < zoomLevels.length - 1) {
            applyZoom(currentZoomLevelIndex + 1);
        }
    }

    const translations = {
    fr: {
        export: "üíæ Exporter", import: "üìÇ Importer", clear_all_data_btn: "üóëÔ∏è Vider tout",
        clear_all_data_confirm: "√ätes-vous s√ªr de vouloir vider TOUTES les donn√©es (membres, projets, t√¢ches, liens) ? Cette action est irr√©versible.",
        clear_all_data_confirm_project: "√ätes-vous s√ªr de vouloir supprimer le projet '{name}' et toutes ses t√¢ches ? Cette action est irr√©versible.",
        notification_all_data_cleared: "‚úÖ Toutes les donn√©es ont √©t√© effac√©es.", members_section_title: "üë• Membres",
        member_name_placeholder: "Nom du membre", add_member_btn: "Ajouter Membre", edit_member_btn: "Modifier Membre",
        projects_section_title: "üìÅ Projets", project_name_placeholder: "Nom du projet", project_description_placeholder: "Description",
        project_deadline_label: "√âch√©ance",
        priority_low: "üü¢ Basse", priority_medium: "üü° Moyenne", priority_high: "üî¥ Haute", create_project_btn: "Cr√©er Projet",
        new_task_section_title: "‚úÖ Nouvelle T√¢che", select_project_option: "S√©lectionner un projet", task_parent: "Parent de la t√¢che",
        no_parent: "Pas de parent", task_name_placeholder: "Nom de la t√¢che", task_end_placeholder: "Date de fin",
        task_duration_placeholder: "Dur√©e (jours ouvr√©s)", assigned_members_label: "Membres assign√©s :", add_task_btn: "Ajouter T√¢che",
        recalculate_btn: "üîÑ Recalculer", export_png_btn: "üñºÔ∏è PNG", undo_btn: "‚Ü© Annuler", hide_names_btn: "Masquer les noms",
        show_names_btn: "Afficher les noms", hide_sidebar_btn: "Masquer le menu", show_sidebar_btn: "Montrer le menu",
        toggle_overload_on: "Masquer Surcharges", toggle_overload_off: "Afficher Surcharges",
        edit_project_modal_title: "Modifier Projet", cancel_btn: "Annuler", save_btn: "Enregistrer", delete_btn: "Supprimer",
        manage_task_members_modal_title_prefix: "G√©rer les membres de la t√¢che", notification_export_success: "‚úÖ Donn√©es export√©es en JSON.",
        notification_import_success: "‚úÖ Donn√©es import√©es avec succ√®s.", notification_import_error: "‚ö†Ô∏è Erreur importation: ",
        notification_invalid_json_format: "Format JSON invalide ou donn√©es/compteurs manquants.", notification_member_added: "‚úÖ Membre {name} ajout√©.",
        notification_member_edited: "‚úÖ Membre {name} modifi√©.", notification_member_exists: "‚ö†Ô∏è Ce membre existe d√©j√†.",
        notification_enter_name: "‚ö†Ô∏è Entrez un nom.", notification_member_removed: "‚ùå Membre {name} supprim√©.",
        notification_visibility_updated: "‚úÖ Visibilit√© de {name} mise √† jour.", notification_no_members: "<small class=\"text-muted\">Aucun membre</small>",
        notification_project_name_required: "‚ö†Ô∏è Nom de projet requis.", notification_project_exists: "‚ö†Ô∏è Ce nom de projet existe d√©j√†.",
        notification_project_created: "üéâ Projet {name} cr√©√© avec t√¢ches par d√©faut.", notification_project_edited: "‚úÖ Projet {name} modifi√©.",
        notification_project_removed: "‚ùå Projet {name} supprim√©.", notification_fill_all_fields: "‚ö†Ô∏è Remplissez tous les champs (nom, d√©but, dur√©e > 0).",
        notification_invalid_project: "‚ö†Ô∏è Projet s√©lectionn√© invalide.", notification_task_added: "‚úÖ T√¢che {name} ajout√©e.",
        notification_task_members_updated: "‚úÖ Membres de la t√¢che {name} mis √† jour.", notification_task_updated: "‚úÖ T√¢che {name} mise √† jour.",
        notification_project_and_tasks_updated: "‚úÖ Projet {name} et ses t√¢ches mises √† jour.", notification_link_added: "üîó Lien ajout√©.",
        notification_link_removed: "‚ùå Lien supprim√©.", notification_task_deleted: "üóëÔ∏è T√¢che {name} supprim√©e.",
        notification_recalculated: "üîÑ Planning recalcul√© selon les d√©pendances", notification_recalculation_error: "‚ö†Ô∏è Erreur lors du recalcul",
        notification_png_exported: "üñºÔ∏è Diagramme export√© en PNG.", notification_no_tasks_to_export: "Aucune t√¢che √† exporter.",
        notification_invalid_date_format: "‚ö†Ô∏è Format de date invalide fourni.", notification_date_parse_error: "‚ö†Ô∏è Erreur lors de l'analyse de la date.",
        notification_task_reordered: "‚úÖ Ordre de la t√¢che {name} mis √† jour.", notification_drag_parent_restricted: "‚ö†Ô∏è Les t√¢ches ne peuvent √™tre d√©plac√©es que dans des projets ou devenir des t√¢ches de niveau sup√©rieur.",
        gantt_col_task: "T√¢che", gantt_col_start_date: "D√©but", gantt_col_end_date: "Fin", gantt_col_duration: "Dur√©e (j)",
        gantt_col_progress: "Avancement", gantt_col_members: "Membres", gantt_col_no_members: "Aucun", custom_lightbox_title: "Modifier la T√¢che/Projet",
        custom_lightbox_task_name_label: "Nom", custom_lightbox_task_priority_label: "Priorit√©", custom_lightbox_task_progress_label: "Avancement",
        custom_lightbox_task_start_label: "Date de d√©but", custom_lightbox_task_end_label: "Date de fin", custom_lightbox_task_duration_label: "Dur√©e (jours)",
        custom_lightbox_task_comments_label: "Commentaires", custom_lightbox_task_color_label: "Couleur", task_comments_placeholder: "Ajouter un commentaire...",
        task_priority_project: "Par d√©faut (Projet)", default_task_cahier_des_charges: "R√©alisation du cahier des charges ({projectName})",
        default_task_conception_pedagogique: "Conception p√©dagogique ({projectName})", default_task_production_contenus: "Production de contenus ({projectName})",
        default_task_developpement_interactif: "D√©veloppement interactif ({projectName})", default_task_tests_validation: "Tests et validation ({projectName})",
        gantt_week_prefix: "Sem.", task_start_placeholder: "Date de d√©but", task_type_label: "Type", task_type_normal: "T√¢che normale",
        task_type_mother: "T√¢che m√®re (Groupe)", mother_task_note: "Les d√©tails d'une t√¢che m√®re/projet sont calcul√©s √† partir de ses sous-t√¢ches. Vous pouvez modifier ses propri√©t√©s sp√©cifiques ici.",
        mother_task_creation_note: "Une t√¢che m√®re sert √† regrouper d'autres t√¢ches. Si elle est de niveau sup√©rieur, elle fonctionne comme un projet. Ses d√©tails (date de d√©but, fin, dur√©e, avancement, membres) seront calcul√©s automatiquement ou h√©rit√©s de ses sous-t√¢ches une fois celles-ci ajout√©es. Pour modifier les propri√©t√©s sp√©cifiques d'un projet de niveau sup√©rieur (couleur, priorit√†, description), utilisez la section \"Projets\" apr√®s sa cr√©ation.",
        validation_mother_task_parent_required: "‚ö†Ô∏è Une t√¢che m√®re doit avoir un projet ou une autre t√¢che m√®re comme parent."
    },
    en: {
        export: "üíæ Export", import: "üìÇ Import", clear_all_data_btn: "üóëÔ∏è Clear All",
        clear_all_data_confirm: "Are you sure you want to clear ALL data (members, projects, tasks, links)? This action is irreversible.",
        clear_all_data_confirm_project: "Are you sure you want to delete project '{name}' and all its tasks? This action is irreversible.",
        notification_all_data_cleared: "‚úÖ All data has been cleared.", members_section_title: "üë• Members",
        member_name_placeholder: "Member name", add_member_btn: "Add Member", edit_member_btn: "Edit Member",
        projects_section_title: "üìÅ Projects", project_name_placeholder: "Project name", project_description_placeholder: "Description",
        project_deadline_label: "Deadline",
        priority_low: "üü¢ Low", priority_medium: "üü° Medium", priority_high: "üî¥ High", create_project_btn: "Create Project",
        new_task_section_title: "‚úÖ New Task", select_project_option: "Select a project", task_parent: "Task parent",
        no_parent: "No parent", task_name_placeholder: "Task name", task_end_placeholder: "End date",
        task_duration_placeholder: "Duration (workdays)", assigned_members_label: "Assigned members:", add_task_btn: "Add Task",
        recalculate_btn: "üîÑ Recalculate", export_png_btn: "üñºÔ∏è PNG", undo_btn: "‚Ü© Undo", hide_names_btn: "Hide Names",
        show_names_btn: "Show Names", hide_sidebar_btn: "Hide menu", show_sidebar_btn: "Show menu",
        toggle_overload_on: "Hide Overload", toggle_overload_off: "Show Overload",
        edit_project_modal_title: "Edit Project", cancel_btn: "Cancel", save_btn: "Save", delete_btn: "Delete",
        manage_task_members_modal_title_prefix: "Manage task members", notification_export_success: "‚úÖ Data exported to JSON.",
        notification_import_success: "‚úÖ Data imported successfully.", notification_import_error: "‚ö†Ô∏è Import error: ",
        notification_invalid_json_format: "Invalid JSON format or missing data/counters.", notification_member_added: "‚úÖ Member {name} added.",
        notification_member_edited: "‚úÖ Member {name} updated.", notification_member_exists: "‚ö†Ô∏è This member already exists.",
        notification_enter_name: "‚ö†Ô∏è Enter a name.", notification_member_removed: "‚ùå Member {name} removed.",
        notification_visibility_updated: "‚úÖ Visibility of {name} updated.", notification_no_members: "<small class=\"text-muted\">No members</small>",
        notification_project_name_required: "‚ö†Ô∏è Project name required.", notification_project_exists: "‚ö†Ô∏è This project name already exists.",
        notification_project_created: "üéâ Project {name} created with default tasks.", notification_project_edited: "‚úÖ Project {name} updated.",
        notification_project_removed: "‚ùå Project {name} removed.", notification_fill_all_fields: "‚ö†Ô∏è Fill all fields (name, start, duration > 0).",
        notification_invalid_project: "‚ö†Ô∏è Invalid project selected.", notification_task_added: "‚úÖ Task {name} added.",
        notification_task_members_updated: "‚úÖ Task {name} members updated.", notification_task_updated: "‚úÖ Task {name} updated.",
        notification_project_and_tasks_updated: "‚úÖ Projet {name} et ses t√¢ches mises √† jour.", notification_link_added: "üîó Link added.",
        notification_link_removed: "‚ùå Link removed.", notification_task_deleted: "üóëÔ∏è Task {name} deleted.",
        notification_recalculated: "üîÑ Schedule recalculated based on dependencies", notification_recalculation_error: "‚ö†Ô∏è Error during recalculation",
        notification_png_exported: "üñºÔ∏è Chart exported to PNG.", notification_no_tasks_to_export: "No tasks to export.",
        notification_invalid_date_format: "‚ö†Ô∏è Invalid date format provided.", notification_date_parse_error: "‚ö†Ô∏è Error parsing date.",
        notification_task_reordered: "‚úÖ Task {name} order updated.", notification_drag_parent_restricted: "‚ö†Ô∏è Tasks can only be moved within projects or become top-level tasks.",
        gantt_col_task: "Task", gantt_col_start_date: "Start", gantt_col_end_date: "End", gantt_col_duration: "Duration (d)",
        gantt_col_progress: "Progress", gantt_col_members: "Members", gantt_col_no_members: "None", custom_lightbox_title: "Edit Task/Project",
        custom_lightbox_task_name_label: "Name", custom_lightbox_task_priority_label: "Priority", custom_lightbox_task_progress_label: "Progress",
        custom_lightbox_task_start_label: "Start date", custom_lightbox_task_end_label: "End date", custom_lightbox_task_duration_label: "Duration (days)",
        custom_lightbox_task_comments_label: "Comments", custom_lightbox_task_color_label: "Color", task_comments_placeholder: "Add a comment...",
        task_priority_project: "Default (Project)", default_task_cahier_des_charges: "Specifications ({projectName})",
        default_task_conception_pedagogique: "Instructional Design ({projectName})", default_task_production_contenus: "Content Production ({projectName})",
        default_task_developpement_interactif: "Interactive Development ({projectName})", default_task_tests_validation: "Testing and Validation ({projectName})",
        gantt_week_prefix: "W", task_start_placeholder: "Start date", task_type_label: "Type", task_type_normal: "Normal task",
        task_type_mother: "Mother Task (Group)", mother_task_note: "Details for a mother task/project are calculated from its sub-tasks. You can edit its specific properties here.",
        mother_task_creation_note: "A mother task is used to group other tasks. If it is top-level, it functions as a project. Its details (start date, end, duration, progress, members) will be automatically calculated or inherited from its sub-tasks once added. To modify specific properties of a top-level project (color, priority, description), use the 'Projects' section after creation.",
        validation_mother_task_parent_required: "‚ö†Ô∏è A mother task must have a project or another mother task as a parent."
    },
    // ... other languages
    };

    function translate(key, params = {}) {
        let translation = translations[currentLang]?.[key] || translations.fr[key] || key;
        for (const param in params) {
            translation = translation.replace(`{${param}}`, params[param]);
        }
        return translation;
    }

    function applyTranslations() {
        document.documentElement.lang = currentLang;
        if (gantt && gantt.i18n) {
           try {
             gantt.i18n.setLocale(currentLang);
           } catch (e) {
             console.warn("DHTMLX locale for " + currentLang + " not fully available, falling back. Erreur: " + e.message);
             if (currentLang !== 'en') {
                try { gantt.i18n.setLocale('en'); } catch (e2) {}
             }
           }
        }
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            const isLabel = el.tagName === 'LABEL';
            if (isLabel) {
              el.innerHTML = translate(key);
            } else {
              el.textContent = translate(key);
            }
        });
        document.querySelectorAll('[data-translate-placeholder-key]').forEach(el => {
            el.placeholder = translate(el.dataset.translatePlaceholderKey);
        });
        const memberActionBtn = document.getElementById('memberActionBtn');
        if (memberActionBtn) {
            memberActionBtn.textContent = translate(document.getElementById('editMemberId').value ? 'edit_member_btn' : 'add_member_btn');
        }
        const taskProjectSelect = document.getElementById('taskProject');
        if (taskProjectSelect) {
            const firstOption = taskProjectSelect.querySelector('option[value=""]');
            if (firstOption) firstOption.textContent = translate('select_project_option');
        }
        document.querySelectorAll('#projectPriority option, #customLightboxTaskPriority option, #taskPriority option, #customLightboxProjectPriority option').forEach(option => {
            if(option.value === 'project') {
              option.textContent = translate('task_priority_project');
            } else if (option.value) {
              const key = `priority_${option.value}`;
              option.textContent = translate(key);
            }
        });
        document.querySelectorAll('.language-selector button').forEach(button => {
            button.classList.remove('btn-primary', 'text-white');
            button.classList.add('btn-light');
        });
        const activeButton = document.querySelector(`.language-selector button[onclick="setLanguage('${currentLang}')"]`);
        if (activeButton) {
            activeButton.classList.remove('btn-light');
            activeButton.classList.add('btn-primary', 'text-white');
        }
        const toggleGridBtn = document.getElementById('toggleGridBtn');
        const gridBtnKey = isGridVisible ? 'hide_names_btn' : 'show_names_btn';
        toggleGridBtn.setAttribute('data-translate-key', gridBtnKey);
        toggleGridBtn.textContent = translate(gridBtnKey);
        const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
        const sidebarBtnKey = isSidebarCollapsed ? 'show_sidebar_btn' : 'hide_sidebar_btn';
        toggleSidebarBtn.setAttribute('data-translate-key', sidebarBtnKey);
        toggleSidebarBtn.textContent = translate(sidebarBtnKey);
        
        if (gantt && gantt.config) {
            if (gantt.locale.labels) {
                gantt.locale.labels.label_save = translate('save_btn');
                gantt.locale.labels.label_cancel = translate('cancel_btn');
                gantt.locale.labels.label_delete = translate('delete_btn');
            }
            gantt.config.columns = getGanttColumns();
        }
        renderMembers();
        renderProjects();
        updateTaskMembers();
        toggleNewTaskFieldsVisibility();
        updateUndoButtonState();
    }

    function setLanguage(lang) {
        currentLang = lang;
        setupDatePickers();
        applyTranslations();
        if(gantt && gantt.$container) {
            updateGantt();
        }
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const btn = document.getElementById('toggleSidebarBtn');
        const transitionDuration = 350;
        if (!isSidebarCollapsed) {
            sidebar.classList.add('collapsed');
            btn.textContent = translate('show_sidebar_btn');
            setTimeout(() => {
                if(gantt) gantt.render();
            }, transitionDuration);
        } else {
            requestAnimationFrame(() => {
                sidebar.classList.remove('collapsed');
                btn.textContent = translate('hide_sidebar_btn');
                setTimeout(() => {
                    if(gantt) gantt.render();
                }, transitionDuration);
            });
        }
        isSidebarCollapsed = !isSidebarCollapsed;
    }

    function toggleGanttGrid() {
        isGridVisible = !isGridVisible;
        gantt.config.show_grid = isGridVisible;
        gantt.render();
        const btn = document.getElementById('toggleGridBtn');
        const key = isGridVisible ? 'hide_names_btn' : 'show_names_btn';
        btn.setAttribute('data-translate-key', key);
        btn.textContent = translate(key);
    }

    function adjustColor(color, percent) {
      let r = parseInt(color.substring(1, 3), 16);
      let g = parseInt(color.substring(3, 5), 16);
      let b = parseInt(color.substring(5, 7), 16);
      r = parseInt(r * (100 + percent) / 100); g = parseInt(g * (100 + percent) / 100); b = parseInt(b * (100 + percent) / 100);
      r = (r < 255) ? r : 255; g = (g < 255) ? g : 255; b = (b < 255) ? b : 255;
      r = (r > 0) ? r : 0; g = (g > 0) ? g : 0; b = (b > 0) ? b : 0;
      const rr = ((r.toString(16).length === 1) ? "0" + r.toString(16) : r.toString(16));
      const gg = ((g.toString(16).length === 1) ? "0" + g.toString(16) : g.toString(16));
      const bb = ((b.toString(16).length === 1) ? "0" + b.toString(16) : b.toString(16));
      return `#${rr}${gg}${bb}`;
    }

    function getContrastColor(hexColor) {
      if (!hexColor) return '#000000';
      hexColor = hexColor.replace('#', '');
      if (hexColor.length === 3) {
        hexColor = hexColor.split('').map(char => char + char).join('');
      }
      if (hexColor.length !== 6) return '#000000';
      const r = parseInt(hexColor.substring(0, 2), 16);
      const g = parseInt(hexColor.substring(2, 4), 16);
      const b = parseInt(hexColor.substring(4, 6), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    function showNotification(message, type = 'success', params = {}, persistent = false) {
        const translatedMessage = message.startsWith("notification_") ? translate(message, params) : message;
        const div = document.createElement('div');
        div.className = `notification ${type}`;
        if (type === 'warning' || type === 'error') {
            div.classList.add('overload-alert');
        }
        div.innerHTML = translatedMessage;

        if (persistent) {
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => div.remove();
            div.appendChild(closeBtn);
        } else {
            setTimeout(() => div.remove(), 4000);
        }

        let container = document.querySelector('.notification-stack');
        if (!container) {
            container = document.createElement('div');
            container.className = 'notification-stack';
            document.body.appendChild(container);
        }
        container.appendChild(div);
    }

    function getFlatpickrDateFormatForLocale(lang) {
        switch (lang) {
            case 'fr': case 'es': case 'it': return "d/m/Y";
            case 'de': return "d.m.Y";
            default: return "Y-m-d";
        }
    }
    
    function getGanttDateFormatForLocale(lang) {
        switch (lang) {
            case 'fr': case 'es': case 'it': return "%d/%m/%Y";
            case 'de': return "%d.%m.%Y";
            default: return "%Y-%m-%d";
        }
    }

    function setupDatePickers() {
        if (datePickers.length > 0) {
            datePickers.forEach(picker => picker.destroy());
            datePickers = [];
        }
        const locale = (currentLang === 'en') ? 'default' : currentLang;
        const dateFormat = getFlatpickrDateFormatForLocale(currentLang);
        const pickerConfigs = ["#taskStart", "#taskEnd", "#customLightboxTaskStart", "#customLightboxTaskEnd", "#projectDeadline", "#customLightboxProjectDeadline"];
        pickerConfigs.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                const config = { dateFormat: dateFormat, locale: locale };
                if (selector === "#taskStart") {
                    config.onChange = function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            const endDatePicker = datePickers.find(p => p.element.id === 'taskEnd');
                            const durationInput = document.getElementById('taskDuration');
                            if (endDatePicker && endDatePicker.selectedDates.length > 0) {
                                const duration = gantt.calculateDuration({start_date: selectedDates[0], end_date: endDatePicker.selectedDates[0]});
                                durationInput.value = duration;
                            } else if (durationInput.value > 0) {
                                const endDate = gantt.calculateEndDate({start_date: selectedDates[0], duration: parseInt(durationInput.value)});
                                endDatePicker.setDate(endDate, false);
                            }
                        }
                    };
                } else if (selector === "#taskEnd") {
                    config.onChange = function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            const startDatePicker = datePickers.find(p => p.element.id === 'taskStart');
                            const durationInput = document.getElementById('taskDuration');
                            if (startDatePicker && startDatePicker.selectedDates.length > 0) {
                                const duration = gantt.calculateDuration({start_date: startDatePicker.selectedDates[0], end_date: selectedDates[0]});
                                durationInput.value = duration;
                            }
                        }
                    };
                } else if (selector === "#customLightboxTaskStart") {
                    config.onChange = function() { updateLightboxSchedule('start'); };
                } else if (selector === "#customLightboxTaskEnd") {
                    config.onChange = function() { updateLightboxSchedule('end'); };
                }
                datePickers.push(flatpickr(element, config));
            }
        });
        const taskDurationInput = document.getElementById('taskDuration');
        if (taskDurationInput) {
            taskDurationInput.removeEventListener('input', updateTaskDurationFromInput);
            taskDurationInput.addEventListener('input', updateTaskDurationFromInput);
        }
    }

    function updateTaskDurationFromInput() {
        const taskStartPicker = datePickers.find(p => p.element.id === 'taskStart');
        const taskEndPicker = datePickers.find(p => p.element.id === 'taskEnd');
        const durationValue = parseInt(document.getElementById('taskDuration').value);
        if (taskStartPicker && taskStartPicker.selectedDates.length > 0 && !isNaN(durationValue) && durationValue >= 0) {
            const startDate = taskStartPicker.selectedDates[0];
            const endDate = gantt.calculateEndDate({start_date: startDate, duration: durationValue});
            if (taskEndPicker) taskEndPicker.setDate(endDate, false);
        }
    }

    function addOrUpdateMember() {
      saveStateToHistory();
      const editMemberId = document.getElementById('editMemberId').value;
      const name = document.getElementById('memberName').value.trim();
      const color = document.getElementById('memberColor').value;
      const actionBtn = document.getElementById('memberActionBtn');
      if (!name) { showNotification('notification_enter_name', 'error'); return; }
      if (members.some(m => m.name === name && String(m.id) !== String(editMemberId))) { showNotification('notification_member_exists', 'error'); return; }
      if (editMemberId) {
        const member = members.find(m => String(m.id) === String(editMemberId));
        if (member) { member.name = name; member.color = color; showNotification('notification_member_edited', 'success', {name}); }
        document.getElementById('editMemberId').value = '';
        actionBtn.textContent = translate('add_member_btn'); actionBtn.classList.replace('btn-warning', 'btn-primary');
      } else {
        members.push({ id: crypto.randomUUID(), name, color, visible: true });
        showNotification('notification_member_added', 'success', {name});
      }
      document.getElementById('memberName').value = ''; document.getElementById('memberColor').value = '#667eea';
      renderMembers(); updateTaskMembers(); updateGantt();
      updateUndoButtonState();
    }

    function renderMembers() {
        const container = document.getElementById('membersList');
        if (!container) return;

        calculateMemberWorkload(); 

        container.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => {
            const memberOverload = getMemberOverload(m.id);
            let overloadHtml = '';
            if (memberOverload.length > 0) {
                overloadHtml = `
                    <div class="overload-dropdown">
                        <select class="form-select form-select-sm" onchange="highlightOverloadDay('${m.id}', this.value)">
                            <option value="">Jours en surcharge</option>
                            ${memberOverload.map(day => `<option value="${day.rawDate}">${day.icon} ${day.date}</option>`).join('')}
                        </select>
                    </div>`;
            }
            return `
                <div class="task-item">
                    <div class="member-item">
                        <div class="member-info">
                            <input type="checkbox" ${m.visible ? 'checked' : ''} onchange="toggleMemberVisibility('${m.id}')">
                            <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name}
                        </div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editMember('${m.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeMember('${m.id}')">üóëÔ∏è</button>
                        ${overloadHtml}
                    </div>
                </div>`;
        }).join('');
    }
	
	function getAllTasks() {
		let tasks = [];
		gantt.eachTask(function(task) {
			tasks.push(task);
		});
		return tasks;
	}

    function editMember(id) {
      const member = members.find(m => String(m.id) === String(id));
      if (member) {
        document.getElementById('editMemberId').value = member.id;
        document.getElementById('memberName').value = member.name;
        document.getElementById('memberColor').value = member.color;
        const actionBtn = document.getElementById('memberActionBtn');
        actionBtn.textContent = translate('edit_member_btn'); actionBtn.classList.replace('btn-primary', 'btn-warning');
      }
    }

    function removeMember(id) {
      saveStateToHistory();
      const member = members.find(m => String(m.id) === String(id));
      const memberName = member ? member.name : '';
      members = members.filter(m => String(m.id) !== String(id));
      Object.values(projects).forEach(project => {
        function updateMemberIdsInTask(taskItem) {
            if (taskItem.memberIds) {
                taskItem.memberIds = taskItem.memberIds.filter(mid => String(mid) !== String(id));
            }
            if (taskItem.tasks) {
                taskItem.tasks.forEach(subTask => updateMemberIdsInTask(subTask));
            }
        }
        updateMemberIdsInTask(project);
        project.tasks.forEach(task => updateMemberIdsInTask(task));
      });
      renderMembers(); updateTaskMembers(); updateGantt();
      showNotification('notification_member_removed', 'success', {name: memberName});
      updateUndoButtonState();
    }

    function toggleMemberVisibility(memberId) {
      saveStateToHistory();
      const member = members.find(m => String(m.id) === String(memberId));
      if (member) {
        member.visible = !member.visible;
        gantt.refreshData();
        renderMembers();
        showNotification('notification_visibility_updated', 'success', {name: member.name});
      }
      updateUndoButtonState();
    }

    function updateTaskMembers() {
      const container = document.getElementById('taskMembers');
      if (!container) return;
      container.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${m.id}" id="task-member-${m.id}" name="task-member-${m.id}">
          <label class="form-check-label" for="task-member-${m.id}"> <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name} </label>
        </div>`).join('');
    }

    function addProject() {
      saveStateToHistory();
      const name = document.getElementById('projectName').value.trim();
      if (!name) { showNotification('notification_project_name_required', 'error'); return; }
      if (Object.values(projects).some(p => p.name === name)) {
          showNotification('notification_project_exists', 'error');
          return;
      }
      const projectId = crypto.randomUUID();
      const startDate = new Date().toISOString().split('T')[0];
      const defaultTasksTemplates = [
        { key: 'default_task_cahier_des_charges', duration: 5, initialDelay: 0 },
        { key: 'default_task_conception_pedagogique', duration: 7, initialDelay: 5 },
        { key: 'default_task_production_contenus', duration: 10, initialDelay: 12 },
        { key: 'default_task_developpement_interactif', duration: 8, initialDelay: 22 },
        { key: 'default_task_tests_validation', duration: 5, initialDelay: 30 }
      ];
      let currentDate = new Date(startDate);
      if (isNaN(currentDate.getTime())) {
          currentDate = new Date();
      }
      const tasks = defaultTasksTemplates.map((taskTemplate) => {
        const taskName = translate(taskTemplate.key, { projectName: name });
        let actualStartDate = gantt.date.add(currentDate, taskTemplate.initialDelay, "day");
        if (gantt.config.skip_off_time) {
            while (!gantt.isWorkTime({date: actualStartDate, unit: "day"})) {
                actualStartDate.setDate(actualStartDate.getDate() + 1);
            }
        }
        const taskStart = gantt.date.date_to_str(gantt.config.date_format)(actualStartDate);
        let tempGanttTaskForCalc = {start_date: actualStartDate, duration: taskTemplate.duration};
        let taskEnd = gantt.date.date_to_str(gantt.config.date_format)(gantt.calculateEndDate(tempGanttTaskForCalc));
        const taskObj = {
          id: crypto.randomUUID(), name: taskName, text: taskName, start: taskStart, end: taskEnd, duration: taskTemplate.duration,
          progress: 0, project: name, parent: projectId, memberIds: members.length > 0 ? [members[Math.floor(Math.random() * members.length)].id] : [],
          priority: document.getElementById('projectPriority').value,
          comments: "", color: "#5cb85c", type: gantt.config.types.task, locked: false
        };
        return taskObj;
      });
      let projectStartDate = tasks.length > 0 ? tasks[0].start : new Date().toISOString().split('T')[0];
      let projectEndDate = tasks.length > 0 ? tasks[tasks.length - 1].end : gantt.date.date_to_str(gantt.config.date_format)(gantt.calculateEndDate({start_date: new Date(), duration: 30}));
      let projectDuration = tasks.length > 0 ? gantt.calculateDuration({
          start_date: gantt.date.str_to_date(gantt.config.date_format)(projectStartDate),
          end_date: gantt.date.str_to_date(gantt.config.date_format)(projectEndDate)
      }) : 30;
      projects[projectId] = {
        name, description: document.getElementById('projectDescription').value, deadline: document.getElementById('projectDeadline').value,
        priority: document.getElementById('projectPriority').value, color: document.getElementById('projectColor').value,
        tasks: tasks, id: projectId, visible: true, type: gantt.config.types.project, parent: "0",
        start: projectStartDate, end: projectEndDate, duration: projectDuration, progress: 0, locked: false
      };
      document.getElementById('projectName').value = ''; document.getElementById('projectDescription').value = '';
      document.getElementById('projectDeadline').value = ''; document.getElementById('projectPriority').value = 'low';
      document.getElementById('projectColor').value = '#28a745';
      renderProjects(); updateGantt();
      showNotification('notification_project_created', 'success', {name});
      updateUndoButtonState();
    }

    function renderProjects() {
      const list = document.getElementById('projectList'); const select = document.getElementById('taskProject');
      if (!list || !select) return;
      list.innerHTML = Object.values(projects).map(project => {
          let priorityEmoji = '';
          if (project.priority === "high") priorityEmoji = "üî¥ ";
          else if (project.priority === "medium") priorityEmoji = "üü° ";
          else if (project.priority === "low") priorityEmoji = "üü¢ ";
          return `
        <div class="task-item" style="border-left: 4px solid ${project.color};">
          <input type="checkbox" ${project.visible ? 'checked' : ''} onchange="toggleProjectVisibility('${project.id}')">
          <span class="member-indicator" style="background-color: ${project.color};"></span> ${priorityEmoji}${project.name} (${translate('priority_' + project.priority)})
          <button class="btn btn-sm btn-outline-primary me-2" onclick="openCustomLightbox('${project.id}')">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProject('${project.id}')">üóëÔ∏è</button>
        </div>`;
      }).join('');
    }

    function toggleProjectVisibility(projectId) {
        saveStateToHistory();
        if (projects[projectId]) {
            projects[projectId].visible = !projects[projectId].visible;
            renderProjects();
            updateGantt();
        }
        updateUndoButtonState();
    }

    function removeProject(projectId) {
        const projectToRemove = projects[projectId];
        if (!projectToRemove) {
            console.error("Project to remove not found:", projectId);
            return;
        }

        if (confirm(translate('clear_all_data_confirm_project', {name: projectToRemove.name}))) {
            saveStateToHistory();

            const allTaskIdsToRemove = [];
            function collectTaskIds(task) {
                allTaskIdsToRemove.push(task.id);
                if (task.tasks && task.tasks.length > 0) {
                    task.tasks.forEach(collectTaskIds);
                }
            }
            collectTaskIds(projectToRemove);

            allLinks = allLinks.filter(link => 
                !allTaskIdsToRemove.includes(String(link.source)) && 
                !allTaskIdsToRemove.includes(String(link.target))
            );

            delete projects[projectId];
            
            updateGantt();

            showNotification('notification_project_removed', 'success', {name: projectToRemove.name});
            updateUndoButtonState();
        }
    }

    function toggleNewTaskFieldsVisibility() {
        const taskType = document.getElementById('taskType').value;
        const normalFields = document.getElementById('normalTaskFields');
        const summaryTaskNote = document.getElementById('summaryTaskNote');
        if (taskType === 'task') {
            normalFields.style.display = 'block';
            summaryTaskNote.style.display = 'none';
            populateProjectDropdown('taskProject', '', null, true, true); 
            document.getElementById('taskStart').setAttribute('required', 'required');
            document.getElementById('taskEnd').setAttribute('required', 'required');
            document.getElementById('taskDuration').setAttribute('required', 'required');
        } else {
            normalFields.style.display = 'none';
            summaryTaskNote.style.display = 'block';
            populateProjectDropdown('taskProject', '', null, false, false); 
            document.getElementById('taskStart').removeAttribute('required');
            document.getElementById('taskEnd').removeAttribute('required');
            document.getElementById('taskDuration').removeAttribute('required');
            const taskProjectSelect = document.getElementById('taskProject');
            if (taskProjectSelect.options.length > 0 && taskProjectSelect.value === "") {
                if (taskProjectSelect.options.length > 0) {
                     taskProjectSelect.selectedIndex = 0;
                }
            }
        }
    }

    function addTask() {
        saveStateToHistory();
        const taskName = document.getElementById('taskName').value.trim();
        const taskType = document.getElementById('taskType').value;
        let parentIdFromSelect = document.getElementById('taskProject').value;
        if (!taskName) {
            showNotification('notification_enter_name', 'error');
            return;
        }
        if (taskType === 'project') {
            if (!parentIdFromSelect || parentIdFromSelect === "0") {
                showNotification('validation_mother_task_parent_required', 'error');
                return;
            }
        } else {
            parentIdFromSelect = parentIdFromSelect || "0";
        }
        let newTaskData = {
            id: crypto.randomUUID(), name: taskName, text: taskName, comments: "",
            color: "#5cb85c", type: taskType, parent: parentIdFromSelect, locked: false
        };
        if (taskType === 'task') {
            const progress = parseFloat(document.getElementById('taskProgress').value);
            const assignedMemberIds = Array.from(document.getElementById('taskMembers').querySelectorAll('input:checked')).map(input => input.value);
            const taskPriority = document.getElementById('taskPriority').value;
            const taskStartPicker = datePickers.find(picker => picker.element.id === 'taskStart');
            const taskEndPicker = datePickers.find(picker => picker.element.id === 'taskEnd');
            const taskDurationInput = document.getElementById('taskDuration');
            const startDateObject = taskStartPicker.selectedDates.length > 0 ? taskStartPicker.selectedDates[0] : null;
            let endDateObject = taskEndPicker.selectedDates.length > 0 ? taskEndPicker.selectedDates[0] : null;
            let durationValue = parseInt(taskDurationInput.value);
            if (!startDateObject || (!endDateObject && (isNaN(durationValue) || durationValue <= 0)) || (endDateObject && isNaN(durationValue))) {
                showNotification('notification_fill_all_fields', 'error');
                return;
            }
            if (endDateObject && taskEndPicker.selectedDates.length > 0) {
                durationValue = gantt.calculateDuration({start_date: startDateObject, end_date: endDateObject});
            } else if (!isNaN(durationValue) && durationValue > 0) {
                endDateObject = gantt.calculateEndDate({start_date: startDateObject, duration: durationValue});
            } else {
                showNotification('notification_fill_all_fields', 'error');
                return;
            }
            if (endDateObject < startDateObject) {
                showNotification('notification_invalid_date_format', 'error');
                return;
            }
            newTaskData.start = gantt.date.date_to_str(gantt.config.date_format)(startDateObject);
            newTaskData.end = gantt.date.date_to_str(gantt.config.date_format)(endDateObject);
            newTaskData.duration = durationValue;
            newTaskData.progress = progress;
            newTaskData.memberIds = assignedMemberIds;
            newTaskData.priority = taskPriority;
        } else {
            newTaskData.color = "#667eea";
            newTaskData.priority = document.getElementById('projectPriority').value || 'low';
            newTaskData.start = null;
            newTaskData.end = null;
            newTaskData.duration = 0;
            newTaskData.progress = 0;
            newTaskData.open = true;
        }
        
        const parentData = findTaskInProjectsModel(parentIdFromSelect);
        if (parentData) {
            if (!parentData.tasks) {
                parentData.tasks = [];
            }
            parentData.tasks.push(newTaskData);
        }

        document.getElementById('taskProject').value = '';
        document.getElementById('taskName').value = '';
        document.getElementById('taskType').value = 'task';
        toggleNewTaskFieldsVisibility(); 
        datePickers.forEach(picker => picker.clear());
        document.getElementById('taskDuration').value = '';
        document.getElementById('taskProgress').value = '0';
        document.getElementById('taskPriority').value = 'project';
        document.getElementById('taskMembers').querySelectorAll('input:checked').forEach(input => input.checked = false);
        
        updateGantt();
        manualRecalculate(true);
        showNotification('notification_task_added', 'success', { name: taskName });
        updateUndoButtonState();
    }

    function showTaskMembersLightbox(taskId) {
      const ganttTask = gantt.getTask(taskId);
      if (!ganttTask || ganttTask.type === gantt.config.types.project) {
        showNotification('Cannot manage members for mother tasks directly. Members are assigned to individual tasks.', 'error');
        return;
      }
      let taskData = findTaskInProjectsModel(taskId);
      if (!taskData) { return; }
      document.getElementById('editTaskId').value = taskId;
      const container = document.getElementById('editTaskMembersList');
      container.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${m.id}" id="edit-task-member-${m.id}" name="edit-task-member-${m.id}" ${(taskData.memberIds || []).includes(m.id) ? 'checked' : ''}>
          <label class="form-check-label" for="edit-task-member-${m.id}">
            <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name}
          </label>
        </div>`).join('');
      document.getElementById('editTaskMembersModalLabel').textContent = `${translate('manage_task_members_modal_title_prefix')}: ${(ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '')}`;
      new bootstrap.Modal(document.getElementById('editTaskMembersModal')).show();
    }

    function saveTaskMembers() {
      saveStateToHistory();
      const taskId = document.getElementById('editTaskId').value;
      let taskData = findTaskInProjectsModel(taskId);
      if (!taskData) { return; }
      const assignedMemberIds = Array.from(document.getElementById('editTaskMembersList').querySelectorAll('input:checked')).map(input => input.value);
      taskData.memberIds = assignedMemberIds;
      let currentParentId = taskData.parent;
      while (currentParentId !== "0" && gantt.getTask(currentParentId)) {
          recalculateProjectDatesAndProgress(currentParentId);
          currentParentId = gantt.getTask(currentParentId).parent;
      }
      manualRecalculate(true);
      showNotification('notification_task_members_updated', 'success', {name: (taskData.name || '').replace(/^[?üü°üü¢]\s*/, '')});
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('editTaskMembersModal'));
      if (modalInstance) modalInstance.hide();
      updateUndoButtonState();
    }

    function exportToJSON() {
      const data = { members, projects, allLinks, currentLang };
      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'gantt_data.json'; a.click();
      URL.revokeObjectURL(url);
      showNotification('notification_export_success');
    }

    function importFromJSON(event) {
        saveStateToHistory();
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.members || !data.projects || !data.allLinks) {
                    throw new Error(translate('notification_invalid_json_format'));
                }

                gantt.clearAll();
                projects = {};
                allLinks = [];
                
                members = data.members || [];
                
                const idMap = new Map();
                const tasksToProcess = [];

                Object.values(data.projects).forEach(project => {
                    tasksToProcess.push(project);
                    const processChildren = (task) => {
                        if (task.tasks) {
                            task.tasks.forEach(child => {
                                tasksToProcess.push(child);
                                processChildren(child);
                            });
                        }
                    };
                    processChildren(project);
                });

                tasksToProcess.forEach(task => {
                    const oldId = task.id;
                    const newId = crypto.randomUUID();
                    idMap.set(oldId, newId);
                    task.id = newId;
                });

                tasksToProcess.forEach(task => {
                    if (task.parent && task.parent !== "0") {
                        task.parent = idMap.get(task.parent) || "0";
                    }
                });

                const sanitizedLinks = data.allLinks.map(link => {
                    const newSource = idMap.get(link.source);
                    const newTarget = idMap.get(link.target);
                    if (newSource && newTarget) {
                        return {
                            id: crypto.randomUUID(),
                            source: newSource,
                            target: newTarget,
                            type: link.type
                        };
                    }
                    return null;
                }).filter(Boolean);

                allLinks = sanitizedLinks;
                projects = data.projects;
                currentLang = data.currentLang || 'fr';

                setLanguage(currentLang);
                renderMembers();
                renderProjects();
                updateTaskMembers();
                updateGantt();
                showNotification('notification_import_success');
                document.getElementById('importJSON').value = '';
                updateUndoButtonState();

            } catch (error) {
                showNotification('notification_import_error', 'error', { message: error.message });
                console.error("Import error:", error);
            }
        };
        reader.readAsText(file);
    }

    function toggleCustomLightboxFieldsVisibility() {
        const taskType = document.getElementById('customLightboxTaskType').value;
        const normalFields = document.getElementById('customLightboxNormalTaskFields');
        const projectFields = document.getElementById('customLightboxProjectFields');
        const summaryNote = document.getElementById('customLightboxSummaryTaskFields');

        if (taskType === 'task') {
            normalFields.style.display = 'block';
            projectFields.style.display = 'none';
            summaryNote.style.display = 'none';
        } else { // 'project' type
            normalFields.style.display = 'none';
            projectFields.style.display = 'block';
            summaryNote.style.display = 'block';
        }
    }


    function openCustomLightbox(id) {
        elementToFocusOnModalClose = document.activeElement;
        currentEditingTaskId = id;
        const ganttTask = gantt.getTask(id);
        if (!ganttTask) return;
        document.getElementById('customLightboxTaskId').value = id;
        document.getElementById('customLightboxTaskName').value = (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '');
        
        document.getElementById('customLightboxTaskType').value = ganttTask.type;
        document.getElementById('customLightboxTaskType').disabled = true; // Prevent type change
        toggleCustomLightboxFieldsVisibility();
        
        populateProjectDropdown('customLightboxTaskParent', ganttTask.parent, id, true, true); 
        
        if (ganttTask.type === gantt.config.types.project) {
            const projectData = findTaskInProjectsModel(id) || {};
            document.getElementById('customLightboxProjectDescription').value = projectData.description || "";
            const deadlinePicker = datePickers.find(p => p.element.id === 'customLightboxProjectDeadline');
            if(deadlinePicker) deadlinePicker.setDate(projectData.deadline, false);
            document.getElementById('customLightboxProjectColor').value = projectData.color || '#667eea';
            document.getElementById('customLightboxProjectPriority').value = projectData.priority || 'low';
        } else { // It's a task
            let taskDataStore = findTaskInProjectsModel(id);
            const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
            const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');
            if (ganttTask.start_date && startPicker) startPicker.setDate(ganttTask.start_date, false);
            if (ganttTask.end_date && endPicker) endPicker.setDate(ganttTask.end_date, false);
            document.getElementById('customLightboxTaskDuration').value = ganttTask.duration || 0;
            document.getElementById('customLightboxTaskProgress').value = (taskDataStore ? taskDataStore.progress : ganttTask.progress) || 0;
            const priorityToSet = (taskDataStore && typeof taskDataStore.priority !== 'undefined') ? taskDataStore.priority : 'project';
            document.getElementById('customLightboxTaskPriority').value = priorityToSet;
            document.getElementById('customLightboxTaskComments').value = (taskDataStore && taskDataStore.comments) || "";
            document.getElementById('customLightboxTaskColor').value = (taskDataStore && taskDataStore.color) || "#5cb85c";
            const membersContainer = document.getElementById('customLightboxTaskMembers');
            membersContainer.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
                <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${m.id}" id="custom-lightbox-member-${m.id}" name="custom-lightbox-member-${m.id}" ${(taskDataStore && taskDataStore.memberIds && taskDataStore.memberIds.includes(m.id)) ? 'checked' : ''}>
                <label class="form-check-label" for="custom-lightbox-member-${m.id}">
                    <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name}
                </label>
                </div>`).join('');
        }
        document.getElementById('customTaskModalLabel').textContent = translate('custom_lightbox_title') + (ganttTask.text ? `: ${(ganttTask.text || '').replace(/^[üî¥ÔøΩüü¢]\s*/, '').trim().substring(0,30)}...` : '');
        if (!customTaskModalInstance) {
            customTaskModalInstance = new bootstrap.Modal(document.getElementById('customTaskModal'));
        }
        customTaskModalInstance.show();
        applyTranslations();
    }

    function closeCustomLightbox() {
        if (customTaskModalInstance) customTaskModalInstance.hide();
        if (elementToFocusOnModalClose) elementToFocusOnModalClose.focus();
        currentEditingTaskId = null;
        elementToFocusOnModalClose = null;
        document.getElementById('customLightboxTaskType').disabled = false;
    }

    function saveCustomLightboxChanges() {
        saveStateToHistory();
        if (!currentEditingTaskId) return;

        const taskName = document.getElementById('customLightboxTaskName').value.trim();
        let newParentId = document.getElementById('customLightboxTaskParent').value || "0";
        
        if (!taskName) {
            showNotification('notification_enter_name', 'error');
            return;
        }
        
        const taskData = findTaskInProjectsModel(currentEditingTaskId);
        if (!taskData) {
            console.error("Save failed: Task not found in data model:", currentEditingTaskId);
            return;
        }

        const ganttTask = gantt.getTask(currentEditingTaskId);
        
        // Update model properties
        taskData.name = taskName;
        taskData.text = taskName;
        
        if (ganttTask.type === gantt.config.types.project) {
            taskData.description = document.getElementById('customLightboxProjectDescription').value;
            const deadlinePicker = datePickers.find(p => p.element.id === 'customLightboxProjectDeadline');
            taskData.deadline = deadlinePicker.selectedDates.length > 0 ? gantt.date.date_to_str(gantt.config.date_format)(deadlinePicker.selectedDates[0]) : "";
            taskData.color = document.getElementById('customLightboxProjectColor').value;
            taskData.priority = document.getElementById('customLightboxProjectPriority').value;
        } else { // It's a task
            taskData.progress = parseFloat(document.getElementById('customLightboxTaskProgress').value);
            taskData.priority = document.getElementById('customLightboxTaskPriority').value;
            taskData.comments = document.getElementById('customLightboxTaskComments').value;
            taskData.color = document.getElementById('customLightboxTaskColor').value;
            taskData.memberIds = Array.from(document.getElementById('customLightboxTaskMembers').querySelectorAll('input:checked')).map(input => input.value);
            
            const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
            const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');
            const newStartDate = startPicker.selectedDates[0];
            const newEndDate = endPicker.selectedDates[0];

            if (!newStartDate || !newEndDate || newEndDate < newStartDate) {
                showNotification('notification_invalid_date_format', 'error');
                return; 
            }
            
            const finalDuration = gantt.calculateDuration({start_date: newStartDate, end_date: newEndDate});

            taskData.start = gantt.date.date_to_str(gantt.config.date_format)(newStartDate);
            taskData.end = gantt.date.date_to_str(gantt.config.date_format)(newEndDate);
            taskData.duration = finalDuration;
        }
        
        // Handle reparenting in the data model
        if (taskData.parent !== newParentId) {
            const oldParentData = findTaskInProjectsModel(taskData.parent);
            if (oldParentData && oldParentData.tasks) {
                const index = oldParentData.tasks.findIndex(t => t.id === currentEditingTaskId);
                if (index > -1) {
                    oldParentData.tasks.splice(index, 1);
                }
            }
            const newParentData = findTaskInProjectsModel(newParentId);
            if (newParentData) {
                if (!newParentData.tasks) {
                    newParentData.tasks = [];
                }
                newParentData.tasks.push(taskData);
            } else if (newParentId == 0) {
                 projects[taskData.id] = taskData;
            }
            taskData.parent = newParentId;
        }

        updateGantt();
        
        showNotification('notification_task_updated', 'success', {name: taskName});
        closeCustomLightbox();
        updateUndoButtonState();
    }

    function deleteTaskFromCustomLightbox() {
        saveStateToHistory();
        if (!currentEditingTaskId) return;
        const taskToDelete = gantt.getTask(currentEditingTaskId);
        const taskName = taskToDelete ? taskToDelete.text : '';
        const parentOfTaskToDelete = taskToDelete ? taskToDelete.parent : "0";
        gantt.deleteTask(currentEditingTaskId);
        rebuildProjectsFromGanttData(); 
        if (parentOfTaskToDelete !== "0") {
            recalculateProjectDatesAndProgress(parentOfTaskToDelete);
        }
        updateGantt();
        showNotification('notification_task_deleted', 'success', {name: (taskName || '').replace(/^[üî¥ÔøΩüü¢]\s*/, '').trim()});
        closeCustomLightbox();
        updateUndoButtonState();
    }

    function updateLightboxSchedule(source) {
        const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
        const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');
        const durationInput = document.getElementById('customLightboxTaskDuration');
        if (!startPicker || !endPicker || !durationInput) {
            return;
        }
        const startDate = startPicker.selectedDates[0];
        const endDate = endPicker.selectedDates[0];
        const duration = parseInt(durationInput.value, 10);
        if (source === 'start') {
            if (startDate && !isNaN(duration)) {
                const newEndDate = gantt.calculateEndDate({ start_date: startDate, duration: duration });
                endPicker.setDate(newEndDate, false);
            }
        } else if (source === 'end') {
            if (startDate && endDate) {
                if (endDate < startDate) {
                    endPicker.setDate(startDate, false);
                    durationInput.value = gantt.calculateDuration({start_date: startDate, end_date: startDate});
                } else {
                    const newDuration = gantt.calculateDuration({ start_date: startDate, end_date: endDate });
                    durationInput.value = newDuration;
                }
            }
        } else if (source === 'duration') {
            if (startDate && !isNaN(duration)) {
                const newEndDate = gantt.calculateEndDate({ start_date: startDate, duration: duration });
                endPicker.setDate(newEndDate, false);
            }
        }
    }

    function getGanttColumns() {
        return [
            {
                name: "text", label: translate('gantt_col_task'), width: '*', tree: true, resize: true,
                template: function(task) {
                    const taskText = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, ''); 
                    if (task.type === gantt.config.types.project) {
                        const projectData = findTaskInProjectsModel(task.id);
                        if (projectData && typeof projectData.progress === 'number') {
                             return `${taskText} (${Math.round(projectData.progress * 100)}%)`;
                        }
                        return `${taskText} (${Math.round(task.progress * 100)}%)`;
                    }
                    let taskName = taskText;
                    let memberDots = "";
                    let progressDisplay = "";
                    let taskDataInStore = findTaskInProjectsModel(task.id);
                    if (taskDataInStore) {
                        const memberIds = taskDataInStore.memberIds || [];
                        const visibleMembers = memberIds.map(id => members.find(m => String(m.id) === String(id))).filter(member => member && member.visible);
                        if (visibleMembers.length > 0) {
                            memberDots = visibleMembers.map(member => `<span class="member-indicator" style="background-color:${member.color}; vertical-align: middle;" title="${(member.name || '')}"></span>`).join("");
                        }
                        progressDisplay = ` (${Math.round(taskDataInStore.progress * 100)}%)`;
                    } else {
                       progressDisplay = ` (${Math.round(task.progress * 100)}%)`;
                    }
                    return `${taskName} ${memberDots} ${progressDisplay}`;
                }
            },
            {
                name: "lock", label: "‚úî", width: 40, align: "center",
                template: function(task) {
                    // Affiche une case coch√©e pour les t√¢ches non verrouill√©es et une case d√©coch√©e pour les t√¢ches verrouill√©es.
                    return `<div class="gantt_grid_cell_lock" onclick="toggleTaskLock('${task.id}')">${task.locked ? '‚òê' : '‚úÖ'}</div>`;
                }
            }
        ];
    }

    function weekendCss(date) {
      return (date.getDay() === 0 || date.getDay() === 6) ? "weekend" : "";
    }

    function initGantt() {
      gantt.plugins({ 
          export_api: true, 
          zoom: true, 
          tooltip: true
      });
      gantt.config.work_time = true;
      gantt.config.skip_off_time = true;
      gantt.config.auto_scheduling = true;
      gantt.config.auto_scheduling_strict = true;
      gantt.config.auto_scheduling_initial = true;
      gantt.config.date_format = "%Y-%m-%d";
      gantt.config.grid_resize = true;
      gantt.config.drag_progress = true;
      gantt.config.tooltip_timeout = 30;
      gantt.config.show_grid = isGridVisible;
      gantt.config.order_branch = true;
      gantt.config.order_branch_free = true;
      gantt.config.auto_types = false;
      gantt.config.drag_project = false;
      gantt.setWorkTime({ day: 0, hours: false });
      gantt.setWorkTime({ day: 6, hours: false });
      gantt.templates.date_grid = function(date){
          let format;
          switch(currentLang) {
              case 'fr': case 'es': case 'it': 
                  format = "%d/%m/%Y"; 
                  break;
              case 'de': 
                  format = "%d.%m.%Y"; 
                  break;
              default: 
                  format = "%Y-%m-%d";
          }
          return gantt.date.date_to_str(format)(date);
      };
      gantt.config.columns = getGanttColumns();
      gantt.init("gantt_here");
      gantt.config.order_branch = true;
      gantt.config.auto_types = false;
      gantt.attachEvent("onBeforeRowDragEnd", function(id, parent, tindex) {
          if (parent == 0) return true;
          if (!gantt.isTaskExists(parent)) return false;
          const newParentTask = gantt.getTask(parent);
          if (newParentTask.type === 'task') {
              showNotification("Une t√¢che ne peut pas contenir d'autres t√¢ches.", "error");
              return false;
          }
          return true;
      });
      gantt.attachEvent("onAfterTaskUpdate", function(id, task){
          if(isUpdatingGanttProgrammatically) return;
          saveStateToHistory();
          rebuildProjectsFromGanttData();
          updateGantt();
          updateUndoButtonState();
      });
      applyZoom(currentZoomLevelIndex);
      
      gantt.templates.task_text = function(start, end, task){
          const taskText = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, '');
          if (task.type === gantt.config.types.project) {
              const projectData = findTaskInProjectsModel(task.id);
              if (projectData && typeof projectData.progress === 'number') {
                  return `${taskText} (${Math.round(projectData.progress * 100)}%)`;
              }
              return `${taskText} (${Math.round(task.progress * 100)}%)`;
          }
          let taskName = taskText;
          let memberDots = "";
          let progressDisplay = "";
          let taskDataInStore = findTaskInProjectsModel(task.id);
          if (taskDataInStore) {
              const memberIds = taskDataInStore.memberIds || [];
              const visibleMembers = memberIds.map(id => members.find(m => String(m.id) === String(id))).filter(member => member && member.visible);
              if (visibleMembers.length > 0) {
                  memberDots = visibleMembers.map(member => `<span class="member-indicator" style="background-color:${member.color}; vertical-align: middle;" title="${(member.name || '')}"></span>`).join("");
              }
              progressDisplay = ` (${Math.round(taskDataInStore.progress * 100)}%)`;
          } else {
             progressDisplay = ` (${Math.round(task.progress * 100)}%)`;
          }
          return `${taskName} ${memberDots} ${progressDisplay}`;
      };
      gantt.templates.grid_row_class = function(start, end, task) {
          let rowClass = "";
          let taskDataInStore = findTaskInProjectsModel(task.id);
          if (taskDataInStore) {
              let effectivePriority = taskDataInStore.priority || 'low';
              if (effectivePriority === 'project' && String(task.parent) !== "0") {
                  let currentParentId = String(task.parent);
                  while (currentParentId && currentParentId !== "0") {
                      const parentGanttTask = gantt.getTask(currentParentId);
                      if (!parentGanttTask) break;
                      if (parentGanttTask.type === gantt.config.types.project) {
                          const parentData = findTaskInProjectsModel(parentGanttTask.id);
                          if (parentData && parentData.priority && parentData.priority !== 'project') {
                              effectivePriority = parentData.priority;
                              break;
                          }
                      }
                      currentParentId = parentGanttTask.parent;
                  }
              }
              rowClass += ` priority-${effectivePriority}`;
          } else if (task.type === gantt.config.types.project && String(task.parent) === "0") {
              const projectData = projects[String(task.id)];
              if (projectData) rowClass += ` priority-${projectData.priority}`;
          }

          if (highlightedInfo.taskIds.includes(task.id)) {
              rowClass += " " + highlightedInfo.level;
          }

          return rowClass.trim();
      };
      gantt.templates.task_class = function(start, end, task){
        let task_class = "";
        if (task.readonly) {
            task_class += " task-locked";
        }
        if (highlightedInfo.taskIds.includes(task.id)) {
            task_class += " " + highlightedInfo.level;
        }
        let taskDataInStore = findTaskInProjectsModel(task.id);
        if(taskDataInStore && taskDataInStore.type === gantt.config.types.project){
            task_class += ` project-priority-${taskDataInStore.priority}`;
        }
        return task_class.trim();
      };
      gantt.templates.timeline_cell_class = function(item, date) {
        if (date.getDay() === 0 || date.getDay() === 6) {
            return "weekend";
        }
        return "";
      };
      gantt.templates.tooltip_text = function(start, end, task){
        const taskText = (task.text || '').replace(/^[ÔøΩüü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim(); 
        let html = `<b>${taskText}</b><br/>`;
        html += `<b>${translate('gantt_col_start_date')}:</b> ${gantt.templates.date_grid(start)}<br/>`;
        html += `<b>${translate('gantt_col_end_date')}:</b> ${gantt.templates.date_grid(gantt.calculateEndDate(task))}<br/>`;
        html += `<b>${translate('gantt_col_duration')}:</b> ${task.duration} ${translate('gantt_col_duration').includes('(j)') ? 'j' : 'd'}<br/>`;
        html += `<b>${translate('gantt_col_progress')}:</b> ${Math.round(task.progress * 100)}%<br/>`;
        let taskDataInStore = findTaskInProjectsModel(task.id);
        if (taskDataInStore && taskDataInStore.type !== gantt.config.types.project) {
            const memberIds = taskDataInStore.memberIds || [];
            if (memberIds.length > 0) {
                const memberNames = memberIds.map(id => {
                    const member = members.find(m => String(m.id) === String(id));
                    return member ? (member.name || '') : '';
                }).filter(name => name).join(", ");
                if (memberNames) html += `<b>${translate('gantt_col_members')}:</b> ${memberNames}<br/>`;
            }
            if (taskDataInStore.comments) {
                html += `<b>${translate('custom_lightbox_task_comments_label')}:</b> ${taskDataInStore.comments.substring(0, 100)}...<br/>`;
            }
        }
        return html;
      };
      gantt.attachEvent("onBeforeTaskDisplay", function(id, task) {
        let baseColor = "#007bff";
        let taskDataInStore = findTaskInProjectsModel(id);
        if (taskDataInStore) {
            baseColor = taskDataInStore.color || "#007bff";
        } else {
            baseColor = task.color || "#5cb85c";
        }
        if (typeof baseColor !== 'string' || !/^#[0-9a-fA-F]{6}$/.test(baseColor)) {
            baseColor = "#007bff";
        }
        task.color = baseColor;
        task.style = `border-color: ${adjustColor(baseColor, -10)};`;
        task.progressColor = task.progress >= 1 ? "#28A745" : adjustColor(baseColor, 20);
        task.textColor = getContrastColor(baseColor);
        return true;
      });
      gantt.attachEvent("onBeforeLightbox", function(id){
        openCustomLightbox(id);
        return false;
      });
      gantt.attachEvent("onAfterLinkAdd", function(id, link) {
        saveStateToHistory();
        const newLink = { id: crypto.randomUUID(), source: String(link.source), target: String(link.target), type: String(link.type) };
        allLinks.push(newLink);
        gantt.changeLinkId(id, newLink.id);
        showNotification("notification_link_added");
        updateUndoButtonState();
        return true;
      });
      gantt.attachEvent("onAfterLinkDelete", function(id, link) {
        saveStateToHistory();
        allLinks = allLinks.filter(l => String(l.id) !== String(id));
        showNotification("notification_link_removed");
        updateUndoButtonState();
        return true;
      });
      gantt.attachEvent("onAfterTaskDelete", function(id, task) {
        saveStateToHistory();
        rebuildProjectsFromGanttData(); 
        if (String(task.parent) !== "0") {
            recalculateProjectDatesAndProgress(String(task.parent));
        }
        updateGantt();
        showNotification('notification_task_deleted', 'success', {name: (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').trim()});
        updateUndoButtonState();
        return true;
      });
      gantt.attachEvent("onBeforeTaskDrag", function(id, mode, task){
        return !task.readonly;
      });
      gantt.attachEvent("onBeforeTaskResize", function(id, mode, task){
        return !task.readonly;
      });
      gantt.attachEvent("onBeforeTaskAutoSchedule", function(task, start, link, predecessor){
        return !task.readonly;
      });
      gantt.attachEvent("onBeforeTaskDisplay", function(id, task) {
          const taskData = findTaskInProjectsModel(id);
          if (task.type === 'task' && taskData && taskData.memberIds) {
              const visibleMembers = members.filter(m => m.visible).map(m => m.id);
              const isVisible = taskData.memberIds.some(memberId => visibleMembers.includes(memberId));
              return isVisible;
          }
          return true;
      });
      applyTranslations();
    }

    function calculateMemberWorkload() {
        memberWorkload = {};
        const dateToStr = gantt.date.date_to_str("%Y-%m-%d");

        gantt.eachTask(function(task) {
            if (task.type === gantt.config.types.task && gantt.isTaskVisible(task.id) && task.memberIds && task.memberIds.length > 0) {
                for (let d = new Date(task.start_date); d < task.end_date; d.setDate(d.getDate() + 1)) {
                    if (gantt.isWorkTime({ date: d, unit: "day" })) {
                        const dateStr = dateToStr(d);
                        if (!memberWorkload[dateStr]) {
                            memberWorkload[dateStr] = {};
                        }
                        task.memberIds.forEach(memberId => {
                            if (!memberWorkload[dateStr][memberId]) {
                                memberWorkload[dateStr][memberId] = 0;
                            }
                            memberWorkload[dateStr][memberId]++;
                        });
                    }
                }
            }
        });
    }

    function getMemberOverload(memberId) {
        const overloadedDays = [];
        const dateToLocaleStr = gantt.date.date_to_str(getGanttDateFormatForLocale(currentLang));

        for (const date in memberWorkload) {
            if (memberWorkload[date][memberId]) {
                const load = memberWorkload[date][memberId];
                if (load >= 3) {
                    const formattedDate = dateToLocaleStr(gantt.date.str_to_date("%Y-%m-%d")(date));
                    const icon = load >= 4 ? 'üíÄ' : '‚ö†Ô∏è';
                    overloadedDays.push({ date: formattedDate, icon: icon, rawDate: date });
                }
            }
        }
        return overloadedDays;
    }

	function updateGantt() {
		if (!gantt || !gantt.$container) { return; }
		memorizeCollapseState(); 
		isUpdatingGanttProgrammatically = true;
		gantt.clearAll();
		const ganttDataTasks = [];
		const ganttDataLinks = [];
		function flattenTasks(tasks, parentId) {
			tasks.forEach(item => {
				const ganttTask = {
					id: item.id, text: item.name,
					start_date: item.start ? gantt.date.str_to_date(gantt.config.date_format)(item.start) : null,
					end_date: item.end ? gantt.date.str_to_date(gantt.config.date_format)(item.end) : null,
					duration: item.duration, progress: item.progress, parent: item.parent || parentId,
					type: item.type, color: item.color, open: item.open || (item.type === gantt.config.types.project),
                    locked: item.locked || false, readonly: item.locked || false
				};
				ganttTask.memberIds = item.memberIds || [];
				ganttTask.priority = item.priority || (item.type === gantt.config.types.project ? 'low' : 'project');
				ganttTask.comments = item.comments || "";
				ganttTask.project = item.project || "";
				ganttDataTasks.push(ganttTask);
				if (item.tasks && item.tasks.length > 0) {
					flattenTasks(item.tasks, item.id);
				}
			});
		}
		Object.values(projects).forEach(project => {
            if (!project.visible) return;
			ganttDataTasks.push({
				id: project.id, text: project.name,
				start_date: (project.start && (new Date(project.start) instanceof Date) && !isNaN(new Date(project.start))) ? gantt.date.str_to_date(gantt.config.date_format)(project.start) : null,
				end_date: (project.end && (new Date(project.end) instanceof Date) && !isNaN(new Date(project.end))) ? gantt.date.str_to_date(gantt.config.date_format)(project.end) : null,
				duration: project.duration, progress: project.progress, parent: project.parent,
				type: project.type, color: project.color, open: project.open || true,
				memberIds: project.memberIds || [], priority: project.priority, comments: project.comments || "", project: project.name,
                locked: project.locked || false, readonly: project.locked || false
			});
			if (project.tasks && project.tasks.length > 0) {
				flattenTasks(project.tasks, project.id);
			}
		});
		allLinks.forEach(link => {
			ganttDataLinks.push({ id: link.id, source: link.source, target: link.target, type: link.type });
		});

        calculateMemberWorkload();

		gantt.parse({ data: ganttDataTasks, links: ganttDataLinks });
		restoreCollapseState(); 
		gantt.eachTask(function(task) {
			if (task.type === gantt.config.types.project) {
				recalculateProjectDatesAndProgress(task.id);
			}
		});
		gantt.render();
		renderSidebars();
		isUpdatingGanttProgrammatically = false;
	}

    function recalculateProjectDatesAndProgress(taskId) {
        const ganttTask = gantt.getTask(taskId);
        if (!ganttTask || ganttTask.type !== gantt.config.types.project) { return; }

        const taskDataStore = findTaskInProjectsModel(taskId);
        const childTasksInGantt = gantt.getChildren(taskId).map(id => gantt.getTask(id)).filter(Boolean);

        let minStartDate = null;
        let maxEndDate = null;
        let totalProgressSum = 0;
        let totalChildDuration = 0;

        childTasksInGantt.forEach(childGanttTask => {
            if (childGanttTask.start_date instanceof Date && !isNaN(childGanttTask.start_date.getTime())) {
                if (!minStartDate || childGanttTask.start_date < minStartDate) {
                    minStartDate = childGanttTask.start_date;
                }
                const childEndDate = gantt.calculateEndDate({ start_date: childGanttTask.start_date, duration: childGanttTask.duration });
                if (childEndDate instanceof Date && !isNaN(childEndDate.getTime())) {
                    if (!maxEndDate || childEndDate > maxEndDate) {
                        maxEndDate = childEndDate;
                    }
                }
            }
            if (childGanttTask.duration > 0) {
                totalProgressSum += (parseFloat(childGanttTask.progress) || 0) * childGanttTask.duration;
                totalChildDuration += childGanttTask.duration;
            }
        });

        let newStartDate = null;
        let newEndDate = null;
        let newDuration = 0;
        let newProgress = 0;

        if (minStartDate && maxEndDate) {
            newStartDate = minStartDate;
            newEndDate = maxEndDate;
            newDuration = gantt.calculateDuration({ start_date: minStartDate, end_date: maxEndDate });
        } else {
            if (ganttTask.start_date instanceof Date && !isNaN(ganttTask.start_date.getTime())) {
                newStartDate = ganttTask.start_date;
                newDuration = ganttTask.duration || 1; 
                newEndDate = gantt.calculateEndDate({ start_date: newStartDate, duration: newDuration });
            } else {
                newStartDate = new Date(); 
                newDuration = 1; 
                newEndDate = gantt.calculateEndDate({ start_date: newStartDate, duration: newDuration });
            }
        }
        
        newProgress = totalChildDuration > 0 ? (totalProgressSum / totalChildDuration) : 0;

        ganttTask.start_date = newStartDate;
        ganttTask.end_date = newEndDate;
        ganttTask.duration = newDuration;
        ganttTask.progress = newProgress;

        if (taskDataStore) {
            taskDataStore.start = newStartDate ? gantt.date.date_to_str(gantt.config.date_format)(newStartDate) : null;
            taskDataStore.end = newEndDate ? gantt.date.date_to_str(gantt.config.date_format)(newEndDate) : null;
            taskDataStore.duration = Number(newDuration);
            taskDataStore.progress = Number(newProgress);
        }
    }

    function findTaskInProjectsModel(taskId) {
        const targetId = String(taskId);
        for (const projectId in projects) {
            if (String(projects[projectId].id) === targetId) {
                return projects[projectId];
            }
            const searchNested = (tasks) => {
                for (let i = 0; i < tasks.length; i++) {
                    const task = tasks[i];
                    if (String(task.id) === targetId) {
                        return task;
                    }
                    if (task.type === gantt.config.types.project && task.tasks && task.tasks.length > 0) {
                        const foundInNested = searchNested(task.tasks);
                        if (foundInNested) return foundInNested;
                    }
                }
                return null;
            };
            const foundInProjectTasks = searchNested(projects[projectId].tasks || []);
            if (foundInProjectTasks) {
                return foundInProjectTasks;
            }
        }
        return null;
    }

    function renderSidebars() {
      renderMembers();
      renderProjects();
      updateTaskMembers();
      toggleNewTaskFieldsVisibility();
    }

    function populateProjectDropdown(selectElementId, selectedParentId = '', currentEditingId = null, includeAllSummaryTasks = false, allowNoParent = true) {
        const parentSelect = document.getElementById(selectElementId);
        if (!parentSelect) return;
        parentSelect.innerHTML = '';
        if (allowNoParent) {
            const noParentOption = document.createElement('option');
            noParentOption.value = "";
            noParentOption.textContent = translate('no_parent');
            parentSelect.appendChild(noParentOption);
        }
        if (includeAllSummaryTasks) {
            gantt.eachTask((task) => {
                const isSelectableParent = task.type === gantt.config.types.project && String(task.id) !== String(currentEditingId);
                if (isSelectableParent) {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim();
                    if (String(task.id) === String(selectedParentId)) {
                        option.selected = true;
                    }
                    parentSelect.appendChild(option);
                }
            });
        } else {
            Object.values(projects).forEach(project => {
                if (String(project.id) !== String(currentEditingId) && String(project.parent) === "0") {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = (project.name || '').replace(/^[ÔøΩüü°ÔøΩ]\s*/, '').replace(/\s+\(.*?\)$/, '').trim();
                    if (String(project.id) === String(selectedParentId)) {
                        option.selected = true;
                    }
                    parentSelect.appendChild(option);
                }
            });
        }
    }

    function rebuildProjectsFromGanttData() {
        if (!gantt || !gantt.eachTask) { return; }
        const newProjects = {};
        const ganttTasksById = new Map();
        gantt.eachTask(task => {
            ganttTasksById.set(String(task.id), task);
        });
        const oldPropertiesById = new Map();
        function collectOldProperties(items) {
            items.forEach(item => {
                oldPropertiesById.set(String(item.id), item);
                if (item.tasks && Array.isArray(item.tasks)) {
                    collectOldProperties(item.tasks);
                }
            });
        }
        Object.values(projects).forEach(proj => {
            oldPropertiesById.set(String(proj.id), proj);
            collectOldProperties(proj.tasks || []);
        });
        function buildHierarchyFromGantt(parentId) {
            const childrenInGantt = gantt.getChildren(parentId);
            const nestedItems = [];
            childrenInGantt.forEach(childId => {
                const ganttTask = ganttTasksById.get(String(childId));
                if (!ganttTask) return;
                const oldProps = oldPropertiesById.get(String(ganttTask.id)) || {};
                const startDate = (ganttTask.start_date instanceof Date && !isNaN(ganttTask.start_date.getTime())) 
                                  ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.start_date) : null;
                const endDate = (ganttTask.end_date instanceof Date && !isNaN(ganttTask.end_date.getTime()))
                                ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.end_date) : null;
                const itemData = {
                    id: String(ganttTask.id),
                    name: (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim(),
                    start: startDate, end: endDate, duration: ganttTask.duration || 0,
                    progress: ganttTask.progress || 0, parent: String(ganttTask.parent), type: ganttTask.type,
                    color: ganttTask.color || oldProps.color || "#5cb85c",
                    memberIds: ganttTask.hasOwnProperty('memberIds') ? ganttTask.memberIds : (oldProps.memberIds || []),
                    priority: ganttTask.priority || oldProps.priority || (ganttTask.type === gantt.config.types.project ? 'low' : 'project'),
                    comments: ganttTask.comments || oldProps.comments || "",
                    project: (ganttTask.parent === "0" && ganttTask.type === gantt.config.types.project) ? itemData.name : oldProps.project || "",
                    locked: ganttTask.locked || oldProps.locked || false
                };
                if (ganttTask.type === gantt.config.types.project) {
                    itemData.tasks = buildHierarchyFromGantt(ganttTask.id);
                    if (String(ganttTask.parent) === "0") {
                        itemData.description = oldProps.description || "";
                        itemData.deadline = oldProps.deadline || "";
                        itemData.visible = (typeof oldProps.visible !== 'undefined') ? oldProps.visible : true;
                    }
                }
                nestedItems.push(itemData);
            });
            return nestedItems;
        }
        gantt.eachTask(function(ganttTask) {
            if (String(ganttTask.parent) === "0" && ganttTask.type === gantt.config.types.project) {
                const projectId = String(ganttTask.id);
                const oldProps = oldPropertiesById.get(projectId) || {};
                const projectStartDate = (ganttTask.start_date instanceof Date && !isNaN(ganttTask.start_date.getTime()))
                                       ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.start_date) : null;
                const projectEndDate = (ganttTask.end_date instanceof Date && !isNaN(ganttTask.end_date.getTime()))
                                     ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.end_date) : null;
                newProjects[projectId] = {
                    id: projectId, name: (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim(),
                    description: oldProps.description || "", deadline: oldProps.deadline || "",
                    priority: oldProps.priority || "medium", color: oldProps.color || "#8E44AD",
                    visible: (typeof oldProps.visible !== 'undefined') ? oldProps.visible : true,
                    start: projectStartDate, end: projectEndDate, duration: ganttTask.duration || 0,
                    progress: ganttTask.progress || 0, type: gantt.config.types.project, parent: "0",
                    tasks: buildHierarchyFromGantt(ganttTask.id),
                    locked: ganttTask.locked || oldProps.locked || false
                };
            }
        });
        projects = newProjects;
    }

    function calculateSummaryProgress(tasks) {
      if (!tasks || tasks.length === 0) return 0;
      const totalProgress = tasks.reduce((sum, task) => sum + (parseFloat(task.progress) || 0), 0);
      return totalProgress / tasks.length;
    }

    function manualRecalculate(isInternalCall = false) {
        if (!isInternalCall) saveStateToHistory();
        try {
            gantt.batchUpdate(() => {
                let changed = true;
                let iterations = 0;
                const maxIterations = gantt.getTaskCount() + 5;
                while (changed && iterations < maxIterations) {
                    changed = false;
                    iterations++;
                    gantt.eachTask(function(task) {
                        if(task.readonly) return; // Ne pas recalculer les t√¢ches verrouill√©es
                        const predecessors = gantt.getLinks().filter(l => String(l.target) === String(task.id));
                        if (predecessors.length > 0) {
                            let maxEndDate = null;
                            predecessors.forEach(link => {
                                const predecessorTask = gantt.getTask(link.source);
                                if (predecessorTask) {
                                    const predecessorEndDate = gantt.calculateEndDate(predecessorTask);
                                    if (!maxEndDate || predecessorEndDate > maxEndDate) {
                                        maxEndDate = predecessorEndDate;
                                    }
                                }
                            });
                            if (maxEndDate) {
                                let newStartDate = gantt.getClosestWorkTime({ date: maxEndDate, dir: "future" });
                                if (task.start_date.getTime() !== newStartDate.getTime()) {
                                    task.start_date = newStartDate;
                                    task.end_date = gantt.calculateEndDate(task);
                                    gantt.updateTask(task.id);
                                    changed = true;
                                }
                            }
                        }
                    });
                }
                if (iterations >= maxIterations) {
                    console.error("Recalculation exceeded max iterations, possible circular dependency in links.");
                }
            });
            updateGantt();
            if (!isInternalCall) {
                showNotification("notification_recalculated", 'success');
                updateUndoButtonState();
            }
        } catch (e) {
            console.error("Erreur lors du recalcul manuel:", e);
            showNotification("notification_recalculation_error", 'error');
        }
    }

    function exportGanttToPNG() {
        if (!gantt) return;
        let minDate = null;
        let maxDate = null;
        gantt.eachTask(function(task) {
            if (task.start_date instanceof Date && !isNaN(task.start_date.getTime())) {
                if (!minDate || task.start_date < minDate) {
                    minDate = new Date(task.start_date);
                }
            }
            if (task.end_date instanceof Date && !isNaN(task.end_date.getTime())) {
                if (!maxDate || task.end_date > maxDate) {
                    maxDate = new Date(task.end_date);
                }
            }
        });
        if (!minDate || !maxDate) {
            showNotification("notification_no_tasks_to_export", 'error');
            return;
        }
        const startDate = gantt.date.add(minDate, -1, "day");
        const endDate = gantt.date.add(maxDate, 1, "day");
        const styles = `
            <style>
                body { font-family: 'Segoe UI', sans-serif; }
                .gantt_task_cell.weekend { background-color: #f0f0f0 !important; }
                .member-indicator { width: 14px; height: 14px; display: inline-block; border-radius: 50%; margin-right: 5px; vertical-align: middle; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
                .gantt_grid_data .gantt_cell[data-column-name=members] { text-align: center; }
                .gantt_task_line { border-radius: 4px !important; }
                .gantt_task_progress { border-radius: 4px !important; }
                .priority-low { background-color: #d4edda !important; }
                .priority-medium { background-color: #fff3cd !important; }
                .priority-high { background-color: #f8d7da !important; }
            </style>
        `;
        gantt.exportToPNG({ name: "gantt_diagram.png", raw: true, header: styles, start_date: startDate, end_date: endDate });
        showNotification("notification_png_exported");
    }

    function confirmClearAllData() {
        if (confirm(translate('clear_all_data_confirm'))) {
            clearAllData();
        }
    }

    function clearAllData() {
        saveStateToHistory();
        members = [];
        projects = {};
        allLinks = [];
        gantt.clearAll();
        renderMembers();
        renderProjects();
        updateTaskMembers();
        toggleNewTaskFieldsVisibility();
        showNotification('notification_all_data_cleared', 'success');
        updateUndoButtonState();
    }

    function initDummyData() {
      // Donn√©es de test supprim√©es
      members = [];
      projects = {};
      allLinks = [];
    }
  
    function toggleTaskLock(taskId) {
        saveStateToHistory();
        const task = gantt.getTask(taskId);
        if (task) {
            task.locked = !task.locked;
            task.readonly = task.locked;
            let taskDataStore = findTaskInProjectsModel(taskId);
            if(taskDataStore) {
                taskDataStore.locked = task.locked;
            }
            gantt.updateTask(task.id);
        }
        updateUndoButtonState();
    }

    function highlightOverloadDay(memberId, dateStr) {
        // Clear previous highlights by resetting the info object
        highlightedInfo.taskIds = [];
        highlightedInfo.level = '';

        if (dateStr) {
            const load = memberWorkload[dateStr]?.[memberId];
            if (load) {
                highlightedInfo.level = load >= 4 ? 'overload-highlight-error' : 'overload-highlight-warning';
                
                const stringMemberId = String(memberId);
                const checkDateStr = dateStr;

                gantt.eachTask(function(task) {
                    if (task.type === gantt.config.types.task && Array.isArray(task.memberIds) && task.memberIds.map(String).includes(stringMemberId)) {
                        const dateToStr = gantt.date.date_to_str("%Y-%m-%d");
                        for (let d = new Date(task.start_date); d < task.end_date; d.setDate(d.getDate() + 1)) {
                            if (gantt.isWorkTime({ date: d, unit: "day" })) {
                                const currentDayStr = dateToStr(d);
                                if (currentDayStr === checkDateStr) {
                                    highlightedInfo.taskIds.push(task.id);
                                    break; 
                                }
                            }
                        }
                    }
                });
            }
        }
        gantt.render();
    }


	let collapsedStateMap = {};
	gantt.attachEvent("onTaskOpened", function (taskId) {
	  collapsedStateMap[taskId] = false;
	  return true;
	});
	gantt.attachEvent("onTaskClosed", function (taskId) {
	  collapsedStateMap[taskId] = true;
	  return true;
	});
	function memorizeCollapseState() {
	  collapsedStateMap = {};
	  gantt.eachTask(function (task) {
		if (task.type === "project" || task.type === "task") {
		  collapsedStateMap[task.id] = !task.$open;
		}
	  });
	}
	function restoreCollapseState() {
	  for (const taskId in collapsedStateMap) {
		if (gantt.isTaskExists(taskId)) {
		  if (collapsedStateMap[taskId]) {
			gantt.close(taskId);
		  } else {
			gantt.open(taskId);
		  }
		}
	  }
	}
	gantt.attachEvent("onBeforeTaskDrag", function() {
	  memorizeCollapseState();
	  return true;
    });

    function saveStateToHistory() {
        const currentState = {
            members: JSON.parse(JSON.stringify(members)),
            projects: JSON.parse(JSON.stringify(projects)),
            allLinks: JSON.parse(JSON.stringify(allLinks)),
            currentLang: currentLang
        };
        historyStack.push(currentState);
        if (historyStack.length > MAX_HISTORY_SIZE) {
            historyStack.shift();
        }
        updateUndoButtonState();
    }

    function undoLastAction() {
        if (historyStack.length > 1) {
            historyStack.pop();
            const previousState = historyStack[historyStack.length - 1];
            members = JSON.parse(JSON.stringify(previousState.members));
            projects = JSON.parse(JSON.stringify(previousState.projects));
            allLinks = JSON.parse(JSON.stringify(previousState.allLinks));
            currentLang = previousState.currentLang;
            setLanguage(currentLang);
            renderMembers();
            renderProjects();
            updateTaskMembers();
            updateGantt();
            showNotification('Action annul√©e.');
        } else {
            showNotification('Impossible d\'annuler davantage.', 'error');
        }
        updateUndoButtonState();
    }

    function updateUndoButtonState() {
        const undoButton = document.getElementById('undoButton');
        if (undoButton) {
            undoButton.disabled = historyStack.length <= 1; 
        }
    }
function saveCustomLightboxChanges() {
  const taskId = document.getElementById("customLightboxTaskId").value;
  const task = gantt.getTask(taskId);
  if (!task) return;

  const name = document.getElementById("customLightboxTaskName").value;
  const type = document.getElementById("customLightboxTaskType").value;
  const parent = document.getElementById("customLightboxTaskParent").value;

  const priority = document.getElementById("customLightboxTaskPriority").value;
  const progress = parseFloat(document.getElementById("customLightboxTaskProgress").value);
  const color = document.getElementById("customLightboxTaskColor").value;
  const comments = document.getElementById("customLightboxTaskComments").value;
  const duration = parseInt(document.getElementById("customLightboxTaskDuration").value);

  const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
  const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');
  const startDate = startPicker?.selectedDates?.[0] || null;
  const endDate = endPicker?.selectedDates?.[0] || null;

  let realStart = startDate;
  let realEnd = endDate;
  let realDuration = duration;

  if (realDuration > 0 && realStart && !realEnd) {
    realEnd = gantt.calculateEndDate({ start_date: realStart, duration: realDuration });
  } else if (realDuration > 0 && realEnd && !realStart) {
    realStart = gantt.calculateStartDate({ end_date: realEnd, duration: realDuration });
  } else if (!realDuration && realStart && realEnd) {
    realDuration = gantt.calculateDuration({ start_date: realStart, end_date: realEnd });
  }

  if (!realStart || !realEnd || !realDuration || realDuration <= 0) {
    showNotification("notification_fill_all_fields", "error");
    return;
  }

  task.text = name;
  task.name = name;
  task.parent = parent;
  task.type = type;
  task.priority = priority;
  task.progress = progress;
  task.color = color;
  task.comments = comments;
  task.start_date = realStart;
  task.end_date = realEnd;
  task.duration = realDuration;

  gantt.updateTask(task.id);
  closeCustomLightbox();
  showNotification("notification_task_updated", "success", { name });
  updateUndoButtonState();
}
</script>
</body>
</html>
