<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion de Projet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.dhtmlx.com/gantt/8.0/dhtmlxgantt.js"></script>
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/8.0/dhtmlxgantt.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
    }
    .sidebar {
      width: 380px;
      min-width: 380px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      transition: min-width 0.35s ease, width 0.35s ease, padding 0.35s ease, opacity 0.35s ease;
    }
    .sidebar.collapsed {
        width: 0;
        min-width: 0;
        padding-left: 0;
        padding-right: 0;
        opacity: 0;
    }
    .main {
      flex-grow: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      transition: padding 0.35s ease;
    }
    .gantt-container {
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 10px;
      height: 100%;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      display: flex;
      flex-direction: column;
    }
    .notification-stack {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1055;
    }
    .notification {
      position: relative;
      padding: 15px 25px;
      border-radius: 50px;
      color: white;
      background: linear-gradient(45deg, #56ab2f, #a8e6cf);
      animation: slideInOut 4s ease forwards;
    }
    .notification.error {
      background: linear-gradient(45deg, #ff416c, #ff4b2b);
    }
    @keyframes slideInOut {
      0% { opacity: 0; transform: translateX(100px); }
      15% { opacity: 1; transform: translateX(0); }
      85% { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(100px); }
    }
    .btn, .form-control, .form-select, .card, .accordion-button, .modal-content {
      border-radius: 15px;
    }
    #gantt_here {
      width: 100%;
      height: 100%;
      border-radius: 15px;
      flex-grow: 1;
    }
    .task-item {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 8px;
      border-left: 4px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .task-item:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateX(5px);
    }
    .member-indicator {
      width: 16px;
      height: 16px;
      display: inline-block;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .gantt_task_line {
      border-radius: 4px;
      border: 1px solid;
    }
    .gantt_task_progress {
      border-radius: 4px;
      opacity: 1;
    }
    .gantt_task_content {
      color: #333;
    }
    .gantt_task_cell.weekend {
      background-color: #f0f0f0 !important;
    }
    .gantt-controls {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 10px;
      flex-shrink: 0;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      gap: 8px;
    }
    .gantt-controls .btn {
      white-space: nowrap;
      margin-right: 0px !important;
    }
    .gantt_grid_data .gantt_cell[role=gridcell][data-column-name=members] {
      cursor: pointer;
    }
    .gantt_grid_data .gantt_cell[role=gridcell][data-column-name=members]:hover {
      background-color: #e9ecef;
    }
    .gantt_grid_resizer {
        position: absolute;
        top: 0;
        right: -1px;
        width: 5px;
        height: 100%;
        cursor: col-resize !important;
        z-index: 10;
        background-color: transparent;
        transition: background-color 0.2s;
    }
    .gantt_grid_resizer:hover {
        background-color: rgba(0, 123, 255, 0.5);
    }
    .priority-low { background-color: #d4edda !important; }
    .priority-medium { background-color: #fff3cd !important; }
    .priority-high { background-color: #f8d7da !important; }
    .language-selector { margin-bottom: 10px; text-align: center; }
    .language-selector button { margin: 0 3px; padding: 5px 8px; font-size: 0.9em; }
    .sidebar-content { flex-grow: 1; overflow-y: auto; }
    .custom-lightbox-members-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        padding: 10px;
        border-radius: 0.375rem;
        background-color: #fff;
    }
    .mb-3 { margin-bottom: 0.75rem !important; }
    .mb-2 { margin-bottom: 0.4rem !important; }
    #summaryTaskNote {
        font-size: 0.85em;
        color: #6c757d;
        margin-top: 5px;
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="language-selector">
      <button class="btn btn-sm btn-light" onclick="setLanguage('fr')">FR</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('en')">EN</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('es')">ES</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('de')">DE</button>
      <button class="btn btn-sm btn-light" onclick="setLanguage('it')">IT</button>
    </div>
    <div class="mb-3">
      <button class="btn btn-primary w-100 mb-2" onclick="exportToJSON()" data-translate-key="export">üíæ Exporter</button>
      <input type="file" id="importJSON" name="importJSON" accept=".json" style="display: none;" onchange="importFromJSON(event)">
      <button class="btn btn-secondary w-100 mb-2" onclick="document.getElementById('importJSON').click()" data-translate-key="import">üìÇ Importer</button>
      <button class="btn btn-danger w-100 mb-2" onclick="confirmClearAllData()" data-translate-key="clear_all_data_btn">üóëÔ∏è Vider tout</button>
      <!-- Le bouton "Charger donn√©es exemple" a √©t√© supprim√© -->
    </div>
    <div class="sidebar-content">
      <div class="accordion" id="sidebarAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#membersCollapse" data-translate-key="members_section_title">
              üë• Membres
            </button>
          </h2>
          <div id="membersCollapse" class="accordion-collapse collapse show" data-bs-parent="#sidebarAccordion">
            <div class="accordion-body">
              <input id="editMemberId" name="editMemberId" type="hidden" value="">
              <label for="memberName"></label><input id="memberName" name="memberName" class="form-control mb-2" data-translate-placeholder-key="member_name_placeholder">
              <label for="memberColor"></label><input type="color" id="memberColor" name="memberColor" class="form-control mb-2" value="#667eea">
              <button id="memberActionBtn" class="btn btn-primary w-100" onclick="addOrUpdateMember()" data-translate-key="add_member_btn">Ajouter Membre</button>
              <div id="membersList" class="mt-3"></div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#projectCollapse" data-translate-key="projects_section_title">
              üìÅ Projets
            </button>
          </h2>
          <div id="projectCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
            <div class="accordion-body">
              <label for="projectName"></label><input id="projectName" name="projectName" class="form-control mb-2" data-translate-placeholder-key="project_name_placeholder">
              <label for="projectDescription"></label><textarea id="projectDescription" name="projectDescription" class="form-control mb-2" data-translate-placeholder-key="project_description_placeholder" rows="2"></textarea>
              <label for="projectDeadline"></label><input type="text" id="projectDeadline" name="projectDeadline" class="form-control mb-2">
              <label for="projectPriority"></label><select id="projectPriority" name="projectPriority" class="form-select mb-2">
                <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
              </select>
              <label for="projectColor"></label><input type="color" id="projectColor" name="projectColor" class="form-control mb-2" value="#28a745">
              <button class="btn btn-success w-100" onclick="addProject()" data-translate-key="create_project_btn">Cr√©er Projet</button>
              <div id="projectList"></div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#taskCollapse" data-translate-key="new_task_section_title">
              ‚úÖ Nouvelle T√¢che
            </button>
          </h2>
          <div id="taskCollapse" class="accordion-collapse collapse" data-bs-parent="#sidebarAccordion">
            <div class="accordion-body">
              <div class="mb-3">
                  <label for="taskType" class="form-label" data-translate-key="task_type_label">Type de t√¢che</label>
                  <select id="taskType" name="taskType" class="form-select mb-2" onchange="toggleNewTaskFieldsVisibility()">
                      <option value="task" data-translate-key="task_type_normal">T√¢che normale</option>
                      <option value="project" data-translate-key="task_type_mother">T√¢che m√®re (Nouveau Groupe)</option>
                  </select>
                  <p id="summaryTaskNote" style="display: none;" data-translate-key="mother_task_creation_note"></p>
              </div>

              <label for="taskName"></label><input id="taskName" name="taskName" class="form-control mb-2" data-translate-placeholder-key="task_name_placeholder">
              
              <!-- Moved outside normalTaskFields -->
              <div class="mb-3">
                <label for="taskProject" class="form-label" data-translate-key="task_parent">Parent de la t√¢che</label>
                <select id="taskProject" name="taskProject" class="form-select">
                  <option value="" data-translate-key="select_project_option">S√©lectionner un projet</option>
                </select>
              </div>

              <div id="normalTaskFields">
                  <label for="taskStart"></label><input type="text" id="taskStart" name="taskStart" class="form-control mb-2" data-translate-placeholder-key="task_start_placeholder">
                  <label for="taskEnd"></label><input type="text" id="taskEnd" name="taskEnd" class="form-control mb-2" data-translate-placeholder-key="task_end_placeholder">
                  <label for="taskDuration"></label><input type="number" id="taskDuration" name="taskDuration" class="form-control mb-2" data-translate-placeholder-key="task_duration_placeholder">
                  <label for="taskProgress"></label><select id="taskProgress" name="taskProgress" class="form-select mb-2">
                    <option value="0">0%</option> <option value="0.1">10%</option> <option value="0.25">25%</option>
                    <option value="0.5">50%</option> <option value="0.75">75%</option> <option value="0.9">90%</option>
                    <option value="1">100%</option>
                  </select>
                  <label for="taskPriority"></label><select id="taskPriority" name="taskPriority" class="form-select mb-2">
                    <option value="project" data-translate-key="task_priority_project">Par d√©faut (Projet)</option>
                    <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                    <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                    <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
                  </select>
                  <label class="form-label" data-translate-key="assigned_members_label">Membres assign√©s :</label>
                  <div id="taskMembers" class="mb-2" style="max-height: 120px; overflow-y: auto; border: 1px solid #e9ecef; padding: 10px; border-radius: 10px;"></div>
              </div>
              <div id="summaryTaskFields" style="display: none;">
              </div>

              <button class="btn btn-warning w-100" onclick="addTask()" data-translate-key="add_task_btn">Ajouter T√¢che</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="gantt-container">
      <div class="gantt-controls">
        <button id="toggleSidebarBtn" class="btn btn-outline-secondary" onclick="toggleSidebar()"></button>
        <button id="toggleGridBtn" class="btn btn-outline-info" onclick="toggleGanttGrid()"></button>
        <button class="btn btn-outline-primary" onclick="ganttZoomIn()">üîç+</button>
        <button class="btn btn-outline-primary" onclick="ganttZoomOut()">üîç-</button>
        <button class="btn btn-outline-info" onclick="manualRecalculate()" data-translate-key="recalculate_btn">üîÑ Recalculer</button>
        <button class="btn btn-outline-success" onclick="exportGanttToPNG()" data-translate-key="export_png_btn">üñºÔ∏è PNG</button>
        <!-- Nouveau bouton Annuler -->
        <button class="btn btn-outline-warning" onclick="undoLastAction()" data-translate-key="undo_btn" id="undoButton" disabled>‚Ü© Annuler</button>
      </div>
      <div id="gantt_here"></div>
    </div>
  </div>

  <div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProjectModalLabel" data-translate-key="edit_project_modal_title">Modifier Projet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="editProjectName"></label><input type="text" id="editProjectName" name="editProjectName" class="form-control mb-2" data-translate-placeholder-key="project_name_placeholder">
          <label for="editProjectDescription"></label><textarea id="editProjectDescription" name="editProjectDescription" class="form-control mb-2" data-translate-placeholder-key="project_description_placeholder" rows="2"></textarea>
          <label for="editProjectDeadline"></label><input type="text" id="editProjectDeadline" name="editProjectDeadline" class="form-control mb-2">
          <label for="editProjectPriority"></label><select id="editProjectPriority" name="editProjectPriority" class="form-select mb-2">
            <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
            <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
            <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
          </select>
          <label for="editProjectColor"></label><input type="color" id="editProjectColor" name="editProjectColor" class="form-control mb-2">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate-key="cancel_btn">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveProjectEdit()" data-translate-key="save_btn">Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editTaskMembersModal" tabindex="-1" aria-labelledby="editTaskMembersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editTaskMembersModalLabel" data-translate-key="manage_task_members_modal_title_prefix">G√©rer les membres de la t√¢che</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editTaskId" name="editTaskId">
          <label class="form-label" data-translate-key="assigned_members_label">Membres assign√©s :</label>
          <div id="editTaskMembersList" class="mb-2" style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; padding: 10px; border-radius: 10px;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close"></button>
          <button type="button" class="btn btn-primary" onclick="saveTaskMembers()" data-translate-key="save_btn">Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customTaskModal" tabindex="-1" aria-labelledby="customTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customTaskModalLabel" data-translate-key="custom_lightbox_title">Modifier la T√¢che</h5>
          <button type="button" class="btn-close" onclick="closeCustomLightbox()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="customLightboxTaskId" name="customLightboxTaskId">
          <div class="mb-3">
            <label for="customLightboxTaskName" class="form-label" data-translate-key="custom_lightbox_task_name_label">Nom de la t√¢che</label>
            <input type="text" class="form-control" id="customLightboxTaskName" name="customLightboxTaskName" data-translate-placeholder-key="task_name_placeholder">
          </div>

          <div class="mb-3">
              <label for="customLightboxTaskType" class="form-label" data-translate-key="task_type_label">Type de t√¢che</label>
              <select id="customLightboxTaskType" name="customLightboxTaskType" class="form-select mb-2" onchange="toggleCustomLightboxFieldsVisibility()">
                  <option value="task" data-translate-key="task_type_normal">T√¢che normale</option>
                  <option value="project" data-translate-key="task_type_mother">T√¢che m√®re (Groupe)</option>
              </select>
          </div>

          <div class="mb-3">
              <label for="customLightboxTaskParent" class="form-label" data-translate-key="task_parent">Parent de la t√¢che</label>
              <select class="form-select" id="customLightboxTaskParent">
                <option value="" data-translate-key="no_parent">Pas de parent</option>
              </select>
            </div>

          <div id="customLightboxNormalTaskFields">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="customLightboxTaskPriority" class="form-label" data-translate-key="custom_lightbox_task_priority_label">Priorit√©</label>
                  <select id="customLightboxTaskPriority" name="customLightboxTaskPriority" class="form-select">
                    <option value="project" data-translate-key="task_priority_project">Par d√©faut (Projet)</option>
                    <option value="low" data-translate-key="priority_low">üü¢ Basse</option>
                    <option value="medium" data-translate-key="priority_medium">üü° Moyenne</option>
                    <option value="high" data-translate-key="priority_high">üî¥ Haute</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="customLightboxTaskProgress" class="form-label" data-translate-key="custom_lightbox_task_progress_label">Avancement</label>
                  <select id="customLightboxTaskProgress" name="customLightboxTaskProgress" class="form-select">
                    <option value="0">0%</option>
                    <option value="0.1">10%</option>
                    <option value="0.2">20%</option>
                    <option value="0.25">25%</option>
                    <option value="0.3">30%</option>
                    <option value="0.4">40%</option>
                    <option value="0.5">50%</option>
                    <option value="0.6">60%</option>
                    <option value="0.7">70%</option>
                    <option value="0.75">75%</option>
                    <option value="0.8">80%</option>
                    <option value="0.9">90%</option>
                    <option value="1">100%</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="customLightboxTaskStart" class="form-label" data-translate-key="custom_lightbox_task_start_label">Date de d√©but</label>
                  <input type="text" class="form-control" id="customLightboxTaskStart" name="customLightboxTaskStart">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="customLightboxTaskEnd" class="form-label" data-translate-key="custom_lightbox_task_end_label">Date de fin</label>
                  <input type="text" class="form-control" id="customLightboxTaskEnd" name="customLightboxTaskEnd">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="customLightboxTaskDuration" class="form-label" data-translate-key="custom_lightbox_task_duration_label">Dur√©e (jours)</label>
                  <input type="number" class="form-control" id="customLightboxTaskDuration" name="customLightboxTaskDuration" min="0" data-translate-placeholder-key="task_duration_placeholder">
                </div>
              </div>

              <div class="mb-3">
                <label for="customLightboxTaskColor" class="form-label" data-translate-key="custom_lightbox_task_color_label">Couleur de la t√¢che</label>
                <input type="color" class="form-control form-control-color" id="customLightboxTaskColor" name="customLightboxTaskColor" value="#5cb85c">
              </div>

              <div class="mb-3">
                <label class="form-label" data-translate-key="assigned_members_label">Membres assign√©s :</label>
                <div id="customLightboxTaskMembers" class="custom-lightbox-members-list"></div>
              </div>

              <div class="mb-3">
                <label for="customLightboxTaskComments" class="form-label" data-translate-key="custom_lightbox_task_comments_label">Commentaires</label>
                <textarea class="form-control" id="customLightboxTaskComments" name="customLightboxTaskComments" rows="3" data-translate-placeholder-key="task_comments_placeholder"></textarea>
              </div>
          </div>
          <div id="customLightboxSummaryTaskFields" style="display: none;">
              <p class="text-muted" data-translate-key="mother_task_note"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger me-auto" onclick="deleteTaskFromCustomLightbox()" data-translate-key="delete_btn">Supprimer</button>
          <button type="button" class="btn btn-secondary" onclick="closeCustomLightbox()" data-translate-key="cancel_btn">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveCustomLightboxChanges()" data-translate-key="save_btn">Sauvegarder</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="dragConfirmationModal" tabindex="-1" aria-labelledby="dragConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dragConfirmationModalLabel" data-translate-key="drag_confirm_title">Confirmer l'action de glisser-d√©poser</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p data-translate-key="drag_confirm_question">Que souhaitez-vous faire avec la t√¢che s√©lectionn√©e ?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate-key="cancel_btn">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="confirmMakeChild()" data-translate-key="drag_confirm_make_child">Faire une sous-t√¢che</button>
          <button type="button" class="btn btn-info" onclick="confirmPlaceBelow()" data-translate-key="drag_confirm_place_below">Placer en dessous</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/de.js"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/it.js"></script>
  <script>
    // Script Version 2.37 - Correction de la fonctionnalit√© Annuler pour les glisser-d√©poser.
    // - Suppression de l'appel pr√©matur√© √† saveStateToHistory() dans onBeforeRowDragIn.
    // - Ajout de saveStateToHistory() au d√©but de onRowDragEnd pour garantir la sauvegarde apr√®s un glisser-d√©poser.

    document.addEventListener('DOMContentLoaded', function () {
        // Configuration de Gantt
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.xml_date = "%Y-%m-%d";

        // Initialisation de Gantt
        initGantt();

        // Appel √† initDummyData() et updateGantt() apr√®s l'initialisation compl√®te
        initDummyData(); // Initialisation des donn√©es d'exemple
        saveStateToHistory(); // Sauvegarder l'√©tat initial
        setLanguage(currentLang); // Appliquer les traductions apr√®s le chargement des donn√©es
        updateGantt(); // Charger et afficher les donn√©es dans Gantt apr√®s l'initialisation compl√®te
    });

    // Variables globales
    let members = [];
    let projects = {}; // projects est un dictionnaire o√π les cl√©s sont les IDs des projets de NIVEAU SUP√âRIEUR
    let allLinks = [];
    // Les compteurs sont maintenus pour la compatibilit√© avec l'import/export de l'ancien format,
    // mais les nouveaux IDs sont g√©n√©r√©s par crypto.randomUUID().
    let taskIdCounter = 1; 
    let memberIdCounter = 1;
    let linkIdCounter = 1;
    let projectNameToEdit = null; // Ceci est l'ID du projet en cours d'√©dition, non le nom
    let currentLang = 'fr';
    let customTaskModalInstance = null;
    let currentEditingTaskId = null;
    let elementToFocusOnModalClose = null;
    let datePickers = [];
    let isSidebarCollapsed = false;
    let isGridVisible = true;
    let isUpdatingGanttProgrammatically = false;

    // Variables globales pour le contexte du modal de glisser-d√©poser
    let tempDraggedTaskId = null;
    let tempTargetNodeId = null;
    let tempTargetIndex = null;
    let tempOldParentId = null;

    // --- Variables pour la fonctionnalit√© Annuler ---
    const historyStack = [];
    const MAX_HISTORY_SIZE = 10; // Limite le nombre d'√©tats √† conserver
    // --- Fin des variables pour la fonctionnalit√© Annuler ---


    // --- ZOOM Levels configuration ---
    const zoomLevels = [
        { 
            name: "day", 
            scale_unit: "day", 
            date_scale: "%d %M", 
            subscales: [{ unit: "hour", step: 6, date: "%Hh" }],
            min_column_width: 30
        },
        { 
            name: "week", 
            scale_unit: "week", 
            date_scale: "%W", // Changed to simple format string
            subscales: [{ unit: "day", step: 1, date: "%D", css: weekendCss }],
            min_column_width: 70
        },
        { 
            name: "month", 
            scale_unit: "month", 
            date_scale: "%F %Y", 
            subscales: [{ unit: "day", step: 1, date: "%D", css: weekendCss }],
            min_column_width: 100
        },
        { 
            name: "quarter", 
            scale_unit: "quarter", 
            date_scale: "%M", // Use month format, custom display in template
            subscales: [{ unit: "month", step: 1, date: "%M" }],
            min_column_width: 90
        },
        { 
            name: "year", 
            scale_unit: "year", 
            date_scale: "%Y", 
            subscales: [{ unit: "month", step: 3, date: "%M" }],
            min_column_width: 50
        }
    ];

    let currentZoomLevelIndex = 2; // Default to 'month' view

    function applyZoom(levelIndex) {
        if (levelIndex >= 0 && levelIndex < zoomLevels.length) {
            currentZoomLevelIndex = levelIndex;
            const newZoom = zoomLevels[currentZoomLevelIndex];
            gantt.config.scale_unit = newZoom.scale_unit;
            gantt.config.date_scale = newZoom.date_scale;
            gantt.config.subscales = newZoom.subscales;
            gantt.config.min_column_width = newZoom.min_column_width; // Apply min_column_width from zoom level
            gantt.render();
        }
    }

    function ganttZoomIn() {
        if (currentZoomLevelIndex > 0) {
            applyZoom(currentZoomLevelIndex - 1);
        }
    }

    function ganttZoomOut() {
        if (currentZoomLevelIndex < zoomLevels.length - 1) {
            applyZoom(currentZoomLevelIndex + 1);
        }
    }
    // --- End ZOOM Levels configuration ---

    // Traductions
    const translations = {
    fr: {
        export: "üíæ Exporter",
        import: "üìÇ Importer",
        clear_all_data_btn: "üóëÔ∏è Vider tout",
        clear_all_data_confirm: "√ätes-vous s√ªr de vouloir vider TOUTES les donn√©es (membres, projets, t√¢ches, liens) ? Cette action est irr√©versible.",
        notification_all_data_cleared: "‚úÖ Toutes les donn√©es ont √©t√© effac√©es.",
        load_example_data_btn: "‚ûï Charger donn√©es exemple",
        members_section_title: "üë• Membres",
        member_name_placeholder: "Nom du membre",
        add_member_btn: "Ajouter Membre",
        edit_member_btn: "Modifier Membre",
        projects_section_title: "üìÅ Projets",
        project_name_placeholder: "Nom du projet",
        project_description_placeholder: "Description",
        priority_low: "üü¢ Basse",
        priority_medium: "üü° Moyenne",
        priority_high: "üî¥ Haute",
        create_project_btn: "Cr√©er Projet",
        new_task_section_title: "‚úÖ Nouvelle T√¢che",
        select_project_option: "S√©lectionner un projet",
        task_parent: "Parent de la t√¢che",
        no_parent: "Pas de parent",
        task_name_placeholder: "Nom de la t√¢che",
        task_end_placeholder: "Date de fin",
        task_duration_placeholder: "Dur√©e (jours ouvr√©s)",
        assigned_members_label: "Membres assign√©s :",
        add_task_btn: "Ajouter T√¢che",
        gantt_chart_title: "Diagramme de Gantt",
        recalculate_btn: "üîÑ Recalculer",
        export_png_btn: "üñºÔ∏è PNG",
        undo_btn: "‚Ü© Annuler", // Nouvelle traduction
        hide_names_btn: "Masquer les noms",
        show_names_btn: "Afficher les noms",
        hide_sidebar_btn: "Masquer le menu",
        show_sidebar_btn: "Montrer le menu",
        edit_project_modal_title: "Modifier Projet",
        cancel_btn: "Annuler",
        save_btn: "Enregistrer",
        delete_btn: "Supprimer",
        manage_task_members_modal_title_prefix: "G√©rer les membres de la t√¢che",
        notification_export_success: "‚úÖ Donn√©es export√©es en JSON.",
        notification_import_success: "‚úÖ Donn√©es import√©es avec succ√®s.",
        notification_import_error: "‚ö†Ô∏è Erreur importation: ",
        notification_invalid_json_format: "Format JSON invalide ou donn√©es/compteurs manquants.",
        notification_member_added: "‚úÖ Membre {name} ajout√©.",
        notification_member_edited: "‚úÖ Membre {name} modifi√©.",
        notification_member_exists: "‚ö†Ô∏è Ce membre existe d√©j√†.",
        notification_enter_name: "‚ö†Ô∏è Entrez un nom.",
        notification_member_removed: "‚ùå Membre {name} supprim√©.",
        notification_visibility_updated: "‚úÖ Visibilit√© de {name} mise √† jour.",
        notification_no_members: "<small class=\"text-muted\">Aucun membre</small>",
        notification_project_name_required: "‚ö†Ô∏è Nom de projet requis.",
        notification_project_exists: "‚ö†Ô∏è Ce nom de projet existe d√©j√†.",
        notification_project_created: "üéâ Projet {name} cr√©√© avec t√¢ches par d√©faut.",
        notification_project_edited: "‚úÖ Projet {name} modifi√©.",
        notification_project_removed: "‚ùå Projet {name} supprim√©.",
        notification_fill_all_fields: "‚ö†Ô∏è Remplissez tous les champs (nom, d√©but, dur√©e > 0).",
        notification_invalid_project: "‚ö†Ô∏è Projet s√©lectionn√© invalide.",
        notification_task_added: "‚úÖ T√¢che {name} ajout√©e.",
        notification_task_members_updated: "‚úÖ Membres de la t√¢che {name} mis √† jour.",
        notification_task_updated: "‚úÖ T√¢che {name} mise √† jour.",
        notification_project_and_tasks_updated: "‚úÖ Projet {name} et ses t√¢ches mises √† jour.",
        notification_link_added: "üîó Lien ajout√©.",
        notification_link_removed: "‚ùå Lien supprim√©.",
        notification_task_deleted: "üóëÔ∏è T√¢che {name} supprim√©e.",
        notification_recalculated: "üîÑ Planning recalcul√© selon les d√©pendances",
        notification_recalculation_error: "‚ö†Ô∏è Erreur lors du recalcul",
        notification_png_exported: "üñºÔ∏è Diagramme export√© en PNG.",
        notification_no_tasks_to_export: "Aucune t√¢che √† exporter.",
        notification_invalid_date_format: "‚ö†Ô∏è Format de date invalide fourni.",
        notification_date_parse_error: "‚ö†Ô∏è Erreur lors de l'analyse de la date.",
        notification_task_reordered: "‚úÖ Ordre de la t√¢che {name} mis √† jour.",
        notification_drag_parent_restricted: "‚ö†Ô∏è Les t√¢ches ne peuvent √™tre d√©plac√©es qu'au sein des projets ou devenir des t√¢ches de niveau sup√©rieur.",
        gantt_col_task: "T√¢che",
        gantt_col_start_date: "D√©but",
        gantt_col_end_date: "Fin",
        gantt_col_duration: "Dur√©e (j)",
        gantt_col_progress: "Avancement",
        gantt_col_members: "Membres",
        gantt_col_no_members: "Aucun",
        custom_lightbox_title: "Modifier la T√¢che",
        custom_lightbox_task_name_label: "Nom de la t√¢che",
        custom_lightbox_task_priority_label: "Priorit√©",
        custom_lightbox_task_progress_label: "Avancement",
        custom_lightbox_task_start_label: "Date de d√©but",
        custom_lightbox_task_end_label: "Date de fin",
        custom_lightbox_task_duration_label: "Dur√©e (jours)",
        custom_lightbox_task_comments_label: "Commentaires",
        custom_lightbox_task_color_label: "Couleur de la t√¢che",
        task_comments_placeholder: "Ajouter un commentaire...",
        task_priority_project: "Par d√©faut (Projet)",
        default_task_cahier_des_charges: "R√©alisation du cahier des charges ({projectName})",
        default_task_conception_pedagogique: "Conception p√©dagogique ({projectName})",
        default_task_production_contenus: "Production de contenus ({projectName})",
        default_task_developpement_interactif: "D√©veloppement interactif ({projectName})",
        default_task_tests_validation: "Tests et validation ({projectName})",
        gantt_week_prefix: "Sem.",
        task_start_placeholder: "Date de d√©but",
        drag_confirm_title: "Confirmer l'action de glisser-d√©poser",
        drag_confirm_question: "Que souhaitez-vous faire avec la t√¢che s√©lectionn√©e ?",
        drag_confirm_make_child: "Faire une sous-t√¢che",
        drag_confirm_place_below: "Placer en dessous",
        task_type_label: "Type de t√¢che",
        task_type_normal: "T√¢che normale",
        task_type_mother: "T√¢che m√®re (Nouveau Groupe)",
        mother_task_note: "Les dates, la dur√©e, l'avancement, la priorit√© et les membres de la t√¢che m√®re sont calcul√©s automatiquement ou h√©rit√©s de ses sous-t√¢ches. Pour les projets de niveau sup√©rieur, les propri√©t√©s peuvent √™tre √©dit√©es via la section Projets.",
        mother_task_creation_note: "Une t√¢che m√®re sert √† regrouper d'autres t√¢ches. Si elle est de niveau sup√©rieur, elle fonctionne comme un projet. Ses d√©tails (date de d√©but, fin, dur√©e, avancement, membres) seront calcul√©s automatiquement ou h√©rit√©s de ses sous-t√¢ches une fois celles-ci ajout√©es. Pour modifier les propri√©t√©s sp√©cifiques d'un projet de niveau sup√©rieur (couleur, priorit√©, description), utilisez la section \"Projets\" apr√®s sa cr√©ation.",
        validation_mother_task_parent_required: "‚ö†Ô∏è Une t√¢che m√®re doit avoir un projet ou une autre t√¢che m√®re comme parent."
    },
    en: {
        export: "üíæ Export",
        import: "üìÇ Import",
        clear_all_data_btn: "üóëÔ∏è Clear All",
        clear_all_data_confirm: "Are you sure you want to clear ALL data (members, projects, tasks, links)? This action is irreversible.",
        notification_all_data_cleared: "‚úÖ All data has been cleared.",
        load_example_data_btn: "‚ûï Load Example Data",
        members_section_title: "üë• Members",
        member_name_placeholder: "Member name",
        add_member_btn: "Add Member",
        edit_member_btn: "Edit Member",
        projects_section_title: "üìÅ Projects",
        project_name_placeholder: "Project name",
        project_description_placeholder: "Description",
        priority_low: "üü¢ Low",
        priority_medium: "üü° Medium",
        priority_high: "üî¥ High",
        create_project_btn: "Create Project",
        new_task_section_title: "‚úÖ New Task",
        select_project_option: "Select a project",
        task_parent: "Task parent",
        no_parent: "No parent",
        task_name_placeholder: "Task name",
        task_end_placeholder: "End date",
        task_duration_placeholder: "Duration (workdays)",
        assigned_members_label: "Assigned members:",
        add_task_btn: "Add Task",
        gantt_chart_title: "Gantt Chart",
        recalculate_btn: "üîÑ Recalculate",
        export_png_btn: "üñºÔ∏è PNG",
        undo_btn: "‚Ü© Undo", // New translation
        hide_names_btn: "Hide Names",
        show_names_btn: "Show Names",
        hide_sidebar_btn: "Hide menu",
        show_sidebar_btn: "Show menu",
        edit_project_modal_title: "Edit Project",
        cancel_btn: "Cancel",
        save_btn: "Save",
        delete_btn: "Delete",
        manage_task_members_modal_title_prefix: "Manage task members",
        notification_export_success: "‚úÖ Data exported to JSON.",
        notification_import_success: "‚úÖ Data imported successfully.",
        notification_import_error: "‚ö†Ô∏è Import error: ",
        notification_invalid_json_format: "Invalid JSON format or missing data/counters.",
        notification_member_added: "‚úÖ Member {name} added.",
        notification_member_edited: "‚úÖ Member {name} updated.",
        notification_member_exists: "‚ö†Ô∏è This member already exists.",
        notification_enter_name: "‚ö†Ô∏è Enter a name.",
        notification_member_removed: "‚ùå Member {name} removed.",
        notification_visibility_updated: "‚úÖ Visibility of {name} updated.",
        notification_no_members: "<small class=\"text-muted\">No members</small>",
        notification_project_name_required: "‚ö†Ô∏è Project name required.",
        notification_project_exists: "‚ö†Ô∏è This project name already exists.",
        notification_project_created: "üéâ Project {name} created with default tasks.",
        notification_project_edited: "‚úÖ Project {name} updated.",
        notification_project_removed: "‚ùå Project {name} removed.",
        notification_fill_all_fields: "‚ö†Ô∏è Fill all fields (name, start, duration > 0).",
        notification_invalid_project: "‚ö†Ô∏è Invalid project selected.",
        notification_task_added: "‚úÖ Task {name} added.",
        notification_task_members_updated: "‚úÖ Task {name} members updated.",
        notification_task_updated: "‚úÖ Task {name} updated.",
        notification_project_and_tasks_updated: "‚úÖ Project {name} and its tasks updated.",
        notification_link_added: "üîó Link added.",
        notification_link_removed: "‚ùå Link removed.",
        notification_task_deleted: "üóëÔ∏è Task {name} deleted.",
        notification_recalculated: "üîÑ Schedule recalculated based on dependencies",
        notification_recalculation_error: "‚ö†Ô∏è Error during recalculation",
        notification_png_exported: "üñºÔ∏è Chart exported to PNG.",
        notification_no_tasks_to_export: "No tasks to export.",
        notification_invalid_date_format: "‚ö†Ô∏è Invalid date format provided.",
        notification_date_parse_error: "‚ö†Ô∏è Error parsing date.",
        notification_task_reordered: "‚úÖ Task {name} order updated.",
        notification_drag_parent_restricted: "‚ö†Ô∏è Tasks can only be moved within projects or become top-level tasks.",
        gantt_col_task: "Task",
        gantt_col_start_date: "Start",
        gantt_col_end_date: "End",
        gantt_col_duration: "Duration (d)",
        gantt_col_progress: "Progress",
        gantt_col_members: "Members",
        gantt_col_no_members: "None",
        custom_lightbox_title: "Task Details",
        custom_lightbox_task_name_label: "Task name",
        custom_lightbox_task_priority_label: "Task priority",
        custom_lightbox_task_progress_label: "Progress",
        custom_lightbox_task_start_label: "Start date",
        custom_lightbox_task_end_label: "End date",
        custom_lightbox_task_duration_label: "Duration (days)",
        custom_lightbox_task_comments_label: "Comments",
        custom_lightbox_task_color_label: "Task Color",
        task_comments_placeholder: "Add a comment...",
        task_priority_project: "Default (Project)",
        default_task_cahier_des_charges: "Specifications ({projectName})",
        default_task_conception_pedagogique: "Instructional Design ({projectName})",
        default_task_production_contenus: "Content Production ({projectName})",
        default_task_developpement_interactif: "Interactive Development ({projectName})",
        default_task_tests_validation: "Testing and Validation ({projectName})",
        gantt_week_prefix: "W",
        task_start_placeholder: "Start date",
        drag_confirm_title: "Confirm Drag & Drop Action",
        drag_confirm_question: "What would you like to do with the selected task?",
        drag_confirm_make_child: "Make child task",
        drag_confirm_place_below: "Place below",
        task_type_label: "Task type",
        task_type_normal: "Normal task",
        task_type_mother: "Mother Task (New Group)",
        mother_task_note: "Dates, duration, progress, priority, and members for mother tasks are calculated automatically or inherited from their sub-tasks. For top-level projects, properties can be edited via the Projects section.",
        mother_task_creation_note: "A mother task is used to group other tasks. If it is top-level, it functions as a project. Its details (start date, end, duration, progress, members) will be automatically calculated or inherited from its sub-tasks once added. To modify specific properties of a top-level project (color, priority, description), use the 'Projects' section after creation.",
        validation_mother_task_parent_required: "‚ö†Ô∏è A mother task must have a project or another mother task as a parent."
    },
    es: {
        export: "üíæ Exportar",
        import: "üìÇ Importar",
        clear_all_data_btn: "üóëÔ∏è Borrar todo",
        clear_all_data_confirm: "¬øEst√° seguro de que desea borrar TODOS los datos (miembros, proyectos, tareas, enlaces)? Esta acci√≥n es irreversible.",
        notification_all_data_cleared: "‚úÖ Todos los datos han sido borrados.",
        load_example_data_btn: "‚ûï Cargar datos de ejemplo",
        members_section_title: "üë• Miembros",
        member_name_placeholder: "Nombre del miembro",
        add_member_btn: "A√±adir Miembro",
        edit_member_btn: "Editar Miembro",
        projects_section_title: "üìÅ Proyectos",
        project_name_placeholder: "Nombre del proyecto",
        project_description_placeholder: "Descripci√≥n",
        priority_low: "üü¢ Baja",
        priority_medium: "üü° Media",
        priority_high: "üî¥ Alta",
        create_project_btn: "Crear Proyecto",
        new_task_section_title: "‚úÖ Nueva Tarea",
        select_project_option: "Seleccionar un proyecto",
        task_parent: "Padre de la tarea",
        no_parent: "Ninguno",
        task_name_placeholder: "Nombre de la tarea",
        task_end_placeholder: "Fecha de fin",
        task_duration_placeholder: "Duraci√≥n (d√≠as laborables)",
        assigned_members_label: "Miembros asignados:",
        add_task_btn: "A√±adir Tarea",
        gantt_chart_title: "Diagrama de Gantt",
        recalculate_btn: "üîÑ Recalcular",
        export_png_btn: "üñºÔ∏è PNG",
        undo_btn: "‚Ü© Deshacer", // New translation
        hide_names_btn: "Ocultar Nombres",
        show_names_btn: "Mostrar Nombres",
        hide_sidebar_btn: "Ocultar men√∫",
        show_sidebar_btn: "Mostrar men√∫",
        edit_project_modal_title: "Editar Proyecto",
        cancel_btn: "Cancelar",
        save_btn: "Guardar",
        delete_btn: "Eliminar",
        manage_task_members_modal_title_prefix: "Gestionar miembros de la tarea",
        notification_recalculated: "üîÑ Horario recalculado seg√∫n dependencias",
        notification_recalculation_error: "‚ö†Ô∏è Erreur durante el rec√°lculo",
        notification_no_tasks_to_export: "No hay tareas para exportar.",
        notification_task_reordered: "‚úÖ Orden de la tarea {name} actualizado.",
        notification_drag_parent_restricted: "‚ö†Ô∏è Las tareas solo pueden ser movidas dentro de proyectos o convertirse en tareas de nivel superior.",
        gantt_col_task: "Tarea",
        gantt_col_start_date: "Inicio",
        gantt_col_end_date: "Fin",
        gantt_col_duration: "Duraci√≥n (d)",
        gantt_col_progress: "Progreso",
        gantt_col_members: "Miembros",
        gantt_col_no_members: "Ninguno",
        custom_lightbox_title: "Detalles de la Tarea",
        custom_lightbox_task_name_label: "Nombre de la tarea",
        custom_lightbox_task_priority_label: "Prioridad",
        custom_lightbox_task_progress_label: "Progreso",
        custom_lightbox_task_start_label: "Fecha de inicio",
        custom_lightbox_task_end_label: "Fecha de fin",
        custom_lightbox_task_duration_label: "Duraci√≥n (d√≠as)",
        custom_lightbox_task_comments_label: "Comentarios",
        custom_lightbox_task_color_label: "Color de la tarea",
        task_comments_placeholder: "A√±adir un comentario...",
        task_priority_project: "Por defecto (Proyecto)",
        task_start_placeholder: "Fecha de inicio",
        drag_confirm_title: "Confirmar acci√≥n de arrastrar y soltar",
        drag_confirm_question: "¬øQu√© desea hacer con la tarea seleccionada?",
        drag_confirm_make_child: "Hacer tarea hija",
        drag_confirm_place_below: "Colocar debajo",
        task_type_label: "Tipo de tarea",
        task_type_normal: "Tarea normal",
        task_type_mother: "Tarea madre (Nuevo Grupo)",
        mother_task_note: "Las fechas, duraci√≥n, progreso, prioridad y miembros de las tareas madre se calculan autom√°ticamente o se heredan de sus subtareas. Para proyectos de nivel superior, las propiedades pueden ser editadas a trav√©s de la secci√≥n Proyectos.",
        mother_task_creation_note: "Una tarea madre sirve para agrupar otras tareas. Si es de nivel superior, funciona como un proyecto. Sus detalles (fecha de inicio, fin, duraci√≥n, progreso, miembros) se calcular√°n autom√°ticamente o se heredar√°n de sus subtareas una vez a√±adidas. Para modificar las propiedades espec√≠ficas de un proyecto de nivel superior (color, prioridad, descripci√≥n), use la secci√≥n 'Proyectos' despu√©s de la creaci√≥n.",
        validation_mother_task_parent_required: "‚ö†Ô∏è Una tarea madre debe tener un proyecto o otra tarea madre como padre."
    },
    de: {
        export: "üíæ Exportieren",
        import: "üìÇ Importieren",
        clear_all_data_btn: "üóëÔ∏è Alles l√∂schen",
        clear_all_data_confirm: "Sind Sie sicher, dass Sie ALLE Daten (Mitglieder, Projekte, Aufgaben, Links) l√∂schen m√∂chten? Diese Aktion ist irreversibel.",
        notification_all_data_cleared: "‚úÖ Alle Daten wurden gel√∂scht.",
        load_example_data_btn: "‚ûï Beispieldaten laden",
        members_section_title: "üë• Mitglieder",
        member_name_placeholder: "Mitgliedsname",
        add_member_btn: "Mitglied hinzuf√ºgen",
        edit_member_btn: "Mitglied bearbeiten",
        projects_section_title: "üìÅ Projekte",
        project_name_placeholder: "Projektname",
        project_description_placeholder: "Beschreibung",
        priority_low: "üü¢ Niedrig",
        priority_medium: "üü° Mittel",
        priority_high: "üî¥ Hoch",
        create_project_btn: "Projekt erstellen",
        new_task_section_title: "‚úÖ Neue Aufgabe",
        select_project_option: "Projekt ausw√§hlen",
        task_parent: "Aufgabe √ºbergeordnet",
        no_parent: "Keine √ºbergeordnet",
        task_name_placeholder: "Aufgabenname",
        task_end_placeholder: "Enddatum",
        task_duration_placeholder: "Dauer (Arbeitstage)",
        assigned_members_label: "Zugeordnete Mitglieder:",
        add_task_btn: "Aufgabe hinzuf√ºgen",
        gantt_chart_title: "Gantt-Diagramm",
        recalculate_btn: "üîÑ Neu berechnen",
        export_png_btn: "üñºÔ∏è PNG",
        undo_btn: "‚Ü© R√ºckg√§ngig", // New translation
        hide_names_btn: "Namen ausblenden",
        show_names_btn: "Namen anzeigen",
        hide_sidebar_btn: "Men√º ausblenden",
        show_sidebar_btn: "Men√º anzeigen",
        edit_project_modal_title: "Projekt bearbeiten",
        cancel_btn: "Abbrechen",
        save_btn: "Speichern",
        delete_btn: "L√∂schen",
        manage_task_members_modal_title_prefix: "Aufgabenmitglieder verwalten",
        notification_recalculated: "üîÑ Zeitplan basierend auf Abh√§ngigkeiten neu berechnet",
        notification_recalculation_error: "‚ö†Ô∏è Fehler bei der Neuberechnung",
        notification_no_tasks_to_export: "Keine Aufgaben zum Exportieren.",
        notification_task_reordered: "‚úÖ Aufgabenreihenfolge {name} aktualisiert.",
        notification_drag_parent_restricted: "‚ö†Ô∏è Aufgaben k√∂nnen nur innerhalb von Projekten verschoben werden oder zu Aufgaben der obersten Ebene werden.",
        gantt_col_task: "Aufgabe",
        gantt_col_start_date: "Start",
        gantt_col_end_date: "Ende",
        gantt_col_duration: "Dauer (T)",
        gantt_col_progress: "Fortschritt",
        gantt_col_members: "Mitglieder",
        gantt_col_no_members: "Keine",
        custom_lightbox_title: "Aufgabendetails",
        custom_lightbox_task_name_label: "Aufgabenname",
        custom_lightbox_task_priority_label: "Priorit√§t",
        custom_lightbox_task_progress_label: "Fortschritt",
        custom_lightbox_task_start_label: "Startdatum",
        custom_lightbox_task_end_label: "Enddatum",
        custom_lightbox_task_duration_label: "Dauer (Tage)",
        custom_lightbox_task_comments_label: "Kommentare",
        custom_lightbox_task_color_label: "Aufgabenfarbe",
        task_comments_placeholder: "Kommentar hinzuf√ºgen...",
        task_priority_project: "Standard (Projekt)",
        task_start_placeholder: "Datum ausw√§hlen",
        drag_confirm_title: "Drag & Drop Aktion best√§tigen",
        drag_confirm_question: "Was m√∂chten Sie mit der ausgew√§hlten Aufgabe tun?",
        drag_confirm_make_child: "Als Kindaufgabe festlegen",
        drag_confirm_place_below: "Darunter platzieren",
        task_type_label: "Aufgabentyp",
        task_type_normal: "Normale Aufgabe",
        task_type_mother: "Mutter Aufgabe (Neue Gruppe)",
        mother_task_note: "Daten, Dauer, Fortschritt, Priorit√§t und Mitglieder f√ºr Mutteraufgaben werden automatisch berechnet oder von ihren Unteraufgaben geerbt. F√ºr Projekte der obersten Ebene k√∂nnen Eigenschaften √ºber den Abschnitt 'Projekte' bearbeitet werden.",
        mother_task_creation_note: "Eine Mutteraufgabe dient dazu, andere Aufgaben zu gruppieren. Wenn sie auf oberster Ebene ist, fungiert sie als Projekt. Ihre Details (Startdatum, Ende, Dauer, Fortschritt, Mitglieder) werden automatisch berechnet oder von ihren Unteraufgaben geerbt, sobald sie hinzugef√ºgt wurden. Um spezifische Projekteigenschaften (Farbe, Priorit√§t, Beschreibung) zu √§ndern, verwenden Sie den Bereich 'Projekte' nach der Erstellung.",
        validation_mother_task_parent_required: "‚ö†Ô∏è Eine Mutteraufgabe muss ein Projekt ou eine andere Mutteraufgabe als √ºbergeordnetes Element haben."
    },
    it: {
        export: "üíæ Esporta",
        import: "üìÇ Importa",
        clear_all_data_btn: "üóëÔ∏è Cancella tutto",
        clear_all_data_confirm: "Sei sicuro di voler cancellare TUTTI i dati (membri, progetti, attivit√†, collegamenti)? Questa azione √® irreversibile.",
        notification_all_data_cleared: "‚úÖ Tutti i dati sono stati cancellati.",
        load_example_data_btn: "‚ûï Carica dati di esempio",
        members_section_title: "üë• Membri",
        member_name_placeholder: "Nome membro",
        add_member_btn: "Aggiungi Membro",
        edit_member_btn: "Modifica Membro",
        projects_section_title: "üìÅ Progetti",
        project_name_placeholder: "Nome progetto",
        project_description_placeholder: "Descrizione",
        priority_low: "üü¢ Bassa",
        priority_medium: "üü° Media",
        priority_high: "üî¥ Alta",
        create_project_btn: "Crea Progetto",
        new_task_section_title: "‚úÖ Nuova Attivit√†",
        select_project_option: "Seleziona un progetto",
        task_parent: "Genitore dell'attivit√†",
        no_parent: "Nessuno",
        task_name_placeholder: "Nome attivit√†",
        task_end_placeholder: "Data di fine",
        task_duration_placeholder: "Durata (giorni lavorativi)",
        assigned_members_label: "Membri assegnati:",
        add_task_btn: "Aggiungi Attivit√†",
        gantt_chart_title: "Diagramma de Gantt",
        recalculate_btn: "üîÑ Ricalcola",
        export_png_btn: "üñºÔ∏è PNG",
        undo_btn: "‚Ü© Annulla", // New translation
        hide_names_btn: "Nascondi Nomi",
        show_names_btn: "Mostra Nomi",
        hide_sidebar_btn: "Nascondi menu",
        show_sidebar_btn: "Mostra menu",
        edit_project_modal_title: "Modifica Progetto",
        cancel_btn: "Annulla",
        save_btn: "Salva",
        delete_btn: "Elimina",
        manage_task_members_modal_title_prefix: "Gestisci membri attivit√†",
        notification_recalculated: "üîÑ Pianificazione ricalcolata in base alle dipendenze",
        notification_recalculation_error: "‚ö†Ô∏è Errore durante il ricalcolo",
        notification_no_tasks_to_export: "Nessuna attivit√† da esportare.",
        notification_task_reordered: "‚úÖ Ordre de l'attivit√† {name} aggiornato.",
        notification_drag_parent_restricted: "‚ö†Ô∏è Le attivit√† possono √™tre spostate solo all'interno des progetti ou diventare des attivit√† de livello superiore.",
        gantt_col_task: "Attivit√†",
        gantt_col_start_date: "Inizio",
        gantt_col_end_date: "Fin",
        gantt_col_duration: "Durata (g)",
        gantt_col_progress: "Avanzamento",
        gantt_col_members: "Membri",
        gantt_col_no_members: "Nessuno",
        custom_lightbox_title: "Dettagli Attivit√†",
        custom_lightbox_task_name_label: "Nome attivit√†",
        custom_lightbox_task_priority_label: "Priorit√†",
        custom_lightbox_task_progress_label: "Avanzamento",
        custom_lightbox_task_start_label: "Data di inizio",
        custom_lightbox_task_end_label: "Data di fine",
        custom_lightbox_task_duration_label: "Durata (giorni)",
        custom_lightbox_task_comments_label: "Commentari",
        custom_lightbox_task_color_label: "Colore dell'attivit√†",
        task_comments_placeholder: "A√±adir un comentario...",
        task_priority_project: "Predefinito (Progetto)",
        task_start_placeholder: "Seleziona una data",
        drag_confirm_title: "Conferma azione trascina e rilascia",
        drag_confirm_question: "Cosa vuoi fare con l'attivit√† selezionata?",
        drag_confirm_make_child: "Rendi attivit√† figlia",
        drag_confirm_place_below: "Posiziona sotto",
        task_type_label: "Tipo de attivit√†",
        task_type_normal: "Attivit√† normale",
        task_type_mother: "Attivit√† madre (Nuovo Gruppo)",
        mother_task_note: "Le date, la durata, l'avanzamento, la priorit√† et les membres pour les attivit√† madre vengono calcolati automaticamente ou ereditati dalle loro sottoattivit√†. Per progetti di livello superiore, le propriet√† possono essere editati tramite la sezione Progetti.",
        mother_task_creation_note: "Un'attivit√† madre serve a raggruppare altre attivit√†. Se √® di livello superiore, funziona come un progetto. I dettagli (data di inizio, fine, durata, avanzamento, membri) verranno calcolati automaticamente ou ereditati dalle sue sottoattivit√† una volta aggiunte. Per modificare le propriet√† specifiche di un progetto di livello superiore (colore, priorit√†, descrizione), utilizzare la sezione 'Progetti' dopo la creazione.",
        validation_mother_task_parent_required: "‚ö†Ô∏è Un'attivit√† madre deve avere un progetto ou un'altra attivit√† madre come genitore."
    }
};

    function translate(key, params = {}) {
        let translation = translations[currentLang]?.[key] || translations.fr[key] || key;
        for (const param in params) {
            translation = translation.replace(`{${param}}`, params[param]);
        }
        return translation;
    }

    function applyTranslations() {
        document.documentElement.lang = currentLang;
        if (gantt && gantt.i18n) {
           try {
             gantt.i18n.setLocale(currentLang);
           } catch (e) {
             console.warn("DHTMLX locale for " + currentLang + " not fully available, falling back. Erreur: " + e.message);
             if (currentLang !== 'en') {
                try { gantt.i18n.setLocale('en'); } catch (e2) { /* ignorer */ }
             }
           }
        }

        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            el.textContent = translate(key);
        });
        document.querySelectorAll('[data-translate-placeholder-key]').forEach(el => {
            el.placeholder = translate(el.dataset.translatePlaceholderKey);
        });

        const memberActionBtn = document.getElementById('memberActionBtn');
        if (memberActionBtn) {
            memberActionBtn.textContent = translate(document.getElementById('editMemberId').value ? 'edit_member_btn' : 'add_member_btn');
        }

        const taskProjectSelect = document.getElementById('taskProject');
        if (taskProjectSelect) {
            const firstOption = taskProjectSelect.querySelector('option[value=""]');
            if (firstOption) firstOption.textContent = translate('select_project_option');
        }
        document.querySelectorAll('#projectPriority option, #editProjectPriority option, #customLightboxTaskPriority option, #taskPriority option').forEach(option => {
            const key = option.value === "project" ? 'task_priority_project' : `priority_${option.value}`;
            option.textContent = translate(key);
        });

        document.querySelectorAll('.language-selector button').forEach(button => {
            button.classList.remove('btn-primary', 'text-white');
            button.classList.add('btn-light');
        });
        const activeButton = document.querySelector(`.language-selector button[onclick="setLanguage('${currentLang}')"]`);
        if (activeButton) {
            activeButton.classList.remove('btn-light');
            activeButton.classList.add('btn-primary', 'text-white');
        }

        const toggleGridBtn = document.getElementById('toggleGridBtn');
        const gridBtnKey = isGridVisible ? 'hide_names_btn' : 'show_names_btn';
        toggleGridBtn.setAttribute('data-translate-key', gridBtnKey);
        toggleGridBtn.textContent = translate(gridBtnKey);


        const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
        const sidebarBtnKey = isSidebarCollapsed ? 'show_sidebar_btn' : 'hide_sidebar_btn';
        toggleSidebarBtn.setAttribute('data-translate-key', sidebarBtnKey);
        toggleSidebarBtn.textContent = translate(sidebarBtnKey);


        if (gantt && gantt.config) {
            if (gantt.locale.labels) {
                gantt.locale.labels.label_save = translate('save_btn');
                gantt.locale.labels.label_cancel = translate('cancel_btn');
                gantt.locale.labels.label_delete = translate('delete_btn');
            }
            gantt.config.columns = getGanttColumns();
        }
        renderMembers();
        renderProjects();
        updateTaskMembers();
        toggleNewTaskFieldsVisibility();
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function setLanguage(lang) {
        currentLang = lang;
        setupDatePickers();
        applyTranslations();
        if(gantt && gantt.$container) { // V√©rifier si Gantt est initialis√© avant de tenter de le mettre √† jour
            updateGantt();
        }
    }

    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const btn = document.getElementById('toggleSidebarBtn');
        const transitionDuration = 350;

        if (!isSidebarCollapsed) {
            sidebar.classList.add('collapsed');
            btn.textContent = translate('show_sidebar_btn');
            setTimeout(() => {
                if(gantt) gantt.render();
            }, transitionDuration);
        } else {
            requestAnimationFrame(() => {
                sidebar.classList.remove('collapsed');
                btn.textContent = translate('hide_sidebar_btn');
                setTimeout(() => {
                    if(gantt) gantt.render();
                }, transitionDuration);
            });
        }
        isSidebarCollapsed = !isSidebarCollapsed;
    }

    function toggleGanttGrid() {
        isGridVisible = !isGridVisible;
        gantt.config.show_grid = isGridVisible;
        gantt.render();

        const btn = document.getElementById('toggleGridBtn');
        const key = isGridVisible ? 'hide_names_btn' : 'show_names_btn';
        btn.setAttribute('data-translate-key', key);
        btn.textContent = translate(key);
    }

    function adjustColor(color, percent) {
      let r = parseInt(color.substring(1, 3), 16);
      let g = parseInt(color.substring(3, 5), 16);
      let b = parseInt(color.substring(5, 7), 16);
      r = parseInt(r * (100 + percent) / 100); g = parseInt(g * (100 + percent) / 100); b = parseInt(b * (100 + percent) / 100);
      r = (r < 255) ? r : 255; g = (g < 255) ? g : 255; b = (b < 255) ? b : 255;
      r = (r > 0) ? r : 0; g = (g > 0) ? g : 0; b = (b > 0) ? b : 0;
      const rr = ((r.toString(16).length === 1) ? "0" + r.toString(16) : r.toString(16));
      const gg = ((g.toString(16).length === 1) ? "0" + g.toString(16) : g.toString(16));
      const bb = ((b.toString(16).length === 1) ? "0" + b.toString(16) : b.toString(16));
      return `#${rr}${gg}${bb}`;
    }

    function getContrastColor(hexColor) {
      if (!hexColor) return '#000000';
      hexColor = hexColor.replace('#', '');
      if (hexColor.length === 3) {
        hexColor = hexColor.split('').map(char => char + char).join('');
      }
      if (hexColor.length !== 6) return '#000000';
      const r = parseInt(hexColor.substring(0, 2), 16);
      const g = parseInt(hexColor.substring(2, 4), 16);
      const b = parseInt(hexColor.substring(4, 6), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    function showNotification(messageKey, type = 'success', params = {}) {
      const message = translate(messageKey, params);
      const div = document.createElement('div');
      div.className = `notification ${type}`;
      div.innerHTML = message;

      let container = document.querySelector('.notification-stack');
      if (!container) {
        container = document.createElement('div');
        container.className = 'notification-stack';
        document.body.appendChild(container);
      }

      container.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    }

    function getDateFormatForLocale(lang) {
        switch (lang) {
            case 'fr': case 'es': case 'it': return "d/m/Y";
            case 'de': return "d.m.Y";
            default: return "Y-m-d";
        }
    }

    function setupDatePickers() {
        if (datePickers.length > 0) {
            datePickers.forEach(picker => picker.destroy());
            datePickers = [];
        }

        const locale = (currentLang === 'en') ? 'default' : currentLang;
        const dateFormat = getDateFormatForLocale(currentLang);

        const pickerConfigs = [
            "#taskStart", "#taskEnd", "#customLightboxTaskStart", "#customLightboxTaskEnd",
            "#projectDeadline", "#editProjectDeadline"
        ];

        pickerConfigs.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                const config = {
                    dateFormat: dateFormat,
                    locale: locale,
                };
                if (selector === "#taskStart") {
                    config.onChange = function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            const endDatePicker = datePickers.find(p => p.element.id === 'taskEnd');
                            const durationInput = document.getElementById('taskDuration');
                            if (endDatePicker && endDatePicker.selectedDates.length > 0) {
                                const duration = gantt.calculateDuration({start_date: selectedDates[0], end_date: endDatePicker.selectedDates[0]});
                                durationInput.value = duration;
                            } else if (durationInput.value > 0) {
                                const endDate = gantt.calculateEndDate({start_date: selectedDates[0], duration: parseInt(durationInput.value)});
                                endDatePicker.setDate(endDate, false);
                            }
                        }
                    };
                } else if (selector === "#taskEnd") {
                    config.onChange = function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            const startDatePicker = datePickers.find(p => p.element.id === 'taskStart');
                            const durationInput = document.getElementById('taskDuration');
                            if (startDatePicker && startDatePicker.selectedDates.length > 0) {
                                const duration = gantt.calculateDuration({start_date: startDatePicker.selectedDates[0], end_date: selectedDates[0]});
                                durationInput.value = duration;
                            }
                        }
                    };
                } else if (selector === "#customLightboxTaskStart") {
                    config.onChange = updateLightboxEndDate;
                } else if (selector === "#customLightboxTaskEnd") {
                    config.onChange = updateLightboxDuration;
                }
                datePickers.push(flatpickr(element, config));
            }
        });

        const taskDurationInput = document.getElementById('taskDuration');
        if (taskDurationInput) {
            taskDurationInput.removeEventListener('input', updateTaskDurationFromInput);
            taskDurationInput.addEventListener('input', updateTaskDurationFromInput);
        }
    }

    function updateTaskDurationFromInput() {
        const taskStartPicker = datePickers.find(p => p.element.id === 'taskStart');
        const taskEndPicker = datePickers.find(p => p.element.id === 'taskEnd');
        const durationValue = parseInt(document.getElementById('taskDuration').value);

        if (taskStartPicker && taskStartPicker.selectedDates.length > 0 && !isNaN(durationValue) && durationValue >= 0) {
            const startDate = taskStartPicker.selectedDates[0];
            const endDate = gantt.calculateEndDate({start_date: startDate, duration: durationValue});
            if (taskEndPicker) taskEndPicker.setDate(endDate, false);
        }
    }

    function addOrUpdateMember() {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const editMemberId = document.getElementById('editMemberId').value;
      const name = document.getElementById('memberName').value.trim();
      const color = document.getElementById('memberColor').value;
      const actionBtn = document.getElementById('memberActionBtn');
      if (!name) { showNotification('notification_enter_name', 'error'); return; }
      if (members.some(m => m.name === name && String(m.id) !== String(editMemberId))) { showNotification('notification_member_exists', 'error'); return; }

      if (editMemberId) {
        const member = members.find(m => String(m.id) === String(editMemberId));
        if (member) { member.name = name; member.color = color; showNotification('notification_member_edited', 'success', {name}); }
        document.getElementById('editMemberId').value = '';
        actionBtn.textContent = translate('add_member_btn'); actionBtn.classList.replace('btn-warning', 'btn-primary');
      } else {
        members.push({ id: memberIdCounter++, name, color, visible: true });
        showNotification('notification_member_added', 'success', {name});
      }
      document.getElementById('memberName').value = ''; document.getElementById('memberColor').value = '#667eea';
      renderMembers(); updateTaskMembers(); updateGantt();
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function renderMembers() {
      const container = document.getElementById('membersList');
      if(!container) return;
      container.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
        <div class="task-item">
          <input type="checkbox" ${m.visible ? 'checked' : ''} onchange="toggleMemberVisibility(${m.id})">
          <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name}
          <button class="btn btn-sm btn-outline-primary me-2" onclick="editMember(${m.id})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeMember(${m.id})">üóëÔ∏è</button>
        </div>`).join('');
    }
	
	function getAllTasks() {
		let tasks = [];
		gantt.eachTask(function(task) {
			tasks.push(task);
		});
		return tasks;
	}

    function editMember(id) {
      const member = members.find(m => m.id == id);
      if (member) {
        document.getElementById('editMemberId').value = member.id;
        document.getElementById('memberName').value = member.name;
        document.getElementById('memberColor').value = member.color;
        const actionBtn = document.getElementById('memberActionBtn');
        actionBtn.textContent = translate('edit_member_btn'); actionBtn.classList.replace('btn-primary', 'btn-warning');
      }
    }

    function removeMember(id) {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const member = members.find(m => m.id == id);
      const memberName = member ? member.name : '';
      members = members.filter(m => m.id != id);
      // Mise √† jour de la r√©f√©rence des membres dans les t√¢ches des projets
      Object.values(projects).forEach(project => { // It√©rer sur les valeurs car projects est un objet d'IDs
        // Cette fonction r√©cursive met √† jour les memberIds dans l'arborescence des t√¢ches
        function updateMemberIdsInTask(taskItem) {
            if (taskItem.memberIds) {
                taskItem.memberIds = taskItem.memberIds.filter(mid => mid != id);
            }
            if (taskItem.tasks) { // Si c'est une t√¢che m√®re
                taskItem.tasks.forEach(subTask => updateMemberIdsInTask(subTask));
            }
        }
        updateMemberIdsInTask(project); // Appliquer au projet top-level
        project.tasks.forEach(task => updateMemberIdsInTask(task)); // Appliquer √† ses t√¢ches enfants
      });
      renderMembers(); updateTaskMembers(); updateGantt();
      showNotification('notification_member_removed', 'success', {name: memberName});
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function toggleMemberVisibility(memberId) {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const member = members.find(m => m.id == memberId);
      if (member) {
        member.visible = !member.visible;
        renderMembers();
        updateGantt();
        showNotification('notification_visibility_updated', 'success', {name: member.name});
      }
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function updateTaskMembers() {
      const container = document.getElementById('taskMembers');
      if (!container) return;
      container.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${m.id}" id="task-member-${m.id}" name="task-member-${m.id}">
          <label class="form-check-label" for="task-member-${m.id}"> <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name} </label>
        </div>`).join('');
    }

    function addProject() {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const name = document.getElementById('projectName').value.trim();
      if (!name) { showNotification('notification_project_name_required', 'error'); return; }
      // V√©rifier si un projet de NIVEAU SUP√âRIEUR avec ce nom existe d√©j√†
      if (Object.values(projects).some(p => p.name === name)) {
          showNotification('notification_project_exists', 'error');
          return;
      }
      
      const projectId = crypto.randomUUID(); // Utiliser crypto.randomUUID() pour un ID r√©ellement unique
      const startDate = new Date().toISOString().split('T')[0];

      const defaultTasksTemplates = [
        { key: 'default_task_cahier_des_charges', duration: 5, initialDelay: 0 },
        { key: 'default_task_conception_pedagogique', duration: 7, initialDelay: 5 },
        { key: 'default_task_production_contenus', duration: 10, initialDelay: 12 },
        { key: 'default_task_developpement_interactif', duration: 8, initialDelay: 22 },
        { key: 'default_task_tests_validation', duration: 5, initialDelay: 30 }
      ];

      let currentDate = new Date(startDate);
      if (isNaN(currentDate.getTime())) {
          currentDate = new Date();
      }

      const tasks = defaultTasksTemplates.map((taskTemplate) => {
        const taskName = translate(taskTemplate.key, { projectName: name });
        let actualStartDate = gantt.date.add(currentDate, taskTemplate.initialDelay, "day");
        if (gantt.config.skip_off_time) {
            while (!gantt.isWorkTime({date: actualStartDate, unit: "day"})) {
                actualStartDate.setDate(actualStartDate.getDate() + 1);
            }
        }
        
        const taskStart = gantt.date.date_to_str(gantt.config.date_format)(actualStartDate);
        let tempGanttTaskForCalc = {start_date: actualStartDate, duration: taskTemplate.duration};
        let taskEnd = gantt.date.date_to_str(gantt.config.date_format)(gantt.calculateEndDate(tempGanttTaskForCalc));

        const taskObj = {
          id: crypto.randomUUID(), name: taskName, text: taskName, start: taskStart, end: taskEnd, duration: taskTemplate.duration, // Explicitly set text
          progress: 0, project: name, parent: projectId, memberIds: members.length > 0 ? [members[Math.floor(Math.random() * members.length)].id] : [],
          priority: document.getElementById('projectPriority').value,
          comments: "",
          color: "#5cb85c",
          type: gantt.config.types.task,
        };
        return taskObj;
      });

      // For a new project, assign initial start/end dates for the summary task from its first/last child, or defaults
      let projectStartDate = tasks.length > 0 ? tasks[0].start : new Date().toISOString().split('T')[0];
      let projectEndDate = tasks.length > 0 ? tasks[tasks.length - 1].end : gantt.date.date_to_str(gantt.config.date_format)(gantt.calculateEndDate({start_date: new Date(), duration: 30}));
      let projectDuration = tasks.length > 0 ? gantt.calculateDuration({
          start_date: gantt.date.str_to_date(gantt.config.date_format)(projectStartDate),
          end_date: gantt.date.str_to_date(gantt.config.date_format)(projectEndDate)
      }) : 30;

      // Ajouter le projet √† l'objet projects avec l'ID comme cl√©
      projects[projectId] = {
        name, description: document.getElementById('projectDescription').value, deadline: document.getElementById('projectDeadline').value,
        priority: document.getElementById('projectPriority').value, color: document.getElementById('projectColor').value,
        tasks: tasks, id: projectId, visible: true,
        type: gantt.config.types.project, // C'est un vrai projet de niveau sup√©rieur
        parent: "0",
        start: projectStartDate,
        end: projectEndDate,
        duration: projectDuration,
        progress: 0 // Initial progress for new project summary
      };
      document.getElementById('projectName').value = ''; document.getElementById('projectDescription').value = '';
      document.getElementById('projectDeadline').value = ''; document.getElementById('projectPriority').value = 'low';
      document.getElementById('projectColor').value = '#28a745';
      renderProjects(); updateGantt();
      showNotification('notification_project_created', 'success', {name});
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function renderProjects() {
      const list = document.getElementById('projectList'); const select = document.getElementById('taskProject');
      if (!list || !select) return;

      // It√©rer sur les valeurs de l'objet projects (les objets projet eux-m√™mes)
      list.innerHTML = Object.values(projects).map(project => {
          let priorityEmoji = '';
          if (project.priority === "high") priorityEmoji = "üî¥ ";
          else if (project.priority === "medium") priorityEmoji = "üü° ";
          else if (project.priority === "low") priorityEmoji = "üü¢ ";
          return `
        <div class="task-item" style="border-left: 4px solid ${project.color};">
          <input type="checkbox" ${project.visible ? 'checked' : ''} onchange="toggleProjectVisibility('${project.id}')">
          <span class="member-indicator" style="background-color: ${project.color};"></span> ${priorityEmoji}${project.name} (${translate('priority_' + project.priority)})
          <button class="btn btn-sm btn-outline-primary me-2" onclick="editProject('${project.id}')">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeProject('${project.id}')">üóëÔ∏è</button>
        </div>`;
      }).join('');

      // populateProjectDropdown est appel√©e par le setup (toggleNewTaskFieldsVisibility)
      // et aussi dans le openCustomLightbox pour peupler les options du parent
    }

    function toggleProjectVisibility(projectId) { // Utiliser projectId
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        if (projects[projectId]) {
            projects[projectId].visible = !projects[projectId].visible;
            renderProjects();
            updateGantt();
        }
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function editProject(projectId) { // Utiliser projectId
      projectNameToEdit = projectId; // Stocker l'ID du projet √† √©diter
      const project = projects[projectId]; // Acc√©der au projet par son ID
      if (project) {
          document.getElementById('editProjectName').value = project.name;
          document.getElementById('editProjectDescription').value = project.description;
          const deadlinePicker = datePickers.find(p => p.element.id === 'editProjectDeadline');
          if(deadlinePicker) deadlinePicker.setDate(project.deadline, false);

          document.getElementById('editProjectPriority').value = project.priority;
          document.getElementById('editProjectColor').value = project.color;
          new bootstrap.Modal(document.getElementById('editProjectModal')).show();
      }
    }

    function saveProjectEdit() {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const newName = document.getElementById('editProjectName').value.trim();
      const currentProjectId = projectNameToEdit; // L'ID du projet qu'on est en train d'√©diter
      
      if (!newName) { showNotification('notification_project_name_required', 'error'); return; }

      // V√©rifier si un autre projet (diff√©rent de celui en cours d'√©dition) utilise d√©j√† ce nom
      if (Object.values(projects).some(p => p.name === newName && String(p.id) !== String(currentProjectId))) {
          showNotification('notification_project_exists', 'error');
          return;
      }

      const oldProject = projects[currentProjectId]; // Acc√©der √† l'ancien projet par son ID
      if (!oldProject) { // Si l'ancien projet n'existe pas, c'est une erreur logique √† ce stade
          console.error("Projet √† √©diter non trouv√© avec l'ID:", currentProjectId);
          return;
      }

      const deadlinePicker = datePickers.find(p => p.element.id === 'editProjectDeadline');
      const deadline = deadlinePicker.selectedDates.length > 0 ? gantt.date.date_to_str(gantt.config.date_format)(deadlinePicker.selectedDates[0]) : "";

      // Mettre √† jour les donn√©es du projet
      oldProject.name = newName;
      oldProject.description = document.getElementById('editProjectDescription').value;
      oldProject.deadline = deadline;
      oldProject.priority = document.getElementById('editProjectPriority').value;
      oldProject.color = document.getElementById('editProjectColor').value;

      // La r√©f√©rence `task.project` est maintenant moins importante car la hi√©rarchie est g√©r√©e par `parent` IDs.
      // Cependant, pour la compatibilit√© ou si utilis√© dans d'autres affichages, on peut la mettre √† jour.
      // Une approche plus robuste serait de ne pas stocker `task.project` mais de le d√©river du parent le plus haut niveau.
      // Pour l'instant, on laisse cette ligne, elle ne nuit pas.
      // Parcourir toutes les t√¢ches pour mettre √† jour la propri√©t√© `project` si leur parent de niveau 0 est ce projet
      const updateProjectNameRecursive = (tasksArray) => {
          tasksArray.forEach(taskItem => {
              // Si la t√¢che appartient √† ce projet de niveau sup√©rieur
              if (String(taskItem.parent) === String(currentProjectId) || (findTaskInProjectsModel(taskItem.parent) && findTaskInProjectsModel(taskItem.parent).project === oldProject.name)) {
                   taskItem.project = newName;
              }
              if (taskItem.tasks && taskItem.tasks.length > 0) {
                  updateProjectNameRecursive(taskItem.tasks);
              }
          });
      };
      updateProjectNameRecursive(oldProject.tasks);


      // Mettre √† jour la t√¢che r√©capitulative correspondante dans Gantt
      const ganttProjectTask = gantt.getTask(currentProjectId);
      if (ganttProjectTask) {
          ganttProjectTask.text = newName;
          ganttProjectTask.color = oldProject.color; // Mettre √† jour la couleur dans Gantt aussi
          gantt.updateTask(ganttProjectTask.id);
      }

      renderProjects();
      updateGantt();
      showNotification('notification_project_edited', 'success', {name: newName});
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
      if (modalInstance) modalInstance.hide();
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function removeProject(projectId) { // Utiliser projectId
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const projectToRemove = projects[projectId]; // Acc√©der au projet par son ID
      if (projectToRemove) {
        // Obtenir tous les IDs de t√¢ches (normales et m√®res imbriqu√©es) du projet et de ses sous-arborescences
        const allTaskIdsToRemove = [];
        const queue = [projectToRemove.id]; // Commencer par l'ID du projet lui-m√™me (qui est une t√¢che m√®re dans Gantt)

        while(queue.length > 0) {
            const currentId = queue.shift();
            allTaskIdsToRemove.push(currentId);
            const childrenInGantt = gantt.getChildren(currentId);
            childrenInGantt.forEach(childId => queue.push(childId));
        }
        
        // Filtrer les liens qui concernent les t√¢ches supprim√©es
        allLinks = allLinks.filter(link => 
            !allTaskIdsToRemove.includes(String(link.source)) && 
            !allTaskIdsToRemove.includes(String(link.target))
        );
        
        gantt.batchUpdate(() => {
            // Supprimer toutes les t√¢ches et sous-t√¢ches du Gantt
            allTaskIdsToRemove.forEach(taskId => {
                try {
                    gantt.deleteTask(taskId); // Cela devrait aussi supprimer les enfants de cette t√¢che m√®re dans Gantt
                } catch (e) {
                    console.error("Erreur lors de la suppression de la t√¢che Gantt :", taskId, e);
                }
            });
        });
      }
      
      delete projects[projectId]; // Supprimer le projet de l'objet global projects par son ID
      renderProjects();
      updateGantt();
      showNotification('notification_project_removed', 'success', {name: projectToRemove ? projectToRemove.name : ''});
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function toggleNewTaskFieldsVisibility() {
        const taskType = document.getElementById('taskType').value;
        const normalFields = document.getElementById('normalTaskFields');
        const summaryTaskNote = document.getElementById('summaryTaskNote');
        
        if (taskType === 'task') {
            normalFields.style.display = 'block';
            summaryTaskNote.style.display = 'none';
            // T√¢che normale : Parents possibles = Projets de niveau sup√©rieur ET t√¢ches m√®res imbriqu√©es
            populateProjectDropdown('taskProject', '', null, true, true); 

            document.getElementById('taskStart').setAttribute('required', 'required');
            document.getElementById('taskEnd').setAttribute('required', 'required');
            document.getElementById('taskDuration').setAttribute('required', 'required');
        } else { // 'project' (mother task)
            normalFields.style.display = 'none';
            summaryTaskNote.style.display = 'block';
            // T√¢che m√®re : Parents possibles = UNIQUEMENT les projets de niveau sup√©rieur. Pas d'option "Pas de parent".
            populateProjectDropdown('taskProject', '', null, false, false); 

            document.getElementById('taskStart').removeAttribute('required');
            document.getElementById('taskEnd').removeAttribute('required');
            document.getElementById('taskDuration').removeAttribute('required');

            // Set default value if "no parent" is removed and dropdown becomes empty.
            const taskProjectSelect = document.getElementById('taskProject');
            if (taskProjectSelect.options.length > 0 && taskProjectSelect.value === "") {
                if (taskProjectSelect.options.length > 0) {
                     taskProjectSelect.selectedIndex = 0; // Select the first available option
                }
            }
        }
    }

    function addTask() {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        const taskName = document.getElementById('taskName').value.trim();
        const taskType = document.getElementById('taskType').value;
        let parentIdFromSelect = document.getElementById('taskProject').value; // Get the raw value

        if (!taskName) {
            showNotification('notification_enter_name', 'error');
            return;
        }

        // --- NEW VALIDATION FOR MOTHER TASKS ---
        if (taskType === 'project') { // If creating a mother task
            if (!parentIdFromSelect || parentIdFromSelect === "0") { // If no parent selected or "0" (no parent)
                showNotification('validation_mother_task_parent_required', 'error');
                return;
            }
        } else { // Normal task
             // If parentIdFromSelect is empty, it becomes "0" (no parent)
            parentIdFromSelect = parentIdFromSelect || "0";
        }
        // --- END NEW VALIDATION ---
        
        let ganttTaskData = {
            id: crypto.randomUUID(), // UUID for all tasks and mother tasks
            text: taskName, // Name for Gantt display
            comments: "",
            color: "#5cb85c", // Default for normal task
            type: taskType, // Can be 'task' or 'project' (for mother tasks)
            parent: parentIdFromSelect 
        };

        if (taskType === 'task') {
            const progress = parseFloat(document.getElementById('taskProgress').value);
            const assignedMemberIds = Array.from(document.getElementById('taskMembers').querySelectorAll('input:checked')).map(input => parseInt(input.value));
            const taskPriority = document.getElementById('taskPriority').value;

            const taskStartPicker = datePickers.find(picker => picker.element.id === 'taskStart');
            const taskEndPicker = datePickers.find(picker => picker.element.id === 'taskEnd');
            const taskDurationInput = document.getElementById('taskDuration');

            const startDateObject = taskStartPicker.selectedDates.length > 0 ? taskStartPicker.selectedDates[0] : null;
            let endDateObject = taskEndPicker.selectedDates.length > 0 ? taskEndPicker.selectedDates[0] : null;
            let durationValue = parseInt(taskDurationInput.value);

            if (!startDateObject || (!endDateObject && (isNaN(durationValue) || durationValue <= 0)) || (endDateObject && isNaN(durationValue))) {
                showNotification('notification_fill_all_fields', 'error');
                return;
            }

            if (endDateObject && taskEndPicker.selectedDates.length > 0) {
                durationValue = gantt.calculateDuration({start_date: startDateObject, end_date: endDateObject});
            } else if (!isNaN(durationValue) && durationValue > 0) {
                endDateObject = gantt.calculateEndDate({start_date: startDateObject, duration: durationValue});
            } else {
                showNotification('notification_fill_all_fields', 'error');
                return;
            }

            if (endDateObject < startDateObject) {
                showNotification('notification_invalid_date_format', 'error');
                return;
            }

            ganttTaskData.start_date = startDateObject;
            ganttTaskData.end_date = endDateObject;
            ganttTaskData.duration = durationValue;
            ganttTaskData.progress = progress;
            ganttTaskData.memberIds = assignedMemberIds;
            ganttTaskData.priority = taskPriority;
            // The `project` property on tasks will be set during rebuildProjectsFromGanttData based on parent hierarchy
        } else { // taskType === 'project' (new mother task)
            // No name uniqueness check for mother tasks
            ganttTaskData.color = "#667eea"; // Default color for mother task
            ganttTaskData.priority = document.getElementById('projectPriority').value || 'low'; // Default for new group
            // Dates, duration, progress will be calculated/inherited from children by Gantt, or defaults for new summary
            ganttTaskData.start_date = null;
            ganttTaskData.end_date = null;
            ganttTaskData.duration = 0;
            ganttTaskData.progress = 0;
            ganttTaskData.open = true; // Open by default
        }

        // Add the task to Gantt
        gantt.addTask(ganttTaskData);

        // Clear form fields
        document.getElementById('taskProject').value = '';
        document.getElementById('taskName').value = '';
        document.getElementById('taskType').value = 'task';
        toggleNewTaskFieldsVisibility(); 
        
        datePickers.forEach(picker => picker.clear());
        document.getElementById('taskDuration').value = '';
        document.getElementById('taskProgress').value = '0';
        document.getElementById('taskPriority').value = 'project';
        document.getElementById('taskMembers').querySelectorAll('input:checked').forEach(input => input.checked = false);

        // Rebuild our internal data model and update Gantt's display
        rebuildProjectsFromGanttData(); 
        updateGantt(); 

        showNotification('notification_task_added', 'success', { name: taskName });
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function showTaskMembersLightbox(taskId) {
      const ganttTask = gantt.getTask(taskId);
      if (!ganttTask || ganttTask.type === gantt.config.types.project) {
        showNotification('Cannot manage members for mother tasks directly. Members are assigned to individual tasks.', 'error');
        return;
      }

      let taskData = findTaskInProjectsModel(taskId); // Find task data in our structured model
      if (!taskData) { return; } // If the task is not found in our data model, exit

      document.getElementById('editTaskId').value = taskId;
      const container = document.getElementById('editTaskMembersList');
      container.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${m.id}" id="edit-task-member-${m.id}" name="edit-task-member-${m.id}" ${(taskData.memberIds || []).includes(m.id) ? 'checked' : ''}>
          <label class="form-check-label" for="edit-task-member-${m.id}">
            <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name}
          </label>
        </div>`).join('');
      document.getElementById('editTaskMembersModalLabel').textContent = `${translate('manage_task_members_modal_title_prefix')}: ${(ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '')}`;
      new bootstrap.Modal(document.getElementById('editTaskMembersModal')).show();
    }

    function saveTaskMembers() {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      const taskId = document.getElementById('editTaskId').value;
      let taskData = findTaskInProjectsModel(taskId);
      if (!taskData) { return; }

      const assignedMemberIds = Array.from(document.getElementById('editTaskMembersList').querySelectorAll('input:checked')).map(input => parseInt(input.value));
      taskData.memberIds = assignedMemberIds;
      
      // After updating members, recalculate progress for all parent mother tasks up the hierarchy
      let currentParentId = taskData.parent;
      while (currentParentId !== "0" && gantt.getTask(currentParentId)) {
          recalculateProjectDatesAndProgress(currentParentId); // This function also updates the dataStore
          currentParentId = gantt.getTask(currentParentId).parent;
      }
      rebuildProjectsFromGanttData(); // Ensure internal model is consistent
      updateGantt();
      showNotification('notification_task_members_updated', 'success', {name: (taskData.name || '').replace(/^[?üü°üü¢]\s*/, '')});
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('editTaskMembersModal'));
      if (modalInstance) modalInstance.hide();
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function exportToJSON() {
      // Pas besoin de saveStateToHistory ici car ce n'est pas une modification
      const data = { members, projects, allLinks, memberIdCounter, taskIdCounter, linkIdCounter, currentLang };
      const jsonString = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'gantt_data.json'; a.click();
      URL.revokeObjectURL(url);
      showNotification('notification_export_success');
    }

    function importFromJSON(event) {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification (car l'import change tout)
      const file = event.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.members || !Array.isArray(data.members) || !data.projects || typeof data.projects !== 'object' ||
              !data.allLinks || !Array.
              isArray(data.allLinks) ||
              typeof data.memberIdCounter !== 'number' || typeof data.taskIdCounter !== 'number' || typeof data.linkIdCounter !== 'number') {
            throw new Error(translate('notification_invalid_json_format'));
          }
          members = data.members; 
          projects = data.projects; // Assume the imported projects are already in the correct UUID-keyed, hierarchical format
          allLinks = data.allLinks;
          
          // Update counters based on imported data to ensure no conflicts if old number-based IDs are present
          let maxTaskIdNum = 0;
          let maxLinkIdNum = 0;
          // Iterate through all Gantt tasks to find the max numerical ID
          // This ensures that if old format IDs were mixed with UUIDs, the counters are high enough.
          gantt.eachTask(task => {
              // Try to parse the ID if it looks like a number-based ID (e.g., "task_123" or "123")
              const idStr = String(task.id);
              let idNum = parseInt(idStr.replace('task_', '').replace('project_', ''), 10);
              if (!isNaN(idNum) && idNum > maxTaskIdNum) maxTaskIdNum = idNum;
          });
          gantt.getLinks().forEach(link => {
              const idNum = parseInt(String(link.id), 10);
              if (!isNaN(idNum) && idNum > maxLinkIdNum) maxLinkIdNum = idNum;
          });
          taskIdCounter = Math.max(data.taskIdCounter, maxTaskIdNum + 1);
          linkIdCounter = Math.max(data.linkIdCounter, maxLinkIdNum + 1);
          memberIdCounter = data.memberIdCounter;

          currentLang = data.currentLang || 'fr';

          setLanguage(currentLang);
          renderMembers();
          renderProjects();
          updateTaskMembers();
          updateGantt(); // Reload Gantt with the imported data
          showNotification('notification_import_success');
          document.getElementById('importJSON').value = '';
          updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
        } catch (error) {
          showNotification('notification_import_error', 'error', { message: error.message });
          console.error("Import error:", error);
        }
      };
      reader.readAsText(file);
    }

    /**
     * Toggles visibility and required attributes for task creation fields based on task type (normal vs mother).
     */
    function toggleCustomLightboxFieldsVisibility() {
        const taskType = document.getElementById('customLightboxTaskType').value;
        const normalFieldsContainer = document.getElementById('customLightboxNormalTaskFields');
        const summaryFieldsContainer = document.getElementById('customLightboxSummaryTaskFields'); // Renamed to mother-task-specific logic
        const parentSelectContainer = document.getElementById('customLightboxTaskParent').closest('.mb-3');
        
        const fieldsToToggleIds = [
            'customLightboxTaskStart',
            'customLightboxTaskEnd',
            'customLightboxTaskDuration',
            'customLightboxTaskProgress',
            'customLightboxTaskComments'
        ];
        const membersListContainer = document.getElementById('customLightboxTaskMembers');

        if (normalFieldsContainer && summaryFieldsContainer) {
            if (taskType === 'task') {
                normalFieldsContainer.style.display = 'block';
                summaryFieldsContainer.style.display = 'none';
                if (parentSelectContainer) parentSelectContainer.style.display = 'block';

                fieldsToToggleIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const parentDiv = element.closest('.mb-3');
                        if (parentDiv) {
                            parentDiv.style.display = 'block';
                        }
                        element.disabled = false;
                    }
                });

                if (membersListContainer) {
                    const membersParentDiv = membersListContainer.closest('.mb-3');
                    if (membersParentDiv) {
                        membersParentDiv.style.display = 'block';
                    }
                }
                document.getElementById('customLightboxTaskColor').closest('.mb-3').style.display = 'block';
                document.getElementById('customLightboxTaskColor').disabled = false;
                document.getElementById('customLightboxTaskPriority').closest('.mb-3').style.display = 'block';
                document.getElementById('customLightboxTaskPriority').disabled = false;

            } else { // taskType === 'project' (mother task)
                normalFieldsContainer.style.display = 'none';
                summaryFieldsContainer.style.display = 'block';
                if (parentSelectContainer) parentSelectContainer.style.display = 'block'; // Parent still visible for mother tasks

                fieldsToToggleIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        const parentDiv = element.closest('.mb-3');
                        if (parentDiv) {
                            parentDiv.style.display = 'none';
                        }
                        element.disabled = true;
                    }
                });
                // Color and priority are still relevant for mother tasks
                document.getElementById('customLightboxTaskColor').closest('.mb-3').style.display = 'block';
                document.getElementById('customLightboxTaskColor').disabled = false;
                document.getElementById('customLightboxTaskPriority').closest('.mb-3').style.display = 'block';
                document.getElementById('customLightboxTaskPriority').disabled = false;


                if (membersListContainer) {
                    const membersParentDiv = membersListContainer.closest('.mb-3');
                    if (membersParentDiv) {
                        membersParentDiv.style.display = 'none';
                    }
                }
            }
        }
    }

    function openCustomLightbox(id) {
        elementToFocusOnModalClose = document.activeElement;
        currentEditingTaskId = id;
        const ganttTask = gantt.getTask(id);
        if (!ganttTask) return;

        document.getElementById('customLightboxTaskId').value = id;
        document.getElementById('customLightboxTaskName').value = (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '');

        let taskDataStore = findTaskInProjectsModel(id);
        
        // If not found in our store (e.g., a root-level task not part of any defined project), create a representation
        if (!taskDataStore && String(ganttTask.parent) === "0" && ganttTask.type === gantt.config.types.task) {
             console.warn(`Root-level task ${id} not found in projects data store. Creating temporary data for lightbox.`);
             taskDataStore = {
                 id: id,
                 name: (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, ''),
                 start: ganttTask.start_date ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.start_date) : null,
                 end: ganttTask.end_date ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.end_date) : null,
                 duration: ganttTask.duration || 0,
                 progress: ganttTask.progress || 0,
                 project: "", // No project for root tasks
                 parent: "0",
                 memberIds: [], priority: 'project', comments: "", color: "#5cb85c",
                 type: gantt.config.types.task
             };
        } else if (!taskDataStore && ganttTask.type === gantt.config.types.project && String(ganttTask.parent) !== "0") {
             // If a nested mother task wasn't properly found (shouldn't happen with rebuild logic)
             console.warn(`Nested mother task ${id} not found in projects data store. Creating temporary data for lightbox.`);
             taskDataStore = {
                 id: id,
                 name: (ganttTask.text || '').replace(/^[ÔøΩüü°üü¢]\s*/, ''),
                 start: gantt.end_date ? gantt.date.date_to_str(gantt.config.date_format)(gantt.end_date) : null,
                 end: gantt.end_date ? gantt.date.date_to_str(gantt.config.date_format)(gantt.end_date) : null,
                 duration: gantt.duration || 0,
                 progress: gantt.progress || 0,
                 project: "", 
                 parent: ganttTask.parent,
                 memberIds: [], priority: 'low', comments: "", color: "#667eea", // Default for mother
                 type: gantt.config.types.project,
                 tasks: []
             };
        }

        // Default to 'task' if no type is explicitly inferred or set
        const inferredType = (taskDataStore && taskDataStore.type) ? taskDataStore.type : gantt.config.types.task;
        document.getElementById('customLightboxTaskType').value = inferredType;
        toggleCustomLightboxFieldsVisibility();

        // Populate parent dropdown: Allow selecting any 'project' type task (top-level or mother) as a parent
        // Ensure the current task itself cannot be selected as its own parent.
        // For lightbox, always allow all summary tasks as parents.
        populateProjectDropdown('customLightboxTaskParent', ganttTask.parent, id, true, true); 

        if (inferredType === gantt.config.types.task) {
            const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
            const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');
            if (ganttTask.start_date && startPicker) startPicker.setDate(ganttTask.start_date, false);
            if (ganttTask.end_date && endPicker) endPicker.setDate(ganttTask.end_date, false);

            document.getElementById('customLightboxTaskDuration').value = ganttTask.duration || 0;
            document.getElementById('customLightboxTaskProgress').value = Math.round((taskDataStore ? taskDataStore.progress : ganttTask.progress) * 100);
            
            const priorityToSet = (taskDataStore && typeof taskDataStore.priority !== 'undefined') ? taskDataStore.priority : 'project';
            document.getElementById('customLightboxTaskPriority').value = priorityToSet;
            document.getElementById('customLightboxTaskComments').value = (taskDataStore && taskDataStore.comments) || "";
            document.getElementById('customLightboxTaskColor').value = (taskDataStore && taskDataStore.color) || "#5cb85c";

            const membersContainer = document.getElementById('customLightboxTaskMembers');
            membersContainer.innerHTML = members.length === 0 ? translate('notification_no_members') : members.map(m => `
                <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${m.id}" id="custom-lightbox-member-${m.id}" name="custom-lightbox-member-${m.id}" ${(taskDataStore && taskDataStore.memberIds && taskDataStore.memberIds.includes(m.id)) ? 'checked' : ''}>
                <label class="form-check-label" for="custom-lightbox-member-${m.id}">
                    <span class="member-indicator" style="background-color: ${m.color};"></span> ${m.name}
                </label>
                </div>`).join('');
        } else { // It's a mother task (project type in Gantt)
             document.getElementById('customLightboxTaskColor').value = (taskDataStore && taskDataStore.color) || "#667eea";
             document.getElementById('customLightboxTaskPriority').value = (taskDataStore && taskDataStore.priority) || 'low';
        }
        
        document.getElementById('customTaskModalLabel').textContent = translate('custom_lightbox_title') + (ganttTask.text ? `: ${(ganttTask.text || '').replace(/^[üî¥ÔøΩüü¢]\s*/, '').trim().substring(0,30)}...` : '');

        if (!customTaskModalInstance) {
            customTaskModalInstance = new bootstrap.Modal(document.getElementById('customTaskModal'));
        }
        customTaskModalInstance.show();
        applyTranslations();
    }

    function closeCustomLightbox() {
        if (customTaskModalInstance) customTaskModalInstance.hide();
        if (elementToFocusOnModalClose) elementToFocusOnModalClose.focus();
        currentEditingTaskId = null;
        elementToFocusOnModalClose = null;
    }

    function saveCustomLightboxChanges() {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        if (!currentEditingTaskId) return;

        const taskName = document.getElementById('customLightboxTaskName').value.trim();
        const newGanttTaskType = document.getElementById('customLightboxTaskType').value;
        let newParentId = document.getElementById('customLightboxTaskParent').value || "0";
        
        if (!taskName) {
            showNotification('notification_enter_name', 'error');
            return;
        }

        // Validation pour les t√¢ches m√®res (emp√™cher parent vide si type 'project')
        if (newGanttTaskType === gantt.config.types.project && newParentId === "0") {
             showNotification('validation_mother_task_parent_required', 'error');
             return;
        }


        gantt.batchUpdate(() => {
            const ganttTask = gantt.getTask(currentEditingTaskId);
            if (!ganttTask) return;

            const oldGanttTaskType = ganttTask.type;
            const oldParentId = ganttTask.parent;

            ganttTask.text = taskName; // Update Gantt task text
            ganttTask.parent = newParentId; // Update Gantt task parent
            ganttTask.type = newGanttTaskType; // Update Gantt task type

            // Update other properties based on type
            if (newGanttTaskType === gantt.config.types.task) {
                const duration = parseInt(document.getElementById('customLightboxTaskDuration').value);
                const progress = parseFloat(document.getElementById('customLightboxTaskProgress').value) / 100; // Convert to 0-1
                const priority = document.getElementById('customLightboxTaskPriority').value;
                const comments = document.getElementById('customLightboxTaskComments').value;
                const taskColor = document.getElementById('customLightboxTaskColor').value;
                const assignedMemberIds = Array.from(document.getElementById('customLightboxTaskMembers').querySelectorAll('input:checked')).map(input => parseInt(input.value));

                const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
                const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');

                if (!startPicker || startPicker.selectedDates.length === 0 || !endPicker || endPicker.selectedDates.length === 0 || isNaN(duration) || duration < 0) {
                    showNotification('notification_fill_all_fields', 'error');
                    // Revert Gantt changes for this task or handle error gracefully
                    gantt.updateTask(currentEditingTaskId); // Revert to previous state if input is invalid
                    return;
                }
                const newStartDate = startPicker.selectedDates[0];
                const newEndDate = endPicker.selectedDates[0];

                ganttTask.start_date = newStartDate;
                ganttTask.end_date = newEndDate;
                ganttTask.duration = duration;
                ganttTask.progress = progress;
                ganttTask.color = taskColor;
                ganttTask.priority = priority; // Store priority on the Gantt task for template access
                ganttTask.comments = comments; // Store comments on the Gantt task for template access
                ganttTask.memberIds = assignedMemberIds; // Store memberIds on the Gantt task for template access

            } else { // newGanttTaskType === 'project' (mother task)
                ganttTask.color = document.getElementById('customLightboxTaskColor').value;
                ganttTask.priority = document.getElementById('customLightboxTaskPriority').value || 'low';
                // Dates, duration, progress are derived for mother tasks in Gantt, so set to null/0 explicitly
                ganttTask.start_date = null;
                ganttTask.end_date = null;
                ganttTask.duration = 0;
                ganttTask.progress = 0;
            }

            gantt.updateTask(currentEditingTaskId);

            // Rebuild our internal data model AFTER Gantt has been updated
            rebuildProjectsFromGanttData(); 
            // Recalculate parent progress if parent changed or type changed
            if (oldParentId !== "0") recalculateProjectDatesAndProgress(oldParentId);
            if (newParentId !== "0") recalculateProjectDatesAndProgress(newParentId);
            recalculateProjectDatesAndProgress(currentEditingTaskId); // Recalculate if it's a mother task
        });

        updateGantt(); // Ensure Gantt displays correctly after all changes
        showNotification('notification_task_updated', 'success', {name: taskName});
        closeCustomLightbox();
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function deleteTaskFromCustomLightbox() {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        if (!currentEditingTaskId) return;
        const taskToDelete = gantt.getTask(currentEditingTaskId);
        const taskName = taskToDelete ? taskToDelete.text : '';
        const parentOfTaskToDelete = taskToDelete ? taskToDelete.parent : "0";

        gantt.deleteTask(currentEditingTaskId);

        // Rebuild the data model after Gantt is updated
        rebuildProjectsFromGanttData(); 

        // Recalculate parent progress if the deleted task had a parent
        if (parentOfTaskToDelete !== "0") {
            recalculateProjectDatesAndProgress(parentOfTaskToDelete);
        }
        updateGantt();

        showNotification('notification_task_deleted', 'success', {name: (taskName || '').replace(/^[üî¥üü°üü¢]\s*/, '').trim()});
        closeCustomLightbox();
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function updateLightboxEndDate() {
        const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
        const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');
        const duration = parseInt(document.getElementById('customLightboxTaskDuration').value, 10);

        if (startPicker && startPicker.selectedDates.length > 0 && !isNaN(duration) && duration >= 0) {
            const startDate = startPicker.selectedDates[0];
            const endDate = gantt.calculateEndDate({start_date: startDate, duration: duration});
            if (endPicker) endPicker.setDate(endDate, false);
        }
    }

    function updateLightboxDuration() {
        const startPicker = datePickers.find(p => p.element.id === 'customLightboxTaskStart');
        const endPicker = datePickers.find(p => p.element.id === 'customLightboxTaskEnd');

        if (startPicker && startPicker.selectedDates.length > 0 && endPicker && endPicker.selectedDates.length > 0) {
            const startDate = startPicker.selectedDates[0];
            let endDate = endPicker.selectedDates[0];
            if (endDate < startDate) {
                endDate = new Date(startDate);
                endPicker.setDate(endDate, false);
            }
            const duration = gantt.calculateDuration({start_date: startDate, end_date: endDate});
            document.getElementById('customLightboxTaskDuration').value = duration;
        }
    }

    function getGanttColumns() {
        return [
            {
                name: "text",
                label: translate('gantt_col_task'),
                width: 440,
                tree: true,
                resize: true,
                template: function(task) {
                    const taskText = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, ''); 
                    if (task.type === gantt.config.types.project) {
                        // For project (mother) tasks, we show their calculated progress
                        const projectData = findTaskInProjectsModel(task.id); // Find in our model
                        if (projectData && typeof projectData.progress === 'number') {
                             return `${taskText} (${Math.round(projectData.progress * 100)}%)`;
                        }
                        return `${taskText} (${Math.round(task.progress * 100)}%)`;
                    }

                    let taskName = taskText;
                    let memberDots = "";
                    let progressDisplay = "";

                    let taskDataInStore = findTaskInProjectsModel(task.id);
                   
                    if (taskDataInStore) {
                        const memberIds = taskDataInStore.memberIds || [];
                        const visibleMembers = memberIds.map(id => members.find(m => m.id === id)).filter(member => member && member.visible);
                        if (visibleMembers.length > 0) {
                            memberDots = visibleMembers.map(member => `<span class="member-indicator" style="background-color:${member.color}; vertical-align: middle;" title="${(member.name || '')}"></span>`).join("");
                        }
                        progressDisplay = ` (${Math.round(taskDataInStore.progress * 100)}%)`;
                    } else {
                       progressDisplay = ` (${Math.round(task.progress * 100)}%)`;
                    }

                    return `${taskName} ${memberDots} ${progressDisplay}`;
                }
            }
        ];
    }

    function weekendCss(date) {
      return (date.getDay() === 0 || date.getDay() === 6) ? "weekend" : "";
    }

    function initGantt() {
      gantt.plugins({
          export_api: true,
          zoom: true,
          tooltip: true
      });

      gantt.config.work_time = true;
      gantt.config.skip_off_time = true;
      gantt.config.auto_scheduling = true;
      gantt.config.auto_scheduling_strict = true;
      gantt.config.auto_scheduling_initial = true;
      gantt.config.date_format = "%Y-%m-%d";
      gantt.config.grid_resize = true;
      gantt.config.drag_progress = true;
      gantt.config.tooltip_timeout = 30;
      gantt.config.show_grid = isGridVisible;
      gantt.config.order_branch = true;
      gantt.config.order_branch_free = true;
      gantt.config.auto_types = false;
      gantt.config.drag_project = false;

      gantt.setWorkTime({ day: 0, hours: false });
      gantt.setWorkTime({ day: 6, hours: false });

      gantt.templates.date_grid = function(date){
          let format;
          switch(currentLang) {
              case 'fr': case 'es': case 'it': format = "%d/%m/%Y"; break;
              case 'de': format = "%d.%m.%Y"; break;
              default: return "%Y-%m-%d"; // Should not happen with default 'en' or other unsupported locales
          }
          return gantt.date.date_to_str(format)(date);
      };

      gantt.config.columns = getGanttColumns();

      // Initialisation du zoom apr√®s l'initialisation de Gantt
      gantt.init("gantt_here");
      applyZoom(currentZoomLevelIndex); // Apply initial zoom level

      // New template for date scale display
      gantt.templates.date_scale = function(date, scale_unit) {
          if (scale_unit === "week") {
              return `${translate('gantt_week_prefix')} ${gantt.date.getISOWeek(date)}`;
          }
          if (scale_unit === "quarter") {
              return `T${Math.ceil((date.getMonth() + 1) / 3)} ${date.getFullYear()}`;
          }
          // For other units, use default formatting based on gantt.config.date_scale
          // This ensures that default scales like 'month' and 'year' are still formatted correctly
          return gantt.date.date_to_str(gantt.config.date_scale)(date);
      };

      gantt.templates.task_text = function(start, end, task){
          const taskText = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, ''); // Ensure task.text is a string
          if (task.type === gantt.config.types.project) {
              const projectData = findTaskInProjectsModel(task.id);
              if (projectData && typeof projectData.progress === 'number') {
                  return `${taskText} (${Math.round(projectData.progress * 100)}%)`;
              }
              return `${taskText} (${Math.round(task.progress * 100)}%)`;
          }

          let taskName = taskText;
          let memberDots = "";
          let progressDisplay = "";

          let taskDataInStore = findTaskInProjectsModel(task.id);
         
          if (taskDataInStore) {
              const memberIds = taskDataInStore.memberIds || [];
              const visibleMembers = memberIds.map(id => members.find(m => m.id === id)).filter(member => member && member.visible);
              if (visibleMembers.length > 0) {
                  memberDots = visibleMembers.map(member => `<span class="member-indicator" style="background-color:${member.color}; vertical-align: middle;" title="${(member.name || '')}"></span>`).join("");
              }
              progressDisplay = ` (${Math.round(taskDataInStore.progress * 100)}%)`;
          } else {
             progressDisplay = ` (${Math.round(task.progress * 100)}%)`;
          }

          return `${taskName} ${memberDots} ${progressDisplay}`;
      };

      gantt.templates.grid_row_class = function(start, end, task) {
          let rowClass = "";
          let taskDataInStore = findTaskInProjectsModel(task.id);

          if (taskDataInStore) {
              let effectivePriority = taskDataInStore.priority || 'low';
              if (effectivePriority === 'project' && String(task.parent) !== "0") {
                  // If task priority is 'project' (default), inherit from nearest mother/project parent
                  let currentParentId = String(task.parent);
                  while (currentParentId !== "0") {
                      const parentGanttTask = gantt.getTask(currentParentId);
                      if (parentGanttTask && parentGanttTask.type === gantt.config.types.project) {
                          const parentData = findTaskInProjectsModel(parentGanttTask.id);
                          if (parentData && parentData.priority) {
                              effectivePriority = parentData.priority;
                              break;
                          }
                      }
                      currentParentId = parentGanttTask ? parentGanttTask.parent : "0"; // Move up the hierarchy
                  }
              }
              rowClass += ` priority-${effectivePriority}`;
          } else if (task.type === gantt.config.types.project && String(task.parent) === "0") {
              // Fallback for top-level projects if not found in model (shouldn't happen with rebuild)
              const projectData = projects[String(task.id)];
              if (projectData) rowClass += ` priority-${projectData.priority}`;
          }
          return rowClass.trim();
      };

      gantt.templates.task_class = function(start, end, task){
        let task_class = "";
        let taskDataInStore = findTaskInProjectsModel(task.id);
        
        if(taskDataInStore && taskDataInStore.type === gantt.config.types.project){
            task_class += ` project-priority-${taskDataInStore.priority}`;
        }
        return task_class.trim();
      };

      gantt.templates.timeline_cell_class = function(item, date) {
        return weekendCss(date);
      };

      gantt.templates.tooltip_text = function(start, end, task){
        const taskText = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim(); 
        let html = `<b>${taskText}</b><br/>`;
        html += `<b>${translate('gantt_col_start_date')}:</b> ${gantt.templates.date_grid(start)}<br/>`;
        html += `<b>${translate('gantt_col_end_date')}:</b> ${gantt.templates.date_grid(gantt.calculateEndDate(task))}<br/>`;
        html += `<b>${translate('gantt_col_duration')}:</b> ${task.duration} ${translate('gantt_col_duration').includes('(j)') ? 'j' : 'd'}<br/>`;
        html += `<b>${translate('gantt_col_progress')}:</b> ${Math.round(task.progress * 100)}%<br/>`;

        let taskDataInStore = findTaskInProjectsModel(task.id);
        
        if (taskDataInStore && taskDataInStore.type !== gantt.config.types.project) { // Only show members/comments for normal tasks
            const memberIds = taskDataInStore.memberIds || [];
            if (memberIds.length > 0) {
                const memberNames = memberIds.map(id => {
                    const member = members.find(m => m.id === id);
                    return member ? (member.name || '') : '';
                }).filter(name => name).join(", ");
                if (memberNames) html += `<b>${translate('gantt_col_members')}:</b> ${memberNames}<br/>`;
            }
            if (taskDataInStore.comments) {
                html += `<b>${translate('custom_lightbox_task_comments_label')}:</b> ${taskDataInStore.comments.substring(0, 100)}...<br/>`;
            }
        }
        return html;
      };

      gantt.attachEvent("onBeforeTaskDisplay", function(id, task) {
        let baseColor = "#007bff";
        let taskDataInStore = findTaskInProjectsModel(id);

        if (taskDataInStore) {
            baseColor = taskDataInStore.color || "#007bff";
        } else {
            // Fallback for root-level tasks or others not found in the model
            baseColor = task.color || "#5cb85c"; // Use task's own color or default
        }
        
        if (typeof baseColor !== 'string' || !/^#[0-9a-fA-F]{6}$/.test(baseColor)) {
            baseColor = "#007bff";
        }

        task.color = baseColor;
        task.style = `border-color: ${adjustColor(baseColor, -10)};`;

        task.progressColor = task.progress >= 1 ? "#28A745" : adjustColor(baseColor, 20);
        
        task.textColor = getContrastColor(baseColor);
        
        return true;
      });

      gantt.attachEvent("onBeforeLightbox", function(id){
        openCustomLightbox(id);
        return false; // Emp√™cher la lightbox par d√©faut de Gantt
      });

      gantt.attachEvent("onAfterTaskUpdate", function(id, task) {
        if (isUpdatingGanttProgrammatically) {
            return;
        }

        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification (pour les updates directes via UI)

        gantt.batchUpdate(() => {
            const children = gantt.getChildren(id);
            const originalType = task.type;

            // Logique pour transformer une t√¢che normale en t√¢che m√®re si elle obtient des enfants
            if (children.length > 0 && originalType !== gantt.config.types.project) {
                task.type = gantt.config.types.project;
                gantt.updateTask(id);
            }
            // Logique pour transformer une t√¢che m√®re en t√¢che normale si elle perd tous ses enfants
            else if (children.length === 0 && originalType === gantt.config.types.project) {
                task.type = gantt.config.types.task;
                gantt.updateTask(id);
            }

            // G√©rer les parents orphelins si une t√¢che est d√©plac√©e hors d'un parent
            const oldParentId = tempOldParentId;
            if (oldParentId && String(oldParentId) !== "0" && String(oldParentId) !== String(task.parent)) {
                const oldParentTask = gantt.getTask(oldParentId);
                if (oldParentTask && gantt.getChildren(oldParentId).length === 0 && oldParentTask.type === gantt.config.types.project) {
                    oldParentTask.type = gantt.config.types.task;
                    gantt.updateTask(oldParentTask.id);
                }
            }
        });

        // Reconstruire le mod√®le de donn√©es interne et rafra√Æchir Gantt
        rebuildProjectsFromGanttData(); 
        updateGantt(); 
        tempOldParentId = null;
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
      });

      gantt.attachEvent("onAfterLinkAdd", function(id, link) {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        // Utiliser crypto.randomUUID() pour les IDs des liens aussi
        const newLink = { id: crypto.randomUUID(), source: String(link.source), target: String(link.target), type: String(link.type) };
        allLinks.push(newLink);
        gantt.changeLinkId(id, newLink.id); // Update the link ID in Gantt as well
        showNotification("notification_link_added");
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
        return true;
      });

      gantt.attachEvent("onAfterLinkDelete", function(id, link) {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        allLinks = allLinks.filter(l => String(l.id) !== String(id));
        showNotification("notification_link_removed");
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
        return true;
      });

      gantt.attachEvent("onAfterTaskDelete", function(id, task) {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        allLinks = allLinks.filter(link => String(link.source) !== String(id) && String(link.target) !== String(id));

        // Rebuild the data model after Gantt has updated its structure
        rebuildProjectsFromGanttData(); 

        // Recalculate parent progress if the deleted task had a parent
        if (String(task.parent) !== "0") {
            recalculateProjectDatesAndProgress(String(task.parent));
        }
        updateGantt();

        showNotification('notification_task_deleted', 'success', {name: (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').trim()});
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
        return true;
      });

      gantt.attachEvent("onBeforeRowDragIn", function(id, parent, tindex) {
          const draggedTask = gantt.getTask(id);
          const targetNode = gantt.getTask(parent);

          tempOldParentId = draggedTask.parent;

          // Permettre de glisser une t√¢che m√®re uniquement vers un parent qui est un projet ou une autre t√¢che m√®re
          if (draggedTask.type === gantt.config.types.project && parent !== "0" && (!targetNode || targetNode.type !== gantt.config.types.project)) {
              showNotification('‚ö†Ô∏è Une t√¢che m√®re ne peut √™tre d√©plac√©e que sous un projet ou une autre t√¢che m√®re, ou devenir une t√¢che de niveau sup√©rieur.', 'error');
              return false;
          }

          if (parent === "0" || (targetNode && targetNode.type === gantt.config.types.project)) {
              // Pas de saveStateToHistory ici, la sauvegarde se fera √† la fin du drag dans onRowDragEnd
              return true;
          }

          if (targetNode && targetNode.type !== gantt.config.types.project) {
              tempDraggedTaskId = id;
              tempTargetNodeId = parent;
              tempTargetIndex = tindex;

              const dragConfirmationModalInstance = new bootstrap.Modal(document.getElementById('dragConfirmationModal'));
              dragConfirmationModalInstance.show();
              return false;
          }

          showNotification('notification_drag_parent_restricted', 'error');
          return false;
      });

      gantt.attachEvent("onRowDragEnd", function(id, parent, tindex) {
        saveStateToHistory(); // Sauvegarder l'√©tat apr√®s que le glisser-d√©poser est termin√©
        const draggedTask = gantt.getTask(id);
        if (draggedTask) {
            showNotification('notification_task_reordered', 'success', { name: (draggedTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim() });
        }
        // Reconstruire le mod√®le de donn√©es interne et rafra√Æchir Gantt
        rebuildProjectsFromGanttData(); 
        updateGantt();
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
      });

      applyTranslations();
    }

    /**
     * Reconstitue les donn√©es de Gantt √† partir de l'objet 'projects' et les recharge.
     * Cette fonction est essentielle pour synchroniser les modifications apport√©es aux projets et t√¢ches
     * dans notre mod√®le de donn√©es 'projects' avec le diagramme de Gantt.
     */
	function updateGantt() {
		if (!gantt || !gantt.$container) {
			console.warn("Gantt n'est pas encore initialis√©, impossible de mettre √† jour.");
			return;
		}

		// 1. M√©moriser l'√©tat pli√©/d√©pli√© AVANT de vider le Gantt
		// C'est crucial car gantt.clearAll() effacera l'√©tat actuel.
		memorizeCollapseState(); 

		isUpdatingGanttProgrammatically = true; // Emp√™che les √©v√©nements Gantt de d√©clencher des mises √† jour r√©cursives

		gantt.clearAll(); // Effacer toutes les t√¢ches et liens existants dans Gantt

		const ganttDataTasks = [];
		const ganttDataLinks = [];

		// Fonction r√©cursive pour aplatir la structure hi√©rarchique en t√¢ches Gantt
		function flattenTasks(tasks, parentId) { // Renomm√© parentProjectId en parentId pour √™tre g√©n√©rique
			tasks.forEach(item => {
				const ganttTask = {
					id: item.id,
					text: item.name,
					start_date: item.start ? gantt.date.str_to_date(gantt.config.date_format)(item.start) : null,
					end_date: item.end ? gantt.date.str_to_date(gantt.config.date_format)(item.end) : null,
					duration: item.duration,
					progress: item.progress,
					parent: item.parent || parentId, // Utilise le parent de l'√©l√©ment ou le parent pass√©
					type: item.type,
					color: item.color,
					open: item.open || (item.type === gantt.config.types.project) // Projects are open by default
				};
				// Store extra properties needed for templates or editing
				ganttTask.memberIds = item.memberIds || [];
				ganttTask.priority = item.priority || (item.type === gantt.config.types.project ? 'low' : 'project'); // Default or inherited
				ganttTask.comments = item.comments || "";
				ganttTask.project = item.project || ""; // For task.project compatibility (might be redundant if 'parent' is used)

				ganttDataTasks.push(ganttTask);

				if (item.tasks && item.tasks.length > 0) {
					flattenTasks(item.tasks, item.id); // Recursively add children
				}
			});
		}

		// Commencer l'aplatissement avec les projets de niveau sup√©rieur
		Object.values(projects).forEach(project => {
			// Note: Le projet de niveau sup√©rieur lui-m√™me est une t√¢che de type 'project' dans Gantt.
			// On l'ajoute directement au tableau des t√¢ches Gantt.
            if (!project.visible) return; // Skip invisible projects
            
			ganttDataTasks.push({
				id: project.id,
				text: project.name,
				// V√©rifier si la date est un objet Date valide avant de la formater
				start_date: (project.start && (new Date(project.start) instanceof Date) && !isNaN(new Date(project.start))) ? gantt.date.str_to_date(gantt.config.date_format)(project.start) : null,
				end_date: (project.end && (new Date(project.end) instanceof Date) && !isNaN(new Date(project.end))) ? gantt.date.str_to_date(gantt.config.date_format)(project.end) : null,
				duration: project.duration,
				progress: project.progress,
				parent: project.parent, // Should be "0" for top-level projects
				type: project.type, // Should be gantt.config.types.project
				color: project.color,
				open: project.open || true,
				memberIds: project.memberIds || [], // Even projects can have members (e.g., project leads)
				priority: project.priority,
				comments: project.comments || "",
				project: project.name // For top-level project, its project name is itself
			});
			// Puis aplatir ses sous-t√¢ches et t√¢ches m√®res imbriqu√©es
			if (project.tasks && project.tasks.length > 0) {
				flattenTasks(project.tasks, project.id);
			}
		});

		// Ajouter les liens
		allLinks.forEach(link => {
			ganttDataLinks.push({
				id: link.id,
				source: link.source,
				target: link.target,
				type: link.type
			});
		});

		// Charger les donn√©es dans Gantt
		gantt.parse({
			data: ganttDataTasks,
			links: ganttDataLinks
		});

		// 2. Restaurer l'√©tat pli√©/d√©pli√© APR√àS le chargement des donn√©es
		// Les t√¢ches doivent exister dans le Gantt pour pouvoir les ouvrir/fermer.
		restoreCollapseState(); 

		// Recalculer les dates et l'avancement pour toutes les t√¢ches m√®res apr√®s le parsing
		// Cela est crucial pour s'assurer que les projets affichent correctement les dates agr√©g√©es de leurs enfants
		gantt.eachTask(function(task) {
			if (task.type === gantt.config.types.project) {
				recalculateProjectDatesAndProgress(task.id);
			}
		});
		
		gantt.render(); // Re-dessiner le diagramme de Gantt
		renderSidebars(); // Mettre √† jour les listes dans la sidebar
		isUpdatingGanttProgrammatically = false; // R√©activer les √©couteurs d'√©v√©nements
	}

    /**
     * Recalcule les dates de d√©but/fin et l'avancement pour une t√¢che m√®re (projet Gantt).
     * Les met √† jour √† la fois dans Gantt et dans notre mod√®le de donn√©es `projects`.
     * @param {string} taskId L'ID de la t√¢che m√®re √† recalculer.
     */
    function recalculateProjectDatesAndProgress(taskId) {
        const ganttTask = gantt.getTask(taskId);
        if (!ganttTask || ganttTask.type !== gantt.config.types.project) {
            return; // Only recalculate for mother tasks/projects
        }

        const taskDataStore = findTaskInProjectsModel(taskId); // Find in our model (can be top-level or nested)

        const childTasksInGantt = gantt.getChildren(taskId).map(id => gantt.getTask(id)).filter(Boolean); // Filter out null/undefined

        let minStartDate = null;
        let maxEndDate = null;
        let totalProgressSum = 0;
        let totalChildDuration = 0; // For weighted average progress

        childTasksInGantt.forEach(childGanttTask => {
            if (childGanttTask.start_date instanceof Date && !isNaN(childGanttTask.start_date.getTime())) {
                if (!minStartDate || childGanttTask.start_date < minStartDate) {
                    minStartDate = childGanttTask.start_date;
                }
                const childEndDate = gantt.calculateEndDate({ start_date: childGanttTask.start_date, duration: childGanttTask.duration });
                if (childEndDate instanceof Date && !isNaN(childEndDate.getTime())) {
                    if (!maxEndDate || childEndDate > maxEndDate) {
                        maxEndDate = childEndDate;
                    }
                }
                // For weighted progress, consider duration
                if (childGanttTask.duration > 0) {
                    totalProgressSum += (parseFloat(childGanttTask.progress) || 0) * childGanttTask.duration;
                    totalChildDuration += childGanttTask.duration;
                }
            }
        });

        let newStartDate = null;
        let newEndDate = null;
        let newDuration = 0;
        let newProgress = 0;

        if (minStartDate && maxEndDate) {
            newStartDate = minStartDate;
            newEndDate = maxEndDate;
            newDuration = gantt.calculateDuration({ start_date: minStartDate, end_date: maxEndDate });
        } else {
            // If no valid children, use existing task dates/duration or defaults
            // This case happens for newly created empty mother tasks
            if (ganttTask.start_date instanceof Date && !isNaN(ganttTask.start_date.getTime())) {
                newStartDate = ganttTask.start_date;
                newDuration = ganttTask.duration || 1; 
                newEndDate = gantt.calculateEndDate({ start_date: newStartDate, duration: newDuration });
            } else {
                newStartDate = new Date(); 
                newDuration = 1; 
                newEndDate = gantt.calculateEndDate({ start_date: newStartDate, duration: newDuration });
            }
        }

        newProgress = totalChildDuration > 0 ? (totalProgressSum / totalChildDuration) : 0;
        
        // Mettre √† jour l'objet t√¢che Gantt directement
        ganttTask.start_date = newStartDate;
        ganttTask.end_date = newEndDate;
        ganttTask.duration = newDuration;
        ganttTask.progress = newProgress;
        // ganttTask.type = gantt.config.types.project; // Should already be project type

        // Mettre √† jour l'objet du data store si trouv√©
        if (taskDataStore) {
            taskDataStore.start = newStartDate ? gantt.date.date_to_str(gantt.config.date_format)(newStartDate) : null;
            taskDataStore.end = newEndDate ? gantt.date.date_to_str(gantt.config.date_format)(newEndDate) : null;
            taskDataStore.duration = Number(newDuration);
            taskDataStore.progress = Number(newProgress);
        }
    }

    /**
     * Recherche une t√¢che ou une t√¢che m√®re (projet) dans notre mod√®le de donn√©es `projects`.
     * Effectue une recherche r√©cursive pour trouver l'√©l√©ment correspondant.
     * @param {string} taskId L'ID de la t√¢che √† trouver.
     * @returns {object|null} L'objet t√¢che trouv√© ou null.
     */
    function findTaskInProjectsModel(taskId) {
        const targetId = String(taskId);
        
        // Parcourir les projets de niveau sup√©rieur
        for (const projectId in projects) {
            if (String(projects[projectId].id) === targetId) {
                return projects[projectId]; // Found top-level project
            }

            // Parcourir r√©cursivement les t√¢ches de ce projet
            const searchNested = (tasks) => {
                for (let i = 0; i < tasks.length; i++) {
                    const task = tasks[i];
                    if (String(task.id) === targetId) {
                        return task; // Found nested task or mother task
                    }
                    if (task.type === gantt.config.types.project && task.tasks && task.tasks.length > 0) {
                        const foundInNested = searchNested(task.tasks);
                        if (foundInNested) return foundInNested;
                    }
                }
                return null;
            };

            const foundInProjectTasks = searchNested(projects[projectId].tasks || []);
            if (foundInProjectTasks) {
                return foundInProjectTasks;
            }
        }
        return null; // Task not found
    }


    function renderSidebars() {
      renderMembers();
      renderProjects();
      updateTaskMembers();
      // Appeler populateProjectDropdown pour les s√©lecteurs de t√¢ches
      toggleNewTaskFieldsVisibility(); // This function already calls populateProjectDropdown with correct parameters
    }

    /**
     * Peuple le menu d√©roulant des parents pour les t√¢ches/t√¢ches m√®res.
     * @param {string} selectElementId - L'ID de l'√©l√©ment select √† peupler.
     * @param {string} [selectedParentId=''] - L'ID du parent √† pr√©s√©lectionner.
     * @param {string} [currentEditingId=null] - L'ID de la t√¢che/t√¢che m√®re en cours d'√©dition pour l'exclure de la liste des parents (pour √©viter les boucles).
     * @param {boolean} [includeAllSummaryTasks=false] - Si true, inclut toutes les t√¢ches de type 'project' (y compris les imbriqu√©es) comme parents possibles. Sinon, uniquement les projets de niveau sup√©rieur.
     * @param {boolean} [allowNoParent=true] - Si true, inclut l'option "Pas de parent".
     */
    function populateProjectDropdown(selectElementId, selectedParentId = '', currentEditingId = null, includeAllSummaryTasks = false, allowNoParent = true) {
        const parentSelect = document.getElementById(selectElementId);
        if (!parentSelect) return;

        parentSelect.innerHTML = ''; // Clear existing options

        if (allowNoParent) {
            const noParentOption = document.createElement('option');
            noParentOption.value = "";
            noParentOption.textContent = translate('no_parent');
            parentSelect.appendChild(noParentOption);
        }

        if (includeAllSummaryTasks) {
            // Include all summary tasks (projects or nested mother tasks)
            gantt.eachTask((task) => {
                const isSelectableParent = task.type === gantt.config.types.project && String(task.id) !== String(currentEditingId);
                if (isSelectableParent) {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = (task.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim();
                    if (String(task.id) === String(selectedParentId)) {
                        option.selected = true;
                    }
                    parentSelect.appendChild(option);
                }
            });
        } else {
            // Only include top-level projects (those with parent "0")
            Object.values(projects).forEach(project => {
                if (String(project.id) !== String(currentEditingId) && String(project.parent) === "0") { // Ensure it's a top-level project
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = (project.name || '').replace(/^[üî¥üü°ÔøΩ]\s*/, '').replace(/\s+\(.*?\)$/, '').trim();
                    if (String(project.id) === String(selectedParentId)) {
                        option.selected = true;
                    }
                    parentSelect.appendChild(option);
                }
            });
        }
    }

    /**
     * Reconstruit l'objet `projects` √† partir de l'√©tat actuel de Gantt.
     * Cette fonction est cruciale pour maintenir la coh√©rence du mod√®le de donn√©es hi√©rarchique.
     */
    function rebuildProjectsFromGanttData() {
        if (!gantt || !gantt.eachTask) {
            return;
        }

        const newProjects = {}; // Le nouvel objet 'projects' index√© par ID de top-level project
        const ganttTasksById = new Map(); // Map pour trouver rapidement les t√¢ches Gantt par ID
        gantt.eachTask(task => {
            ganttTasksById.set(String(task.id), task);
        });

        // Sauvegarde des propri√©t√©s non-Gantt des anciennes t√¢ches/projets
        const oldPropertiesById = new Map();
        // Fonction r√©cursive pour collecter toutes les propri√©t√©s des anciennes donn√©es
        function collectOldProperties(items) {
            items.forEach(item => {
                oldPropertiesById.set(String(item.id), item);
                if (item.tasks && Array.isArray(item.tasks)) {
                    collectOldProperties(item.tasks);
                }
            });
        }
        Object.values(projects).forEach(proj => {
            oldPropertiesById.set(String(proj.id), proj); // Add top-level project itself
            collectOldProperties(proj.tasks || []);
        });


        // Fonction r√©cursive pour construire la hi√©rarchie des t√¢ches/t√¢ches m√®res
        // Prend en param√®tre l'ID du parent dans Gantt (peut √™tre "0" pour les racines, ou un ID de t√¢che m√®re)
        function buildHierarchyFromGantt(parentId) {
            const childrenInGantt = gantt.getChildren(parentId);
            const nestedItems = [];

            childrenInGantt.forEach(childId => {
                const ganttTask = ganttTasksById.get(String(childId));
                if (!ganttTask) return;

                const oldProps = oldPropertiesById.get(String(ganttTask.id)) || {};

                // V√©rifications de validit√© des dates avant de les formater
                const startDate = (ganttTask.start_date instanceof Date && !isNaN(ganttTask.start_date.getTime())) 
                                  ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.start_date) : null;
                const endDate = (ganttTask.end_date instanceof Date && !isNaN(ganttTask.end_date.getTime()))
                                ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.end_date) : null;

                const itemData = {
                    id: String(ganttTask.id),
                    name: (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim(),
                    start: startDate, // Utiliser la date format√©e ou null
                    end: endDate,     // Utiliser la date format√©e ou null
                    duration: ganttTask.duration || 0,
                    progress: ganttTask.progress || 0,
                    parent: String(ganttTask.parent),
                    type: ganttTask.type,
                    color: ganttTask.color || oldProps.color || "#5cb85c",
                    memberIds: oldProps.memberIds || [],
                    priority: oldProps.priority || (ganttTask.type === gantt.config.types.project ? 'low' : 'project'),
                    comments: oldProps.comments || "",
                    // Add project name reference for nested tasks, derived from the top-level project they belong to
                    // This relies on the assumption that a task always belongs to *one* top-level project.
                    project: (ganttTask.parent === "0" && ganttTask.type === gantt.config.types.project) ? itemData.name : oldProps.project || "" 
                };

                if (ganttTask.type === gantt.config.types.project) {
                    // C'est une t√¢che m√®re, elle peut avoir des enfants
                    itemData.tasks = buildHierarchyFromGantt(ganttTask.id); // Appel r√©cursif
                    // Conserver les propri√©t√©s sp√©cifiques aux "vrais" projets si c'√©tait le cas
                    if (String(ganttTask.parent) === "0") {
                        itemData.description = oldProps.description || "";
                        itemData.deadline = oldProps.deadline || "";
                        itemData.visible = (typeof oldProps.visible !== 'undefined') ? oldProps.visible : true;
                    }
                }
                nestedItems.push(itemData);
            });
            return nestedItems;
        }

        // Parcourir toutes les t√¢ches de Gantt pour identifier les projets de NIVEAU SUP√âRIEUR
        gantt.eachTask(function(ganttTask) {
            // Un "vrai" projet de niveau sup√©rieur est de type 'project' ET son parent est "0"
            if (String(ganttTask.parent) === "0" && ganttTask.type === gantt.config.types.project) {
                const projectId = String(ganttTask.id);
                const oldProps = oldPropertiesById.get(projectId) || {};

                // V√©rifications de validit√© des dates avant de les formater
                const projectStartDate = (ganttTask.start_date instanceof Date && !isNaN(ganttTask.start_date.getTime()))
                                       ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.start_date) : null;
                const projectEndDate = (ganttTask.end_date instanceof Date && !isNaN(ganttTask.end_date.getTime()))
                                     ? gantt.date.date_to_str(gantt.config.date_format)(ganttTask.end_date) : null;

                // Cr√©er l'entr√©e pour le projet de niveau sup√©rieur
                newProjects[projectId] = {
                    id: projectId,
                    name: (ganttTask.text || '').replace(/^[üî¥üü°üü¢]\s*/, '').replace(/\s+\(.*?\)$/, '').trim(),
                    description: oldProps.description || "",
                    deadline: oldProps.deadline || "",
                    priority: oldProps.priority || "medium",
                    color: oldProps.color || "#8E44AD",
                    visible: (typeof oldProps.visible !== 'undefined') ? oldProps.visible : true,
                    start: projectStartDate, // Utiliser la date format√©e ou null
                    end: projectEndDate,     // Utiliser la date format√©e ou null
                    duration: ganttTask.duration || 0,
                    progress: ganttTask.progress || 0,
                    type: gantt.config.types.project,
                    parent: "0",
                    tasks: buildHierarchyFromGantt(ganttTask.id) // Construire la sous-hi√©rarchie
                };
            }
        });

        projects = newProjects; // Remplacer l'objet global projects par le nouvellement construit.

        // Mise √† jour des compteurs (pour compatibilit√©, les UUIDs sont prioritaires pour l'unicit√©)
        let maxTaskIdNum = 0;
        let maxLinkIdNum = 0;
        gantt.eachTask(task => {
            const idNum = parseInt(String(task.id).replace('task_', '').replace('project_', ''), 10);
            if (!isNaN(idNum) && idNum > maxTaskIdNum) maxTaskIdNum = idNum;
        });
        gantt.getLinks().forEach(link => {
            const idNum = parseInt(String(link.id), 10);
            if (!isNaN(idNum) && idNum > maxLinkIdNum) maxLinkIdNum = idNum;
        });
        taskIdCounter = maxTaskIdNum + 1;
        linkIdCounter = maxLinkIdNum + 1;
    }

    function calculateSummaryProgress(tasks) {
      if (!tasks || tasks.length === 0) return 0;
      const totalProgress = tasks.reduce((sum, task) => sum + (parseFloat(task.progress) || 0), 0);
      return totalProgress / tasks.length;
    }

    function manualRecalculate() {
      saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
      try {
        gantt.batchUpdate(() => {
          const visited = new Set();
          const originalDurations = {};
          gantt.eachTask(task => originalDurations[task.id] = task.duration);

          function shift(taskId) {
            if (visited.has(taskId)) return;
            visited.add(taskId); 

            const task = gantt.getTask(taskId); 
            const successors = gantt.getLinks().filter(l => String(l.source) === String(taskId) && l.type === gantt.config.links.finish_to_start);

            successors.forEach(link => {
              const nextTask = gantt.getTask(String(link.target)); 
              if (nextTask) { 
                nextTask.start_date = gantt.calculateEndDate(task);
                nextTask.duration = originalDurations[String(nextTask.id)] || nextTask.duration;
                nextTask.end_date = gantt.calculateEndDate(nextTask);
                
                gantt.updateTask(String(nextTask.id)); 
                shift(String(nextTask.id));
              }
            });
          }

          gantt.eachTask(task => {
              const predecessors = gantt.getLinks().filter(l => String(l.target) === String(task.id) && l.type === gantt.config.links.finish_to_start);
              if (predecessors.length === 0) {
                  shift(String(task.id));
              }
          });

          rebuildProjectsFromGanttData();
        });
        updateGantt();
        showNotification("notification_recalculated", 'success');
      } catch(e) {
        console.error("Erreur lors du recalcul manuel:", e);
        showNotification("notification_recalculation_error", 'error');
      }
      updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function exportGanttToPNG() {
        if (!gantt) return;

        let minDate = null;
        let maxDate = null;

        gantt.eachTask(function(task) {
            if (task.start_date instanceof Date && !isNaN(task.start_date.getTime())) {
                if (!minDate || task.start_date < minDate) {
                    minDate = new Date(task.start_date);
                }
            }
            if (task.end_date instanceof Date && !isNaN(task.end_date.getTime())) {
                if (!maxDate || task.end_date > maxDate) {
                    maxDate = new Date(task.end_date);
                }
            }
        });

        if (!minDate || !maxDate) {
            showNotification("notification_no_tasks_to_export", 'error');
            return;
        }

        const startDate = gantt.date.add(minDate, -1, "day");
        const endDate = gantt.date.add(maxDate, 1, "day");

        const styles = `
            <style>
                body {
                    font-family: 'Segoe UI', sans-serif;
                }
                .gantt_task_cell.weekend {
                    background-color: #f0f0f0 !important;
                }
                .member-indicator {
                    width: 14px;
                    height: 14px;
                    display: inline-block;
                    border-radius: 50%;
                    margin-right: 5px;
                    vertical-align: middle;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                }
                .gantt_grid_data .gantt_cell[data-column-name=members] {
                    text-align: center;
                }
                .gantt_task_line {
                    border-radius: 4px !important;
                }
                .gantt_task_progress {
                    border-radius: 4px !important;
                }
                .priority-low { background-color: #d4edda !important; }
                .priority-medium { background-color: #fff3cd !important; }
                .priority-high { background-color: #f8d7da !important; }
            </style>
        `;

        gantt.exportToPNG({
            name: "gantt_diagram.png",
            raw: true,
            header: styles,
            start_date: startDate,
            end_date: endDate
        });
        showNotification("notification_png_exported");
    }

    function confirmMakeChild() {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        if (!tempDraggedTaskId || !tempTargetNodeId) return;

        gantt.batchUpdate(() => {
            gantt.moveTask(tempDraggedTaskId, 0, tempTargetNodeId);
        });
        closeDragConfirmationModal();
        showNotification('notification_task_updated', 'success', { name: (gantt.getTask(tempDraggedTaskId).text || '').replace(/^[üî¥üü°üü¢]\s*/, '').trim() });
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function confirmPlaceBelow() {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        if (!tempDraggedTaskId || !tempTargetNodeId) return;

        gantt.batchUpdate(() => {
            const targetNode = gantt.getTask(tempTargetNodeId);
            const newParentId = targetNode.parent;
            let newIndex = 0;
            
            const siblingsOfTarget = gantt.getChildren(newParentId).map(id => gantt.getTask(id));
            const targetIndexInSiblings = siblingsOfTarget.findIndex(s => String(s.id) === String(tempTargetNodeId));

            if (targetIndexInSiblings !== -1) {
                newIndex = targetIndexInSiblings + 1;
            } else {
                newIndex = tempTargetIndex;
            }
            
            gantt.moveTask(tempDraggedTaskId, newIndex, newParentId);
        });
        closeDragConfirmationModal();
        showNotification('notification_task_updated', 'success', { name: (gantt.getTask(tempDraggedTaskId).text || '').replace(/^[üî¥üü°üü¢]\s*/, '').trim() });
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function closeDragConfirmationModal() {
        const dragConfirmationModalElement = document.getElementById('dragConfirmationModal');
        const dragConfirmationModalInstance = bootstrap.Modal.getInstance(dragConfirmationModalElement);
        if (dragConfirmationModalInstance) {
            dragConfirmationModalInstance.hide();
        }
        tempDraggedTaskId = null;
        tempTargetNodeId = null;
        tempTargetIndex = null;
        tempOldParentId = null;
    }

    function confirmClearAllData() {
        if (confirm(translate('clear_all_data_confirm'))) {
            clearAllData();
        }
    }

    function clearAllData() {
        saveStateToHistory(); // Sauvegarder l'√©tat avant la modification
        members = [];
        projects = {};
        allLinks = [];
        memberIdCounter = 1;
        taskIdCounter = 1;
        linkIdCounter = 1;

        gantt.clearAll();
        renderMembers();
        renderProjects();
        updateTaskMembers();
        toggleNewTaskFieldsVisibility(); // Re-populate parent dropdown for new tasks
        showNotification('notification_all_data_cleared', 'success');
        updateUndoButtonState(); // Mettre √† jour l'√©tat du bouton Annuler
    }

    function initDummyData() {
      members = [
        { id: 1, name: "Alice", color: "#FF5733", visible: true }, { id: 2, name: "Bob", color: "#33C4FF", visible: true },
        { id: 3, name: "Charlie", color: "#28A745", visible: true }
      ];
      memberIdCounter = 4;
      linkIdCounter = 1;
      taskIdCounter = 1; 
      projects = {}; // Reset projects

      const projectAlphaName = "Projet Alpha";
      const projectIdAlpha = crypto.randomUUID(); // Utilisation d'UUID
      
      const alphaModule1Id = crypto.randomUUID();
      const alphaModule2Id = crypto.randomUUID();

      // T√¢ches pour le Module 1
      const alphaModule1Tasks = [
        { nameKey: 'default_task_cahier_des_charges', duration: 5, progress: 0.9, memberIds: [1], priority: "high", comments: "Premier jet du CDC finalis√©." },
        { nameKey: 'default_task_conception_pedagogique', duration: 7, progress: 0.5, memberIds: [2], priority: undefined, comments: "" },
      ];

      // T√¢ches pour le Module 2
      const alphaModule2Tasks = [
        { nameKey: 'default_task_production_contenus', duration: 10, progress: 0.25, memberIds: [3], priority: "low", comments: "Besoin de valider les sources." },
        { nameKey: 'default_task_developpement_interactif', duration: 8, progress: 0.1, memberIds: [1, 2], priority: undefined, comments: "" },
      ];

      const populateTasksForParent = (taskTemplates, parentId, parentName, startingDate) => {
        const tasks = [];
        let currentDate = new Date(startingDate);
        taskTemplates.forEach((taskData, index) => {
          if (index > 0) {
            currentDate = gantt.date.add(currentDate, tasks[index-1].duration + 1, "day");
            if(gantt.config.skip_off_time) {
                while(!gantt.isWorkTime({date: currentDate, unit: "day"})) {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
          }
          const taskName = translate(taskData.nameKey, { projectName: parentName });
          const taskStart = gantt.date.date_to_str(gantt.config.date_format)(currentDate);
          const taskEnd = gantt.date.date_to_str(gantt.config.date_format)(gantt.calculateEndDate({start_date: currentDate, duration: taskData.duration}));

          tasks.push({
            id: crypto.randomUUID(), name: taskName, text: taskName, start: taskStart, end: taskEnd, duration: taskData.duration, // Explicitly set text
            progress: taskData.progress, project: parentName, parent: parentId, memberIds: taskData.memberIds,
            priority: taskData.priority, comments: taskData.comments || "", color: taskData.color || "#5cb85c",
            type: gantt.config.types.task,
          });
        });
        return tasks;
      };

      const baseStartDateAlpha = "2025-06-09";
      const module1PopulatedTasks = populateTasksForParent(alphaModule1Tasks, alphaModule1Id, "Module 1", baseStartDateAlpha);
      const module2PopulatedTasks = populateTasksForParent(alphaModule2Tasks, alphaModule2Id, "Module 2", gantt.date.date_to_str(gantt.config.date_format)(gantt.calculateEndDate({start_date: gantt.date.str_to_date(gantt.config.date_format)(module1PopulatedTasks[module1PopulatedTasks.length - 1].end), duration: 2}))); // Start module 2 a couple days after module 1

      const alphaProjectTasks = [
          {
            id: alphaModule1Id, name: "Module 1", text: "Module 1", parent: projectIdAlpha, type: gantt.config.types.project,
            color: "#FFD700", // Gold
            start: module1PopulatedTasks[0].start,
            end: module1PopulatedTasks[module1PopulatedTasks.length - 1].end,
            duration: gantt.calculateDuration({start_date: gantt.date.str_to_date(gantt.config.date_format)(module1PopulatedTasks[0].start), end_date: gantt.date.str_to_date(gantt.config.date_format)(module1PopulatedTasks[module1PopulatedTasks.length - 1].end)}),
            progress: 0,
            tasks: module1PopulatedTasks, // Nested tasks
            project: projectAlphaName // Link to top-level project name
          },
          {
            id: alphaModule2Id, name: "Module 2", text: "Module 2", parent: projectIdAlpha, type: gantt.config.types.project,
            color: "#ADFF2F", // GreenYellow
            start: module2PopulatedTasks[0].start,
            end: module2PopulatedTasks[module2PopulatedTasks.length - 1].end,
            duration: gantt.calculateDuration({start_date: gantt.date.str_to_date(gantt.config.date_format)(module2PopulatedTasks[0].start), end_date: gantt.date.str_to_date(gantt.config.date_format)(module2PopulatedTasks[module2PopulatedTasks.length - 1].end)}),
            progress: 0,
            tasks: module2PopulatedTasks, // Nested tasks
            project: projectAlphaName // Link to top-level project name
          }
      ];
      
      let projectAlphaStartDate = alphaProjectTasks.length > 0 ? alphaProjectTasks[0].start : null;
      let projectAlphaEndDate = alphaProjectTasks.length > 0 ? alphaProjectTasks[alphaProjectTasks.length - 1].end : null;
      let projectAlphaDuration = 0;
      if (projectAlphaStartDate && projectAlphaEndDate) {
        projectAlphaDuration = gantt.calculateDuration({
            start_date: gantt.date.str_to_date(gantt.config.date_format)(projectAlphaStartDate),
            end_date: gantt.date.str_to_date(gantt.config.date_format)(projectAlphaEndDate)
        });
      }

      projects[projectIdAlpha] = {
        id: projectIdAlpha, name: projectAlphaName, description: "Module e-learning sur la gestion de projet", deadline: "2025-07-30",
        priority: "medium", color: "#8E44AD", tasks: alphaProjectTasks, visible: true,
        type: gantt.config.types.project, parent: "0",
        start: projectAlphaStartDate, end: projectAlphaEndDate, duration: projectAlphaDuration, progress: 0
      };

      const projectBetaName = "Projet Beta";
      const projectIdBeta = crypto.randomUUID();

      const betaModule1Id = crypto.randomUUID(); // Another "Module 1" but with unique UUID
      const betaModuleTasks = [
        { nameKey: 'default_task_tests_validation', duration: 5, progress: 1, memberIds: [1], priority: undefined, comments: ""},
        { nameKey: 'default_task_developpement_interactif', duration: 7, progress: 0.75, memberIds: [1, 3], priority: "high", comments: ""},
      ];

      const baseStartDateBeta = "2025-07-01";
      const betaModule1PopulatedTasks = populateTasksForParent(betaModuleTasks, betaModule1Id, "Module 1", baseStartDateBeta);

      const betaProjectTasks = [
          {
            id: betaModule1Id, name: "Module 1", text: "Module 1", parent: projectIdBeta, type: gantt.config.types.project,
            color: "#6A5ACD", // SlateBlue
            start: betaModule1PopulatedTasks[0].start,
            end: betaModule1PopulatedTasks[betaModule1PopulatedTasks.length - 1].end,
            duration: gantt.calculateDuration({start_date: gantt.date.str_to_date(gantt.config.date_format)(betaModule1PopulatedTasks[0].start), end_date: gantt.date.str_to_date(gantt.config.date_format)(betaModule1PopulatedTasks[betaModule1PopulatedTasks.length - 1].end)}),
            progress: 0,
            tasks: betaModule1PopulatedTasks,
            project: projectBetaName
          }
      ];

      let projectBetaStartDate = betaProjectTasks.length > 0 ? betaProjectTasks[0].start : null;
      let projectBetaEndDate = betaProjectTasks.length > 0 ? betaProjectTasks[betaProjectTasks.length - 1].end : null;
      let projectBetaDuration = 0;
      if (projectBetaStartDate && projectBetaEndDate) {
          projectBetaDuration = gantt.calculateDuration({
              start_date: gantt.date.str_to_date(gantt.config.date_format)(projectBetaStartDate),
              end_date: gantt.date.str_to_date(gantt.config.date_format)(projectBetaEndDate)
          });
      }

      projects[projectIdBeta] = {
        id: projectIdBeta, name: projectBetaName, description: "Formation interactive sur le marketing digital", deadline: "2025-08-15",
        priority: "low", color: "#3498DB", tasks: betaProjectTasks, visible: true,
        type: gantt.config.types.project, parent: "0",
        start: projectBetaStartDate, end: projectBetaEndDate, duration: projectBetaDuration, progress: 0
      };

      allLinks = [];
      // Example links (using UUIDs now)
      if (module1PopulatedTasks.length >= 2) {
          allLinks.push({ id: crypto.randomUUID(), source: module1PopulatedTasks[0].id, target: module1PopulatedTasks[1].id, type: gantt.config.links.finish_to_start });
      }
      if (module2PopulatedTasks.length >= 2) {
          allLinks.push({ id: crypto.randomUUID(), source: module2PopulatedTasks[0].id, target: module2PopulatedTasks[1].id, type: gantt.config.links.finish_to_start });
      }
      // Link between modules or projects
      if (alphaProjectTasks.length > 0 && alphaProjectTasks[0].tasks.length > 0 && alphaProjectTasks[1].tasks.length > 0) {
          allLinks.push({ id: crypto.randomUUID(), source: alphaProjectTasks[0].tasks[alphaProjectTasks[0].tasks.length -1].id, target: alphaProjectTasks[1].tasks[0].id, type: gantt.config.links.finish_to_start });
      }
    }
  

	// Stockage de l'√©tat pli√©/d√©pli√© par ID de t√¢che
	let collapsedStateMap = {};

	// √âcoute des √©v√©nements de pliage/d√©pli√© de Gantt
	gantt.attachEvent("onTaskOpened", function (taskId) {
	  collapsedStateMap[taskId] = false;
	  return true;
	});

	gantt.attachEvent("onTaskClosed", function (taskId) {
	  collapsedStateMap[taskId] = true;
	  return true;
	});

	// M√©moriser l'√©tat actuel pli√©/d√©pli√©
	function memorizeCollapseState() {
	  collapsedStateMap = {};
	  gantt.eachTask(function (task) {
		if (task.type === "project" || task.type === "task") {
		  collapsedStateMap[task.id] = !task.$open; // ferm√© = true
		}
	  });
	}

	// Restaurer l'√©tat pli√©/d√©pli√© apr√®s rechargement
	function restoreCollapseState() {
	  for (const taskId in collapsedStateMap) {
		if (gantt.isTaskExists(taskId)) { // Check if task exists before trying to open/close
		  if (collapsedStateMap[taskId]) {
			gantt.close(taskId);
		  } else {
			gantt.open(taskId);
		  }
		}
	  }
	}

	// Appeler memorizeCollapseState avant drag
	gantt.attachEvent("onBeforeTaskDrag", function() {
	  memorizeCollapseState();
	  return true;
});


    // --- Fonctions d'historique (Annuler) ---

    /**
     * Sauvegarde l'√©tat actuel des donn√©es dans la pile d'historique.
     * Une copie profonde est n√©cessaire pour √©viter les r√©f√©rences.
     */
    function saveStateToHistory() {
        const currentState = {
            members: JSON.parse(JSON.stringify(members)),
            projects: JSON.parse(JSON.stringify(projects)),
            allLinks: JSON.parse(JSON.stringify(allLinks)),
            memberIdCounter: memberIdCounter,
            taskIdCounter: taskIdCounter,
            linkIdCounter: linkIdCounter,
            currentLang: currentLang
        };
        historyStack.push(currentState);
        if (historyStack.length > MAX_HISTORY_SIZE) {
            historyStack.shift(); // Supprime l'√©tat le plus ancien si la limite est d√©pass√©e
        }
        updateUndoButtonState();
    }

    /**
     * Restaure le dernier √©tat sauvegard√© depuis la pile d'historique.
     */
    function undoLastAction() {
        if (historyStack.length > 1) { // Toujours garder au moins l'√©tat initial
            historyStack.pop(); // Retire l'√©tat actuel (celui juste avant l'action que l'on veut annuler)
            const previousState = historyStack[historyStack.length - 1]; // R√©cup√®re le nouvel √©tat le plus r√©cent (l'√©tat pr√©c√©dent)

            // Restaure les variables globales √† partir de l'√©tat pr√©c√©dent
            members = JSON.parse(JSON.stringify(previousState.members));
            projects = JSON.parse(JSON.stringify(previousState.projects));
            allLinks = JSON.parse(JSON.stringify(previousState.allLinks));
            memberIdCounter = previousState.memberIdCounter;
            taskIdCounter = previousState.taskIdCounter;
            linkIdCounter = previousState.linkIdCounter;
            currentLang = previousState.currentLang;

            // Applique les modifications √† l'interface
            setLanguage(currentLang);
            renderMembers();
            renderProjects();
            updateTaskMembers();
            updateGantt(); // Recharge Gantt avec l'√©tat restaur√©
            showNotification('Action annul√©e.'); // Message de confirmation (peut √™tre traduit)
        } else {
            showNotification('Impossible d\'annuler davantage.', 'error');
        }
        updateUndoButtonState();
    }

    /**
     * Met √† jour l'√©tat activ√©/d√©sactiv√© du bouton Annuler.
     */
    function updateUndoButtonState() {
        const undoButton = document.getElementById('undoButton');
        if (undoButton) {
            // Le bouton est activ√© s'il y a plus d'un √©tat dans l'historique (l'√©tat initial + au moins un √©tat apr√®s modification)
            undoButton.disabled = historyStack.length <= 1; 
        }
    }

    // --- Fin des fonctions d'historique (Annuler) ---

</script>
</body>
</html>
